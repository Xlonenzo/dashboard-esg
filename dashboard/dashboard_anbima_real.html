<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar de T√≠tulos e Fundos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css">
    <script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary:#1976D2;--primary-light:#42A5F5;--secondary:#2E7D32;--secondary-light:#66BB6A;--accent:#FF9800;--accent-light:#FFB74D;--danger:#f44336;--success:#4CAF50;--warning:#FFC107;--info:#00BCD4;--purple:#9C27B0;--teal:#009688;--bg-dark:#0a0a1a;--bg-card:#12122a;--bg-card-hover:#1a1a3a;--text-primary:#ffffff;--text-secondary:#a0a0b0;--border-color:#2a2a4a;--sidebar-width:240px; }
        * { margin:0;padding:0;box-sizing:border-box; }
        body { font-family:'Inter',sans-serif;background:var(--bg-dark);color:var(--text-primary);min-height:100vh; }
        .sidebar { position:fixed;left:0;top:0;width:var(--sidebar-width);height:100vh;background:linear-gradient(180deg,#0d0d20 0%,#151530 100%);border-right:1px solid var(--border-color);padding:20px 0;overflow-y:auto;z-index:1000; }
        .logo { padding:10px 20px 20px;border-bottom:1px solid var(--border-color);margin-bottom:10px; }
        .logo h1 { font-size:1.2rem;background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent; }
        .logo span { font-size:0.7rem;color:var(--text-secondary);display:block;margin-top:5px; }
        .nav-section { padding:0 10px;margin-bottom:5px; }
        .nav-section-title { font-size:0.6rem;text-transform:uppercase;color:var(--text-secondary);letter-spacing:1px;padding:8px 10px 4px; }
        .nav-item { display:flex;align-items:center;padding:10px 12px;border-radius:8px;cursor:pointer;transition:all 0.3s;margin-bottom:2px;color:var(--text-secondary);font-size:0.8rem; }
        .nav-item:hover { background:rgba(255,255,255,0.05);color:var(--text-primary); }
        .nav-item.active { background:linear-gradient(135deg,rgba(25,118,210,0.3) 0%,rgba(46,125,50,0.3) 100%);color:var(--text-primary);border:1px solid rgba(25,118,210,0.4); }
        .nav-item .icon { font-size:0.9rem;margin-right:8px;width:18px;text-align:center; }
        .main-content { margin-left:var(--sidebar-width);padding:20px;min-height:100vh; }
        .page-header { background:linear-gradient(135deg,rgba(25,118,210,0.15) 0%,rgba(46,125,50,0.15) 100%);border-radius:12px;padding:20px;margin-bottom:20px;border:1px solid var(--border-color); }
        .page-header h2 { font-size:1.4rem;margin-bottom:5px; }
        .page-header .subtitle { color:var(--text-secondary);font-size:0.85rem; }
        .badge { display:inline-block;background:var(--success);color:white;padding:4px 12px;border-radius:15px;font-size:0.7rem;margin-top:8px; }
        .stats-grid { display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:20px; }
        .stat-card { background:var(--bg-card);border-radius:10px;padding:18px;border:1px solid var(--border-color); }
        .stat-card .label { color:var(--text-secondary);font-size:0.7rem;margin-bottom:6px;text-transform:uppercase; }
        .stat-card .value { font-size:1.8rem;font-weight:700; }
        .stat-card .change { font-size:0.7rem;margin-top:4px; }
        .stat-card .change.positive { color:var(--success); }
        .grid-2 { display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:20px; }
        @media (max-width:1200px) { .grid-2 { grid-template-columns:1fr; } }
        .chart-card { background:var(--bg-card);border-radius:10px;padding:20px;border:1px solid var(--border-color);margin-bottom:20px; }
        .chart-card h3 { font-size:1rem;margin-bottom:15px;display:flex;align-items:center;gap:8px; }
        .chart-container { position:relative;height:280px; }
        table { width:100%;border-collapse:collapse;font-size:0.8rem; }
        th,td { padding:10px 8px;text-align:left;border-bottom:1px solid var(--border-color); }
        th { background:rgba(255,255,255,0.03);font-weight:600;color:var(--text-secondary);font-size:0.7rem;text-transform:uppercase; }
        tr:hover { background:rgba(255,255,255,0.02); }
        .tab-content { display:none; }
        .tab-content.active { display:block; }
        .text-primary { color:var(--primary-light); }
        .text-secondary { color:var(--secondary-light); }
        .text-accent { color:var(--accent-light); }
        .text-info { color:var(--info); }
        /* Estilos para o Chat IA */
        .ai-suggestion-btn { padding:10px 16px;background:rgba(156,39,176,0.15);border:1px solid rgba(156,39,176,0.3);border-radius:8px;color:#CE93D8;cursor:pointer;font-size:0.85rem;transition:all 0.3s; }
        .ai-suggestion-btn:hover { background:rgba(156,39,176,0.25);border-color:rgba(156,39,176,0.5);transform:translateY(-2px); }
        .ai-message { display:flex;gap:12px;margin-bottom:15px;animation:fadeIn 0.3s ease; }
        .ai-message.ai-user { flex-direction:row-reverse; }
        .ai-avatar { width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0; }
        .ai-message.ai-assistant .ai-avatar { background:linear-gradient(135deg,#9C27B0,#1976D2); }
        .ai-message.ai-user .ai-avatar { background:linear-gradient(135deg,#2E7D32,#1976D2); }
        .ai-content { max-width:80%;padding:12px 16px;border-radius:12px;line-height:1.6;font-size:0.9rem; }
        .ai-message.ai-assistant .ai-content { background:rgba(156,39,176,0.1);border:1px solid rgba(156,39,176,0.2);border-top-left-radius:4px; }
        .ai-message.ai-user .ai-content { background:rgba(25,118,210,0.15);border:1px solid rgba(25,118,210,0.3);border-top-right-radius:4px; }
        .ai-content p { margin:0 0 8px 0; }
        .ai-content p:last-child { margin:0; }
        .ai-content ul, .ai-content ol { margin:8px 0;padding-left:20px; }
        .ai-content li { margin-bottom:4px; }
        .ai-content table { width:100%;margin:10px 0;border-collapse:collapse;font-size:0.85rem; }
        .ai-content th, .ai-content td { padding:8px;text-align:left;border:1px solid var(--border-color); }
        .ai-content th { background:rgba(255,255,255,0.05); }
        .ai-typing { display:flex;gap:4px;padding:8px 0; }
        .ai-typing span { width:8px;height:8px;background:#9C27B0;border-radius:50%;animation:typing 1.4s infinite ease-in-out; }
        .ai-typing span:nth-child(2) { animation-delay:0.2s; }
        .ai-typing span:nth-child(3) { animation-delay:0.4s; }
        @keyframes typing { 0%,80%,100%{transform:scale(0.6);opacity:0.5;} 40%{transform:scale(1);opacity:1;} }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
        @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
        /* Indicador de Tooltip com icone de info */
        .has-tooltip { position:relative;cursor:help; }
        .has-tooltip::after { content:'‚Ñπ';position:absolute;top:5px;right:5px;width:16px;height:16px;background:rgba(33,150,243,0.2);border:1px solid rgba(33,150,243,0.4);border-radius:50%;font-size:10px;color:#42A5F5;display:flex;align-items:center;justify-content:center;opacity:0.7;transition:all 0.3s; }
        .has-tooltip:hover::after { opacity:1;background:rgba(33,150,243,0.4); }
        .stat-card.has-tooltip::after { top:8px;right:8px; }
        .chart-card.has-tooltip::after { top:15px;right:15px; }
        th.has-tooltip { position:relative; }
        th.has-tooltip::after { position:static;display:inline-block;margin-left:5px;width:14px;height:14px;font-size:9px;vertical-align:middle; }
        /* Icone inline para labels e titulos */
        .info-icon { display:inline-flex;align-items:center;justify-content:center;width:14px;height:14px;background:rgba(33,150,243,0.2);border:1px solid rgba(33,150,243,0.4);border-radius:50%;font-size:9px;color:#42A5F5;margin-left:5px;cursor:help;opacity:0.7;transition:all 0.3s;vertical-align:middle; }
        .info-icon:hover { opacity:1;background:rgba(33,150,243,0.4); }
        /* Simple-DataTables Dark Theme */
        .datatable-wrapper { background:transparent; }
        .datatable-container { background:transparent; }
        .datatable-top, .datatable-bottom { background:transparent;padding:10px 0; }
        .datatable-top label, .datatable-bottom label { color:var(--text-secondary); }
        .datatable-selector { background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border-color);border-radius:6px;padding:5px 10px; }
        .datatable-input { background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border-color);border-radius:6px;padding:8px 12px; }
        .datatable-info { color:var(--text-secondary); }
        .datatable-pagination .datatable-pagination-list { display:flex;gap:5px; }
        .datatable-pagination .datatable-pagination-list-item-link { background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border-color);border-radius:6px;padding:5px 10px;text-decoration:none; }
        .datatable-pagination .datatable-pagination-list-item-link:hover { background:var(--bg-card-hover); }
        .datatable-pagination .datatable-pagination-list-item.datatable-active .datatable-pagination-list-item-link { background:var(--primary);border-color:var(--primary); }
        .datatable-table thead th { cursor:pointer; }
        .datatable-sorter::before, .datatable-sorter::after { border-color:var(--text-secondary) transparent; }
        .datatable-filter { background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border-color);border-radius:4px;padding:4px 8px;font-size:0.75rem;width:100%;margin-top:5px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo"><h1>Radar</h1><span>T√≠tulos e Fundos</span></div>
        <div class="nav-section">
            <div class="nav-section-title">Visao Geral</div>
            <div class="nav-item active" onclick="showTab('overview',event)" title="Visao geral do portfolio com metricas principais e graficos resumidos"><span class="icon">üìä</span> Overview</div>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Fundos</div>
            <div class="nav-item" onclick="showTab('explorar',event)" title="Pesquise e filtre entre 123.732 fundos consolidados (ANBIMA + CVM)"><span class="icon">üîç</span> Explorar Fundos</div>
            <div class="nav-item" onclick="showTab('gestoras',event)" title="Lista de gestoras com seus fundos, classes ANBIMA e distribuicao"><span class="icon">üèõÔ∏è</span> Gestoras</div>
            <div class="nav-item" onclick="showTab('favoritos',event)" title="Seus fundos favoritos salvos para acompanhamento rapido"><span class="icon">‚≠ê</span> Favoritos</div>
            <div class="nav-item" onclick="showTab('fundos-is',event)" title="Fundos classificados como Investimento Sustentavel (IS) pela ANBIMA"><span class="icon">üå±</span> Fundos IS</div>
            <div class="nav-item" onclick="showTab('fundos-esg',event)" title="Fundos com integracao ESG: Ambiental, Social e Governanca"><span class="icon">üåç</span> Fundos ESG</div>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Titulos</div>
            <div class="nav-item" onclick="showTab('debentures',event)" title="250 debentures com taxas, duration e indexadores (IPCA, DI, Pre)"><span class="icon">üìú</span> Debentures</div>
            <div class="nav-item" onclick="showTab('titulos-publicos',event)" title="Titulos publicos federais: LTN, NTN-B, NTN-F, LFT"><span class="icon">üèõÔ∏è</span> Titulos Publicos</div>
            <div class="nav-item" onclick="showTab('cri-cra',event)" title="28 CRI/CRA: Certificados de Recebiveis Imobiliarios e do Agronegocio"><span class="icon">üè†</span> CRI/CRA</div>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Sustentabilidade</div>
            <div class="nav-item" onclick="showTab('tsb',event)" title="Taxonomia Sustentavel Brasileira: 58 empresas classificadas Verde/Transicao, titulos verdes e fundos ESG"><span class="icon">üåø</span> Mapeamento TSB</div>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">ANBIMA Data</div>
            <div class="nav-item" onclick="showTab('anbima-fundos',event)" title="40.332 fundos da ANBIMA com caracteristicas, categorias e classificacao ESG"><span class="icon">üìà</span> Fundos ANBIMA</div>
            <div class="nav-item" onclick="showTab('anbima-periodicos',event)" title="33.235 fundos com PL, cotistas e valor da cota - R$ 12,97 trilhoes"><span class="icon">üí∞</span> Dados Periodicos</div>
            <div class="nav-item" onclick="showTab('anbima-cricra',event)" title="1.709 CRI/CRA com precos indicativos, taxas e duration"><span class="icon">üèóÔ∏è</span> CRI/CRA ANBIMA</div>
            <div class="nav-item" onclick="showTab('anbima-titulos',event)" title="Titulos publicos com precos indicativos da ANBIMA"><span class="icon">üìã</span> Titulos Publicos</div>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Analise de Credito</div>
            <div class="nav-item" onclick="showTab('risk-scoring',event)" title="Analise de risco integrada: ESG, Credito, Concentracao, Liquidez e Clima"><span class="icon">üìä</span> Risk Scoring</div>
            <div class="nav-item" onclick="showTab('early-warning',event)" title="Sistema de alertas antecipados para riscos de credito e mercado"><span class="icon">‚ö†Ô∏è</span> Early Warning</div>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Analise de Divida</div>
            <div class="nav-item" onclick="showTab('debt-analysis',event)" title="Analise detalhada da estrutura de divida: custos, prazos e composicao"><span class="icon">üìà</span> Analise Divida</div>
            <div class="nav-item" onclick="showTab('vencimentos',event)" title="Calendario de vencimentos de titulos e fluxo de caixa projetado"><span class="icon">üìÖ</span> Vencimentos</div>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Empresas</div>
            <div class="nav-item" onclick="showTab('emissores',event)" title="Cadastro de emissores TSB com classificacao, scores e titulos vinculados"><span class="icon">üè¢</span> Emissores</div>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">CVM Data</div>
            <div class="nav-item" onclick="showTab('cvm-consolidado',event)" title="123.732 fundos consolidados ANBIMA + CVM com cruzamento de dados"><span class="icon">üîó</span> Fundos Consolidados</div>
            <div class="nav-item" onclick="showTab('cvm-cadastro',event)" title="41.121 fundos do cadastro oficial CVM com situacao e classe"><span class="icon">üìã</span> Cadastro CVM</div>
            <div class="nav-item" onclick="showTab('cvm-informes',event)" title="Informes diarios CVM: PL, cotistas, captacao e resgates"><span class="icon">üìä</span> Informes Diarios</div>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Inteligencia Artificial</div>
            <div class="nav-item" onclick="showTab('ai-consulta',event)" title="Consulte dados do portfolio usando linguagem natural com IA"><span class="icon">ü§ñ</span> Consulta IA</div>
        </div>
    </div>

    <div class="main-content">
        <div class="page-header">
            <h2>Radar de T√≠tulos e Fundos</h2>
            <p class="subtitle">Dashboard ESG - Banco Votorantim</p>
            <span class="badge">‚úì DADOS EM TEMPO REAL</span>
        </div>

        <!-- TAB: Overview -->
        <div id="overview" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card has-tooltip" title="Total de fundos de investimento registrados na base ANBIMA, incluindo todas as categorias e classes"><div class="label">TODOS os Fundos</div><div class="value text-primary" id="statTotalFundos">...</div><div class="change positive">Base completa ANBIMA</div></div>
                <div class="stat-card has-tooltip" title="Fundos com classificacao ESG: 18 sao IS (Investimento Sustentavel) e 29 tem integracao ESG em sua gestao"><div class="label">Fundos ESG</div><div class="value text-secondary" id="statFundosESG">...</div><div class="change positive" id="statFundosESGDetalhe">...</div></div>
                <div class="stat-card has-tooltip" title="Debentures corporativas disponiveis para analise, com taxas indicativas, duration e indexadores"><div class="label">Debentures</div><div class="value text-accent" id="statDebentures">...</div><div class="change">Base ANBIMA</div></div>
                <div class="stat-card has-tooltip" title="Titulos publicos federais: LTN (prefixado), NTN-B (IPCA), NTN-F (prefixado com cupom), LFT (Selic)"><div class="label">Titulos Publicos</div><div class="value text-info" id="statTitulosPublicos">...</div><div class="change" id="statTitulosTipos">...</div></div>
                <div class="stat-card has-tooltip" title="Empresas classificadas pela Taxonomia Sustentavel Brasileira (TSB) com scores de sustentabilidade"><div class="label">Empresas TSB</div><div class="value text-secondary" id="statEmpresasTSB">...</div><div class="change positive" id="statEmpresasTSBDetalhe">...</div></div>
            </div>
            <div class="grid-2">
                <div class="chart-card has-tooltip" title="Distribuicao dos fundos por categoria ANBIMA: Acoes, Renda Fixa, Multimercado, Cambial, etc."><h3>üìä Fundos por Categoria</h3><div class="chart-container"><canvas id="chartCategorias"></canvas></div></div>
                <div class="chart-card has-tooltip" title="Composicao da carteira de titulos publicos por tipo: quantidade e participacao de cada instrumento"><h3>üèõÔ∏è Titulos Publicos por Tipo</h3><div class="chart-container"><canvas id="chartTitulos"></canvas></div></div>
            </div>
        </div>

        <!-- TAB: Explorar -->
        <div id="explorar" class="tab-content">
            <div class="chart-card has-tooltip" title="Pesquisa avancada em toda a base de fundos ANBIMA e CVM">
                <h3>üîç Explorar Fundos</h3>
                <p style="color:var(--text-secondary);margin-bottom:20px;">Pesquise entre todos os <strong style="color:#4DD0E1;">123.732</strong> fundos consolidados (ANBIMA + CVM)</p>

                <!-- Filtros de Busca -->
                <div style="display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap;align-items:center;">
                    <input type="text" id="searchExplorar" placeholder="Buscar por nome ou CNPJ..."
                        style="flex:1;min-width:250px;padding:12px 15px;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:0.95rem;">
                    <select id="filtroFonteExplorar" style="padding:12px 15px;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);">
                        <option value="">Todas as Fontes</option>
                        <option value="ANBIMA">ANBIMA (85.144)</option>
                        <option value="CVM">CVM (38.588)</option>
                    </select>
                    <button onclick="paginaAtualAPI=1;buscarFundosAPI()" style="padding:12px 20px;background:var(--primary);border:none;border-radius:8px;color:white;cursor:pointer;font-weight:600;">Buscar</button>
                </div>

                <!-- Status da API -->
                <div id="apiStatus" style="margin-bottom:15px;padding:10px 15px;border-radius:8px;font-size:0.85rem;display:none;"></div>

                <!-- Estat√≠sticas -->
                <div id="statsExplorar" style="display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap;">
                    <div style="background:rgba(25,118,210,0.15);padding:10px 20px;border-radius:8px;border:1px solid rgba(25,118,210,0.3);" title="Quantidade de fundos que correspondem aos filtros aplicados">
                        <span style="color:var(--text-secondary);font-size:0.75rem;">TOTAL ENCONTRADOS</span>
                        <div id="totalEncontrados" style="font-size:1.5rem;font-weight:700;color:var(--primary-light);">...</div>
                    </div>
                    <div style="background:rgba(255,152,0,0.15);padding:10px 20px;border-radius:8px;border:1px solid rgba(255,152,0,0.3);" title="Pagina atual da listagem (50 fundos por pagina)">
                        <span style="color:var(--text-secondary);font-size:0.75rem;">P√ÅGINA</span>
                        <div id="paginaAtualStat" style="font-size:1.5rem;font-weight:700;color:var(--accent-light);">...</div>
                    </div>
                </div>

                <!-- Loading -->
                <div id="loadingFundos" style="display:none;text-align:center;padding:40px;">
                    <div style="display:inline-block;width:40px;height:40px;border:3px solid var(--border-color);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;"></div>
                    <p style="color:var(--text-secondary);margin-top:15px;">Carregando fundos...</p>
                </div>

                <!-- Tabela de Resultados -->
                <div id="tabelaContainer" style="overflow-x:auto;max-height:500px;" title="Resultados da busca de fundos">
                    <table id="tabelaFundos">
                        <thead>
                            <tr>
                                <th title="Fonte dos dados: ANBIMA ou CVM">Fonte</th>
                                <th title="Nome completo do fundo de investimento">Nome</th>
                                <th title="CNPJ do fundo">CNPJ</th>
                                <th title="Categoria ANBIMA ou Classe CVM">Categoria</th>
                                <th title="Gestora responsavel pelo fundo">Gestora</th>
                                <th title="Fundo com classificacao ESG">ESG</th>
                                <th title="Acoes disponiveis: detalhes, favoritar">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="corpoTabelaFundos">
                            <tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-secondary);">
                                Clique em "Buscar" para carregar os fundos<br>
                                <small>Total: 123.732 fundos (ANBIMA + CVM)</small>
                            </td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagina√ß√£o -->
                <div id="paginacao" style="display:flex;justify-content:center;align-items:center;gap:10px;margin-top:20px;">
                    <button onclick="mudarPaginaAPI(-1)" style="padding:8px 15px;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary);cursor:pointer;" title="Ir para pagina anterior">‚Üê Anterior</button>
                    <span id="infoPagina" style="color:var(--text-secondary);">P√°gina 1 de 1</span>
                    <button onclick="mudarPaginaAPI(1)" style="padding:8px 15px;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary);cursor:pointer;" title="Ir para proxima pagina">Pr√≥xima ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- TAB: Gestoras -->
        <div id="gestoras" class="tab-content">
            <div class="stats-grid" style="grid-template-columns:repeat(3,1fr);">
                <div class="stat-card has-tooltip" title="Numero de gestoras distintas na base de dados"><div class="label">Total Gestoras</div><div class="value text-primary" id="statTotalGestoras">-</div></div>
                <div class="stat-card has-tooltip" title="Total de fundos geridos por todas as gestoras"><div class="label">Total Fundos</div><div class="value text-secondary" id="statTotalFundosGestoras">-</div></div>
                <div class="stat-card has-tooltip" title="Quantidade de classes ANBIMA distintas nos fundos"><div class="label">Classes ANBIMA</div><div class="value text-accent" id="statTotalClasses">-</div></div>
            </div>
            <div class="grid-2">
                <div class="chart-card has-tooltip" title="Lista de gestoras ordenadas por quantidade de fundos sob gestao">
                    <h3>üèõÔ∏è Gestoras por Quantidade de Fundos</h3>
                    <div style="margin-bottom:15px;">
                        <input type="text" id="searchGestora" placeholder="Buscar gestora..." style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border-color);background:var(--card-bg);color:var(--text-primary);" onkeyup="filtrarGestoras()" title="Digite para filtrar gestoras por nome">
                    </div>
                    <div style="overflow-y:auto;max-height:500px;" id="listaGestoras">
                        <p style="color:var(--text-secondary);text-align:center;padding:40px;">Carregando gestoras...</p>
                    </div>
                </div>
                <div class="chart-card has-tooltip" title="Lista de fundos da gestora selecionada a esquerda">
                    <h3>üìä Fundos da Gestora Selecionada</h3>
                    <div id="fundosGestoraSelecionada" style="overflow-y:auto;max-height:500px;">
                        <p style="color:var(--text-secondary);text-align:center;padding:40px;">Selecione uma gestora para ver seus fundos</p>
                    </div>
                </div>
            </div>
            <div class="chart-card has-tooltip" style="margin-top:20px;" title="As 10 classes ANBIMA com maior numero de fundos na base">
                <h3>üìà Top 10 Classes ANBIMA</h3>
                <div class="chart-container" style="height:300px;">
                    <canvas id="chartClassesAnbima"></canvas>
                </div>
            </div>
        </div>

        <!-- TAB: Favoritos -->
        <div id="favoritos" class="tab-content">
            <div class="chart-card has-tooltip" title="Lista de fundos marcados como favoritos para acompanhamento">
                <h3>‚≠ê Meus Favoritos (<span id="totalFavoritos">0</span>)</h3>
                <div id="listaFavoritos" style="overflow-x:auto;max-height:500px;">
                    <p id="semFavoritos" style="color:var(--text-secondary);text-align:center;padding:40px;">
                        Nenhum fundo favoritado ainda.<br>
                        <small>Clique em ‚≠ê na aba "Explorar Fundos" para adicionar favoritos.</small>
                    </p>
                    <table id="tabelaFavoritos" style="display:none;">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>CNPJ</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="corpoFavoritos"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: Fundos IS/ESG -->
        <div id="fundos-is" class="tab-content">
            <div class="chart-card has-tooltip" title="Fundos com classificacao ESG da base ANBIMA">
                <h3>üå± Fundos ESG - Base ANBIMA (<span id="countFundosESG">...</span>)</h3>
                <p style="color:var(--text-secondary);margin-bottom:15px;">Fundos classificados como ESG na base ANBIMA Data</p>
                <div id="loadingFundosIS" style="text-align:center;padding:20px;color:var(--text-secondary);">Carregando...</div>
                <div style="overflow-x:auto;max-height:500px;">
                    <table id="tabelaFundosIS">
                        <thead><tr>
                            <th title="Nome completo do fundo">Nome</th>
                            <th title="CNPJ do fundo">CNPJ</th>
                            <th title="Categoria ANBIMA">Categoria</th>
                            <th title="Gestor do fundo">Gestor</th>
                        </tr></thead>
                        <tbody id="corpoFundosIS"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: Fundos ESG (redirect to same data) -->
        <div id="fundos-esg" class="tab-content">
            <div class="chart-card has-tooltip" title="Fundos com classificacao ESG da base ANBIMA">
                <h3>üåç Fundos ESG - Base ANBIMA (<span id="countFundosESG2">...</span>)</h3>
                <p style="color:var(--text-secondary);margin-bottom:15px;">Fundos classificados como ESG na base ANBIMA Data</p>
                <div id="loadingFundosESG" style="text-align:center;padding:20px;color:var(--text-secondary);">Carregando...</div>
                <div style="overflow-x:auto;max-height:500px;">
                    <table id="tabelaFundosESG">
                        <thead><tr>
                            <th title="Nome completo do fundo">Nome</th>
                            <th title="CNPJ do fundo">CNPJ</th>
                            <th title="Categoria ANBIMA">Categoria</th>
                            <th title="Gestor do fundo">Gestor</th>
                        </tr></thead>
                        <tbody id="corpoFundosESG"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: Debentures -->
        <div id="debentures" class="tab-content">
            <div class="stats-grid" style="grid-template-columns:repeat(4,1fr);">
                <div class="stat-card has-tooltip" title="Total de debentures na base de dados"><div class="label">Total</div><div class="value text-accent" id="debTotal">...</div></div>
                <div class="stat-card has-tooltip" title="Debentures com remuneracao % do DI (ex: 105% CDI)"><div class="label">DI Percentual</div><div class="value text-primary" id="debDIPerc">...</div></div>
                <div class="stat-card has-tooltip" title="Debentures com remuneracao DI + spread (ex: CDI + 2%)"><div class="label">DI Spread</div><div class="value text-info" id="debDISpread">...</div></div>
                <div class="stat-card has-tooltip" title="Debentures indexadas ao IPCA + spread (ex: IPCA + 6%)"><div class="label">IPCA Spread</div><div class="value text-secondary" id="debIPCASpread">...</div></div>
            </div>
            <div class="chart-card has-tooltip" title="Lista completa de debentures com dados de taxa, duration e preco unitario">
                <h3>üìú Deb√™ntures Corporativas</h3>
                <div id="loadingDebentures" style="text-align:center;padding:20px;color:var(--text-secondary);">Carregando deb√™ntures...</div>
                <div style="overflow-x:auto;max-height:500px;">
                    <table id="tabelaDebentures">
                        <thead><tr>
                            <th title="Empresa emissora da debenture">Emissor</th>
                            <th title="Codigo do titulo no mercado">Codigo</th>
                            <th title="Tipo de indexador: DI Percentual, DI Spread ou IPCA Spread">Grupo</th>
                            <th title="Taxa de remuneracao do titulo">Taxa</th>
                            <th title="Duration: prazo medio ponderado em dias">Duration</th>
                            <th title="Preco unitario atual do titulo">PU</th>
                        </tr></thead>
                        <tbody id="corpoDebentures"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: Titulos Publicos -->
        <div id="titulos-publicos" class="tab-content">
            <div class="stats-grid" style="grid-template-columns:repeat(5,1fr);">
                <div class="stat-card has-tooltip" title="Total de titulos publicos federais na base"><div class="label">Total</div><div class="value text-info" id="titTotal">...</div></div>
                <div class="stat-card has-tooltip" title="LTN: Letra do Tesouro Nacional - titulo prefixado sem cupom"><div class="label">LTN</div><div class="value text-primary" id="titLTN">...</div></div>
                <div class="stat-card has-tooltip" title="NTN-F: Nota do Tesouro Nacional serie F - prefixado com cupom semestral"><div class="label">NTN-F</div><div class="value text-accent" id="titNTNF">...</div></div>
                <div class="stat-card has-tooltip" title="NTN-B: Nota do Tesouro Nacional serie B - indexado ao IPCA com cupom semestral"><div class="label">NTN-B</div><div class="value text-secondary" id="titNTNB">...</div></div>
                <div class="stat-card has-tooltip" title="LFT: Letra Financeira do Tesouro - pos-fixado atrelado a SELIC"><div class="label">LFT</div><div class="value text-info" id="titLFT">...</div></div>
            </div>
            <div class="chart-card has-tooltip" title="Titulos publicos federais com taxas indicativas e precos unitarios">
                <h3>üèõÔ∏è Titulos Publicos</h3>
                <div id="loadingTitulosPublicos" style="text-align:center;padding:20px;color:var(--text-secondary);">Carregando t√≠tulos p√∫blicos...</div>
                <div style="overflow-x:auto;">
                    <table id="tabelaTitulosPublicos">
                        <thead><tr>
                            <th title="Tipo do titulo: LTN, NTN-F, NTN-B ou LFT">Tipo</th>
                            <th title="Data de vencimento do titulo">Vencimento</th>
                            <th title="Taxa indicativa anual do titulo">Taxa Indicativa</th>
                            <th title="Preco unitario atual do titulo">PU</th>
                        </tr></thead>
                        <tbody id="corpoTitulosPublicos"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: CRI/CRA -->
        <div id="cri-cra" class="tab-content">
            <div id="cricraStats" class="stats-grid" style="grid-template-columns:repeat(3,1fr);">
                <div class="stat-card has-tooltip" title="Total de titulos de securitizacao imobiliaria e agroindustrial"><div class="label">Total</div><div class="value text-info" id="cricraTotal">-</div></div>
                <div class="stat-card has-tooltip" title="CRI: Certificado de Recebiveis Imobiliarios - lastreados em creditos imobiliarios"><div class="label">CRI</div><div class="value text-primary" id="cricraCountCRI">-</div></div>
                <div class="stat-card has-tooltip" title="CRA: Certificado de Recebiveis do Agronegocio - lastreados em creditos agroindustriais"><div class="label">CRA</div><div class="value text-secondary" id="cricraCountCRA">-</div></div>
            </div>
            <div id="cricraLoading" class="chart-card" style="text-align:center;padding:40px;">
                <p style="color:var(--text-secondary);">Carregando dados de CRI/CRA...</p>
            </div>
            <div id="cricraContainer" class="chart-card has-tooltip" style="display:none;" title="Lista completa de CRIs e CRAs com dados de taxa, PU e duration">
                <h3>üè† CRI/CRA - Certificados de Receb√≠veis</h3>
                <div style="overflow-x:auto;max-height:500px;">
                    <table id="tabelaCRICRA">
                        <thead><tr><th title="Tipo do titulo: CRI ou CRA">Tipo</th><th title="Codigo do titulo">C√≥digo</th><th title="Securitizadora emissora do titulo">Emissor</th><th title="Serie da emissao">S√©rie</th><th title="Data de vencimento do titulo">Vencimento</th><th title="Taxa indicativa de remuneracao">Taxa Indicativa</th><th title="Preco unitario atual">PU</th><th title="Duration: prazo medio ponderado em dias">Duration</th></tr></thead>
                        <tbody id="corpoCRICRA"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: TSB -->
        <div id="tsb" class="tab-content">
            <!-- Header -->
            <div class="chart-card" style="background:linear-gradient(135deg,rgba(46,125,50,0.2) 0%,rgba(0,150,136,0.2) 100%);border-color:rgba(46,125,50,0.3);">
                <div style="display:flex;align-items:center;gap:20px;">
                    <div style="font-size:3rem;">üåø</div>
                    <div>
                        <h2 style="color:#66BB6A;margin:0;">Taxonomia Sustentavel Brasileira (TSB)</h2>
                        <p style="color:#a5d6a7;margin-top:8px;">Mapeamento integrado: Empresas + Titulos + Fundos Sustentaveis</p>
                        <span id="tsbBadge" class="badge" style="background:#4CAF50;">Carregando...</span>
                    </div>
                </div>
            </div>

            <!-- Stats Grid Principal -->
            <div class="stats-grid" style="grid-template-columns:repeat(6,1fr);">
                <div class="stat-card has-tooltip" style="border-left:4px solid #4CAF50;" title="Total de empresas mapeadas na Taxonomia Sustentavel Brasileira"><div class="label">Empresas TSB</div><div class="value text-secondary" id="tsbTotalEmpresas">-</div></div>
                <div class="stat-card has-tooltip" style="border-left:4px solid #66BB6A;" title="Empresas com classificacao VERDE: atividades economicas sustentaveis"><div class="label">Verde</div><div class="value" style="color:#66BB6A;" id="tsbTotalVerde">-</div></div>
                <div class="stat-card has-tooltip" style="border-left:4px solid #FF9800;" title="Empresas em TRANSICAO: em processo de transicao para economia verde"><div class="label">Transicao</div><div class="value text-accent" id="tsbTotalTransicao">-</div></div>
                <div class="stat-card has-tooltip" style="border-left:4px solid #42A5F5;" title="Total de debentures emitidas por empresas com classificacao TSB"><div class="label">Titulos Verdes</div><div class="value text-primary" id="tsbTotalTitulos">-</div></div>
                <div class="stat-card has-tooltip" style="border-left:4px solid #9C27B0;" title="Fundos de investimento com mandato ESG, Verde, Social ou Ambiental"><div class="label">Fundos ESG</div><div class="value" style="color:#BA68C8;" id="tsbTotalFundosESG">-</div></div>
                <div class="stat-card has-tooltip" style="border-left:4px solid #00BCD4;" title="Score medio de sustentabilidade das empresas (0-100)"><div class="label">Score Medio</div><div class="value text-info" id="tsbScoreMedio">-</div></div>
            </div>

            <!-- Sub-navegacao TSB -->
            <div style="display:flex;gap:10px;margin:20px 0;flex-wrap:wrap;">
                <button onclick="mostrarSecaoTSB('empresas')" class="tsb-nav-btn active" id="btnTsbEmpresas" style="padding:10px 20px;border-radius:8px;border:1px solid var(--border-color);background:rgba(76,175,80,0.2);color:#66BB6A;cursor:pointer;font-weight:600;" title="Lista de empresas mapeadas na TSB com classificacao e score">üè¢ Empresas</button>
                <button onclick="mostrarSecaoTSB('titulos')" class="tsb-nav-btn" id="btnTsbTitulos" style="padding:10px 20px;border-radius:8px;border:1px solid var(--border-color);background:var(--card-bg);color:var(--text-secondary);cursor:pointer;" title="Debentures emitidas por empresas Verde e Transicao">üìú Titulos Verdes</button>
                <button onclick="mostrarSecaoTSB('fundos')" class="tsb-nav-btn" id="btnTsbFundos" style="padding:10px 20px;border-radius:8px;border:1px solid var(--border-color);background:var(--card-bg);color:var(--text-secondary);cursor:pointer;" title="Fundos com mandato ESG, Verde, Social ou Ambiental">üíö Fundos Sustentaveis</button>
                <button onclick="mostrarSecaoTSB('integrado')" class="tsb-nav-btn" id="btnTsbIntegrado" style="padding:10px 20px;border-radius:8px;border:1px solid var(--border-color);background:var(--card-bg);color:var(--text-secondary);cursor:pointer;" title="Visao completa: Empresa -> Titulos emitidos -> Fundos relacionados">üîó Visao Integrada</button>
            </div>

            <!-- Secao: Empresas TSB -->
            <div id="secaoTsbEmpresas">
                <div class="grid-2">
                    <div class="chart-card has-tooltip" title="Distribuicao das empresas por classificacao TSB: Verde (sustentavel) ou Transicao"><h3>üìä Classificacao TSB</h3><div class="chart-container"><canvas id="chartTSBClass"></canvas></div></div>
                    <div class="chart-card has-tooltip" title="Distribuicao das empresas TSB por setor economico"><h3>üè≠ Por Setor</h3><div class="chart-container"><canvas id="chartTSBSetor"></canvas></div></div>
                </div>
                <div class="chart-card has-tooltip" title="Tabela completa de empresas mapeadas na Taxonomia Sustentavel Brasileira">
                    <h3>üè¢ Empresas Mapeadas na TSB <span style="font-size:0.8rem;color:#a0a0b0;">(clique para ver investimentos relacionados)</span></h3>
                    <div style="overflow-x:auto;max-height:400px;">
                        <table>
                            <thead><tr><th title="Razao social da empresa">Empresa</th><th title="CNPJ da empresa">CNPJ</th><th title="Setor economico conforme classificacao TSB">Setor</th><th title="VERDE = atividades sustentaveis, TRANSICAO = em processo">Classificacao</th><th title="Score de sustentabilidade (0-100)">Score</th><th title="Quantidade de titulos emitidos pela empresa">Titulos</th><th title="Acoes disponiveis: ver detalhes, investimentos">Acoes</th></tr></thead>
                            <tbody id="corpoTabelaTSB"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Secao: Titulos Verdes -->
            <div id="secaoTsbTitulos" style="display:none;">
                <div class="stats-grid" style="grid-template-columns:repeat(4,1fr);">
                    <div class="stat-card has-tooltip" style="border-left:4px solid #4CAF50;" title="Quantidade de debentures emitidas por empresas classificadas como VERDE"><div class="label">Debentures Verde</div><div class="value" style="color:#66BB6A;" id="tsbDebenturesVerde">-</div></div>
                    <div class="stat-card has-tooltip" style="border-left:4px solid #FF9800;" title="Quantidade de debentures emitidas por empresas em TRANSICAO"><div class="label">Debentures Transicao</div><div class="value text-accent" id="tsbDebenturesTransicao">-</div></div>
                    <div class="stat-card has-tooltip" style="border-left:4px solid #4CAF50;" title="Numero de empresas VERDE que possuem debentures emitidas"><div class="label">Empresas Verde</div><div class="value" style="color:#66BB6A;" id="tsbEmpresasVerdeDebt">-</div></div>
                    <div class="stat-card has-tooltip" style="border-left:4px solid #42A5F5;" title="Score medio de sustentabilidade das empresas VERDE com debentures"><div class="label">Score Medio Verde</div><div class="value text-primary" id="tsbScoreVerdeDebt">-</div></div>
                </div>
                <div class="chart-card has-tooltip" title="Listagem de debentures emitidas por empresas com classificacao VERDE na TSB">
                    <h3 style="color:#66BB6A;">üå± Debentures de Empresas VERDE</h3>
                    <p style="color:var(--text-secondary);margin-bottom:15px;">Titulos emitidos por empresas com classificacao sustentavel</p>
                    <div style="overflow-x:auto;max-height:350px;">
                        <table>
                            <thead><tr><th title="Nome da empresa emissora">Empresa</th><th title="Setor economico TSB">Setor</th><th title="Score de sustentabilidade">Score</th><th title="Codigo da debenture">Codigo</th><th title="Grupo de investimento">Grupo</th><th title="Taxa de remuneracao do titulo">Taxa</th><th title="Duration: prazo medio ponderado do titulo em anos">Duration</th></tr></thead>
                            <tbody id="corpoTitulosVerde"></tbody>
                        </table>
                    </div>
                </div>
                <div class="chart-card has-tooltip" style="margin-top:20px;" title="Listagem de debentures emitidas por empresas em TRANSICAO para economia verde">
                    <h3 style="color:#FFB74D;">üîÑ Debentures de Empresas em TRANSICAO</h3>
                    <p style="color:var(--text-secondary);margin-bottom:15px;">Titulos de empresas caminhando para sustentabilidade</p>
                    <div style="overflow-x:auto;max-height:300px;">
                        <table>
                            <thead><tr><th title="Nome da empresa emissora">Empresa</th><th title="Setor economico TSB">Setor</th><th title="Score de sustentabilidade">Score</th><th title="Codigo da debenture">Codigo</th><th title="Grupo de investimento">Grupo</th><th title="Taxa de remuneracao do titulo">Taxa</th><th title="Duration: prazo medio ponderado do titulo em anos">Duration</th></tr></thead>
                            <tbody id="corpoTitulosTransicao"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Secao: Fundos Sustentaveis -->
            <div id="secaoTsbFundos" style="display:none;">
                <div class="stats-grid" style="grid-template-columns:repeat(3,1fr);">
                    <div class="stat-card has-tooltip" style="border-left:4px solid #9C27B0;" title="Total de fundos com mandato ESG, Verde, Social ou Ambiental"><div class="label">Total Fundos ESG</div><div class="value" style="color:#BA68C8;" id="tsbFundosTotal">-</div></div>
                    <div class="stat-card has-tooltip" style="border-left:4px solid #66BB6A;" title="Numero de gestoras que administram fundos sustentaveis"><div class="label">Gestoras</div><div class="value" style="color:#66BB6A;" id="tsbFundosGestoras">-</div></div>
                    <div class="stat-card has-tooltip" style="border-left:4px solid #42A5F5;" title="Quantidade de classes ANBIMA distintas nos fundos sustentaveis"><div class="label">Classes ANBIMA</div><div class="value text-primary" id="tsbFundosClasses">-</div></div>
                </div>
                <div class="grid-2">
                    <div class="chart-card has-tooltip" title="Ranking das gestoras com maior numero de fundos sustentaveis">
                        <h3>üèõÔ∏è Top Gestoras ESG</h3>
                        <div id="listaGestorasESG" style="max-height:300px;overflow-y:auto;"></div>
                    </div>
                    <div class="chart-card has-tooltip" title="Distribuicao dos fundos sustentaveis por classe ANBIMA">
                        <h3>üìä Por Classe ANBIMA</h3>
                        <div class="chart-container"><canvas id="chartFundosESGClasse"></canvas></div>
                    </div>
                </div>
                <div class="chart-card has-tooltip" style="margin-top:20px;" title="Lista completa de fundos com mandato sustentavel">
                    <h3>üíö Fundos Sustentaveis <span style="font-size:0.8rem;color:#a0a0b0;">(ESG, Verde, Social, Ambiental)</span></h3>
                    <div style="margin-bottom:15px;">
                        <input type="text" id="searchFundoESG" placeholder="Buscar fundo sustentavel..." onkeyup="filtrarFundosESG()" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border-color);background:var(--card-bg);color:var(--text-primary);" title="Digite para filtrar fundos por nome, gestora ou classe">
                    </div>
                    <div style="overflow-x:auto;max-height:400px;">
                        <table>
                            <thead><tr><th title="Nome completo do fundo de investimento">Nome do Fundo</th><th title="CNPJ do fundo">CNPJ</th><th title="Gestora responsavel pelo fundo">Gestora</th><th title="Classificacao ANBIMA do fundo">Classe ANBIMA</th><th title="Tipo de investidor: Geral, Qualificado ou Profissional">Publico</th></tr></thead>
                            <tbody id="corpoFundosESG"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Secao: Visao Integrada -->
            <div id="secaoTsbIntegrado" style="display:none;">
                <div class="chart-card has-tooltip" title="Visualizacao completa do relacionamento entre empresa, titulos emitidos e fundos que investem">
                    <h3>üîó Visao Integrada: Empresa ‚Üí Titulos ‚Üí Fundos</h3>
                    <p style="color:var(--text-secondary);margin-bottom:15px;">Selecione uma empresa para ver titulos emitidos e fundos relacionados</p>
                    <div style="margin-bottom:20px;">
                        <select id="selectEmpresaIntegrada" onchange="carregarVisaoIntegrada()" style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border-color);background:var(--card-bg);color:var(--text-primary);font-size:1rem;" title="Selecione uma empresa TSB para ver seus titulos e fundos relacionados">
                            <option value="">-- Selecione uma empresa TSB --</option>
                        </select>
                    </div>
                    <div id="visaoIntegradaConteudo">
                        <div style="text-align:center;padding:40px;color:var(--text-secondary);">
                            <div style="font-size:3rem;margin-bottom:15px;">üè¢</div>
                            <p>Selecione uma empresa acima para ver a visao integrada</p>
                        </div>
                    </div>
                </div>
            </div>
            <h3 style="margin:20px 0 15px;">üìà KPIs Obrigatorios por Setor</h3>
            <div class='chart-card' style='margin-bottom:15px;'><h3>KPIs - Agua, Esgoto, Residuos e Descontaminacao</h3><div style='display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-top:15px;'><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>S01</div><div style='font-size:0.8rem;margin:5px 0;'>Volume Agua Tratada</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>S02</div><div style='font-size:0.8rem;margin:5px 0;'>Volume Esgoto Tratado</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>S03</div><div style='font-size:0.8rem;margin:5px 0;'>Populacao Atendida Agua</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>S04</div><div style='font-size:0.8rem;margin:5px 0;'>Populacao Atendida Esgoto</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>S05</div><div style='font-size:0.8rem;margin:5px 0;'>Indice de Cobertura Agua</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>S06</div><div style='font-size:0.8rem;margin:5px 0;'>Indice de Cobertura Esgoto</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>S07</div><div style='font-size:0.8rem;margin:5px 0;'>Indice de Perdas de Agua</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>S08</div><div style='font-size:0.8rem;margin:5px 0;'>ETAs em Operacao</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>S09</div><div style='font-size:0.8rem;margin:5px 0;'>ETEs em Operacao</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>S10</div><div style='font-size:0.8rem;margin:5px 0;'>Instalacoes Adicionadas no Per</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>S11</div><div style='font-size:0.8rem;margin:5px 0;'>Residuos Desviados de Aterro</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Opcional</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>S12</div><div style='font-size:0.8rem;margin:5px 0;'>Emissoes GEE Escopo 1</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div></div></div><div class='chart-card' style='margin-bottom:15px;'><h3>KPIs - Eletricidade e Gas</h3><div style='display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-top:15px;'><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>E01</div><div style='font-size:0.8rem;margin:5px 0;'>Emissoes GEE Escopo 1</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>E02</div><div style='font-size:0.8rem;margin:5px 0;'>Emissoes GEE Escopo 2</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>E03</div><div style='font-size:0.8rem;margin:5px 0;'>Emissoes GEE Escopo 3</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Opcional</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>E04</div><div style='font-size:0.8rem;margin:5px 0;'>Capacidade Instalada Total</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>E05</div><div style='font-size:0.8rem;margin:5px 0;'>Capacidade Instalada Renovavel</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>E06</div><div style='font-size:0.8rem;margin:5px 0;'>Percentual Energia Renovavel</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>E07</div><div style='font-size:0.8rem;margin:5px 0;'>Geracao Anual Total</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>E08</div><div style='font-size:0.8rem;margin:5px 0;'>Geracao Anual Renovavel</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>E09</div><div style='font-size:0.8rem;margin:5px 0;'>Emissoes Evitadas</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>E10</div><div style='font-size:0.8rem;margin:5px 0;'>Intensidade de Carbono</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>E11</div><div style='font-size:0.8rem;margin:5px 0;'>Percentual Mistura Gas Natural</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div></div></div><div class='chart-card' style='margin-bottom:15px;'><h3>KPIs - Servicos Financeiros</h3><div style='display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-top:15px;'><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>F01</div><div style='font-size:0.8rem;margin:5px 0;'>Volume Financiamentos Verdes</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>F02</div><div style='font-size:0.8rem;margin:5px 0;'>Volume Titulos Sustentaveis</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>F03</div><div style='font-size:0.8rem;margin:5px 0;'>Percentual Carteira ESG</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>F04</div><div style='font-size:0.8rem;margin:5px 0;'>Emissoes Financiadas Escopo 3</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>F05</div><div style='font-size:0.8rem;margin:5px 0;'>Investimento em Projetos Socia</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Opcional</div></div></div></div><div class='chart-card' style='margin-bottom:15px;'><h3>KPIs - Telecomunicacoes e TI</h3><div style='display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-top:15px;'><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>T01</div><div style='font-size:0.8rem;margin:5px 0;'>Consumo Energetico Total</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>T02</div><div style='font-size:0.8rem;margin:5px 0;'>Consumo Energetico Data Center</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>T03</div><div style='font-size:0.8rem;margin:5px 0;'>PUE (Power Usage Effectiveness</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>T04</div><div style='font-size:0.8rem;margin:5px 0;'>Percentual Energia Renovavel</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>T05</div><div style='font-size:0.8rem;margin:5px 0;'>Emissoes GEE Escopo 1</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>T06</div><div style='font-size:0.8rem;margin:5px 0;'>Emissoes GEE Escopo 2</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>T07</div><div style='font-size:0.8rem;margin:5px 0;'>Residuos Eletronicos Reciclado</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div><div style='background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;text-align:center;'><div style='font-size:0.7rem;color:#a0a0b0;'>T08</div><div style='font-size:0.8rem;margin:5px 0;'>Cobertura de Rede</div><div style='font-size:0.9rem;font-weight:600;color:#FF9800;'>Obrigatorio</div></div></div></div>
        </div>

        <!-- TAB: Risk Scoring -->
        <div id="risk-scoring" class="tab-content">
            <!-- Header -->
            <div class="chart-card has-tooltip" style="background:linear-gradient(135deg,rgba(244,67,54,0.15) 0%,rgba(255,152,0,0.15) 100%);border-color:rgba(244,67,54,0.3);" title="Painel de analise de risco integrada do portfolio com 5 dimensoes: ESG, Credito, Concentracao, Liquidez e Clima">
                <div style="display:flex;align-items:center;gap:20px;">
                    <div style="font-size:3rem;">üìä</div>
                    <div style="flex:1;">
                        <h2 style="color:#FF9800;margin:0;">Risk Scoring - Analise de Risco do Portfolio</h2>
                        <p style="color:#FFCC80;margin-top:8px;">Avaliacao integrada: ESG, Credito, Concentracao, Liquidez e Clima</p>
                    </div>
                    <div id="riskGlobalBadge" style="text-align:center;padding:15px 25px;border-radius:12px;background:rgba(255,255,255,0.1);" title="Score global de risco: media ponderada das 5 dimensoes. Escala 0-100, quanto MENOR melhor">
                        <div style="font-size:0.8rem;color:#a0a0b0;">Score Global</div>
                        <div id="riskScoreGlobal" style="font-size:2.5rem;font-weight:700;color:#FFC107;">-</div>
                        <div id="riskRatingGlobal" style="font-size:0.9rem;font-weight:600;">Carregando...</div>
                    </div>
                </div>
            </div>

            <!-- Scores Individuais -->
            <div class="stats-grid" style="grid-template-columns:repeat(5,1fr);">
                <div class="stat-card has-tooltip" id="cardRiskESG" style="border-top:4px solid #4CAF50;" title="Risco ESG: baseado no score medio TSB das empresas. Alto score TSB = baixo risco ESG. Peso: 25%">
                    <div class="label">Risco ESG</div>
                    <div class="value" id="riskESG">-</div>
                    <div id="riskESGLabel" style="font-size:0.75rem;color:#a0a0b0;">-</div>
                </div>
                <div class="stat-card has-tooltip" id="cardRiskCredito" style="border-top:4px solid #F44336;" title="Risco de Credito: baseado no spread medio das debentures. Taxa >6% = alto risco. Peso: 25%">
                    <div class="label">Risco Credito</div>
                    <div class="value" id="riskCredito">-</div>
                    <div id="riskCreditoLabel" style="font-size:0.75rem;color:#a0a0b0;">-</div>
                </div>
                <div class="stat-card has-tooltip" id="cardRiskConcentracao" style="border-top:4px solid #2196F3;" title="Risco de Concentracao: baseado no indice HHI. HHI>2500=alta concentracao. Peso: 15%">
                    <div class="label">Concentracao</div>
                    <div class="value" id="riskConcentracao">-</div>
                    <div id="riskConcentracaoLabel" style="font-size:0.75rem;color:#a0a0b0;">-</div>
                </div>
                <div class="stat-card has-tooltip" id="cardRiskLiquidez" style="border-top:4px solid #9C27B0;" title="Risco de Liquidez: baseado na duration media. Maior % em longo prazo = maior risco. Peso: 15%">
                    <div class="label">Risco Liquidez</div>
                    <div class="value" id="riskLiquidez">-</div>
                    <div id="riskLiquidezLabel" style="font-size:0.75rem;color:#a0a0b0;">-</div>
                </div>
                <div class="stat-card has-tooltip" id="cardRiskClima" style="border-top:4px solid #00BCD4;" title="Risco Climatico: baseado no % de empresas em transicao vs verde. Mais transicao = maior risco. Peso: 20%">
                    <div class="label">Risco Climatico</div>
                    <div class="value" id="riskClima">-</div>
                    <div id="riskClimaLabel" style="font-size:0.75rem;color:#a0a0b0;">-</div>
                </div>
            </div>

            <div class="grid-2">
                <!-- Grafico Radar de Riscos -->
                <div class="chart-card has-tooltip" title="Grafico radar mostrando o perfil de risco nas 5 dimensoes. Areas maiores indicam maior exposicao ao risco">
                    <h3>üéØ Perfil de Risco do Portfolio</h3>
                    <div class="chart-container" style="height:300px;"><canvas id="chartRiskRadar"></canvas></div>
                </div>
                <!-- Grafico de Spread por Indexador -->
                <div class="chart-card has-tooltip" title="Distribuicao das debentures por indexador (IPCA, DI, Pre) com quantidade e taxa media de cada grupo">
                    <h3>üìà Spread por Indexador</h3>
                    <div class="chart-container" style="height:300px;"><canvas id="chartSpreadIndexador"></canvas></div>
                </div>
            </div>

            <div class="grid-2">
                <!-- Concentracao por Setor -->
                <div class="chart-card has-tooltip" title="Distribuicao do portfolio por setor. HHI (Herfindahl-Hirschman Index): <1500=baixa, 1500-2500=moderada, >2500=alta concentracao">
                    <h3>üè≠ Concentracao por Setor (HHI: <span id="riskHHI" title="Indice Herfindahl-Hirschman: mede concentracao. Soma dos quadrados das participacoes">-</span>)</h3>
                    <div class="chart-container" style="height:280px;"><canvas id="chartConcentracao"></canvas></div>
                </div>
                <!-- Perfil de Liquidez -->
                <div class="chart-card has-tooltip" title="Distribuicao dos titulos por prazo: Curto (<1 ano), Medio (1-3 anos), Longo (>3 anos). Afeta o risco de liquidez">
                    <h3>üíß Perfil de Liquidez (Duration)</h3>
                    <div class="chart-container" style="height:280px;"><canvas id="chartLiquidez"></canvas></div>
                </div>
            </div>

            <!-- Metricas Detalhadas -->
            <div class="stats-grid" style="grid-template-columns:repeat(4,1fr);">
                <div class="stat-card has-tooltip" title="Numero total de ativos no portfolio: fundos + debentures + CRI/CRA + titulos publicos">
                    <div class="label">Total Ativos</div>
                    <div class="value text-primary" id="riskTotalAtivos">-</div>
                </div>
                <div class="stat-card has-tooltip" title="Quantidade de debentures corporativas na carteira">
                    <div class="label">Debentures</div>
                    <div class="value text-info" id="riskTotalDebentures">-</div>
                </div>
                <div class="stat-card has-tooltip" title="Taxa indicativa media das debentures (spread sobre o indexador)">
                    <div class="label">Taxa Media</div>
                    <div class="value text-accent" id="riskTaxaMedia">-</div>
                </div>
                <div class="stat-card has-tooltip" title="Duration media ponderada da carteira de titulos (em dias)">
                    <div class="label">Duration Media</div>
                    <div class="value text-secondary" id="riskDurationMedia">-</div>
                </div>
            </div>

            <div class="grid-2">
                <!-- Empresas com Maior Risco -->
                <div class="chart-card has-tooltip" title="Empresas com menores scores TSB - maior exposicao a riscos ESG e climaticos">
                    <h3 style="color:#F44336;">‚ö†Ô∏è Empresas com Maior Risco ESG</h3>
                    <div style="overflow-x:auto;max-height:300px;">
                        <table>
                            <thead><tr><th>Empresa</th><th>Setor</th><th>Classificacao</th><th>Score</th></tr></thead>
                            <tbody id="corpoEmpresasRisco"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Top Emissores -->
                <div class="chart-card has-tooltip" title="Maiores emissores de debentures por quantidade de titulos e taxa indicativa media">
                    <h3 style="color:#2196F3;">üè¢ Top Emissores de Debentures</h3>
                    <div style="overflow-x:auto;max-height:300px;">
                        <table>
                            <thead><tr><th title="Nome da empresa emissora">Emissor</th><th title="Quantidade de debentures emitidas">Qtd</th><th title="Taxa indicativa media (spread sobre indexador)">Taxa Media</th></tr></thead>
                            <tbody id="corpoTopEmissores"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Legenda de Ratings -->
            <div class="chart-card has-tooltip" style="margin-top:20px;" title="Escala de classificacao de risco: A (melhor) a E (pior). Baseado em metodologia interna">
                <h3>üìã Escala de Rating de Risco</h3>
                <div style="display:flex;gap:20px;flex-wrap:wrap;margin-top:15px;">
                    <div style="display:flex;align-items:center;gap:10px;padding:10px 20px;background:rgba(76,175,80,0.2);border-radius:8px;">
                        <span style="font-size:1.5rem;font-weight:700;color:#4CAF50;">A</span>
                        <div><div style="font-weight:600;color:#4CAF50;">Muito Baixo</div><div style="font-size:0.75rem;color:#a0a0b0;">0-20 pontos</div></div>
                    </div>
                    <div style="display:flex;align-items:center;gap:10px;padding:10px 20px;background:rgba(139,195,74,0.2);border-radius:8px;">
                        <span style="font-size:1.5rem;font-weight:700;color:#8BC34A;">B</span>
                        <div><div style="font-weight:600;color:#8BC34A;">Baixo</div><div style="font-size:0.75rem;color:#a0a0b0;">21-40 pontos</div></div>
                    </div>
                    <div style="display:flex;align-items:center;gap:10px;padding:10px 20px;background:rgba(255,193,7,0.2);border-radius:8px;">
                        <span style="font-size:1.5rem;font-weight:700;color:#FFC107;">C</span>
                        <div><div style="font-weight:600;color:#FFC107;">Moderado</div><div style="font-size:0.75rem;color:#a0a0b0;">41-60 pontos</div></div>
                    </div>
                    <div style="display:flex;align-items:center;gap:10px;padding:10px 20px;background:rgba(255,152,0,0.2);border-radius:8px;">
                        <span style="font-size:1.5rem;font-weight:700;color:#FF9800;">D</span>
                        <div><div style="font-weight:600;color:#FF9800;">Alto</div><div style="font-size:0.75rem;color:#a0a0b0;">61-80 pontos</div></div>
                    </div>
                    <div style="display:flex;align-items:center;gap:10px;padding:10px 20px;background:rgba(244,67,54,0.2);border-radius:8px;">
                        <span style="font-size:1.5rem;font-weight:700;color:#F44336;">E</span>
                        <div><div style="font-weight:600;color:#F44336;">Muito Alto</div><div style="font-size:0.75rem;color:#a0a0b0;">81-100 pontos</div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Early Warning -->
        <div id="early-warning" class="tab-content">
            <div class="chart-card has-tooltip" style="background:linear-gradient(135deg,rgba(255,152,0,0.15) 0%,rgba(244,67,54,0.15) 100%);border-color:rgba(255,152,0,0.3);margin-bottom:20px;" title="Sistema de alertas antecipados para identificar riscos potenciais no portfolio">
                <div style="display:flex;align-items:center;gap:20px;">
                    <div style="font-size:3rem;">‚ö†Ô∏è</div>
                    <div style="flex:1;">
                        <h2 style="color:#FFB74D;margin:0;">Early Warning - Sistema de Alertas</h2>
                        <p style="color:#FFCC80;margin-top:8px;">Monitoramento de riscos baseado em dados reais do portfolio</p>
                    </div>
                    <div id="ewResumo" style="display:flex;gap:15px;">
                        <div style="text-align:center;padding:10px 15px;border-radius:8px;background:rgba(244,67,54,0.2);">
                            <div style="font-size:1.5rem;font-weight:700;color:#F44336;" id="ewCriticos">-</div>
                            <div style="font-size:0.7rem;color:#EF9A9A;">Cr√≠ticos</div>
                        </div>
                        <div style="text-align:center;padding:10px 15px;border-radius:8px;background:rgba(255,152,0,0.2);">
                            <div style="font-size:1.5rem;font-weight:700;color:#FF9800;" id="ewMedios">-</div>
                            <div style="font-size:0.7rem;color:#FFCC80;">M√©dios</div>
                        </div>
                        <div style="text-align:center;padding:10px 15px;border-radius:8px;background:rgba(76,175,80,0.2);">
                            <div style="font-size:1.5rem;font-weight:700;color:#4CAF50;" id="ewBaixos">-</div>
                            <div style="font-size:0.7rem;color:#A5D6A7;">Baixos</div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="ewAlertasContainer" style="display:flex;flex-direction:column;gap:15px;">
                <div style="text-align:center;padding:40px;color:var(--text-secondary);">
                    <div style="font-size:2rem;margin-bottom:10px;">‚è≥</div>
                    <p>Carregando alertas...</p>
                </div>
            </div>
        </div>

        <!-- TAB: Debt Analysis -->
        <div id="debt-analysis" class="tab-content">
            <div class="chart-card has-tooltip" style="background:linear-gradient(135deg,rgba(33,150,243,0.15) 0%,rgba(156,39,176,0.15) 100%);border-color:rgba(33,150,243,0.3);margin-bottom:20px;" title="Analise da estrutura de divida corporativa">
                <div style="display:flex;align-items:center;gap:20px;">
                    <div style="font-size:3rem;">üìà</div>
                    <div style="flex:1;">
                        <h2 style="color:#42A5F5;margin:0;">An√°lise de D√≠vida Corporativa</h2>
                        <p style="color:#90CAF9;margin-top:8px;">Estrutura, composi√ß√£o e m√©tricas das deb√™ntures</p>
                    </div>
                </div>
            </div>
            <div class="stats-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:20px;">
                <div class="stat-card has-tooltip" title="Quantidade total de debentures na carteira"><div class="label">Total Deb√™ntures</div><div class="value text-primary" id="debtTotal">-</div></div>
                <div class="stat-card has-tooltip" title="Soma dos precos unitarios de todas as debentures"><div class="label">Valor Total (PU)</div><div class="value text-accent" id="debtValorTotal">-</div></div>
                <div class="stat-card has-tooltip" title="Preco unitario medio das debentures"><div class="label">PU M√©dio</div><div class="value text-info" id="debtPUMedio">-</div></div>
                <div class="stat-card has-tooltip" title="Duration media ponderada da carteira"><div class="label">Duration M√©dia</div><div class="value text-secondary" id="debtDurationMedia">-</div></div>
            </div>
            <div class="grid-2" style="margin-bottom:20px;">
                <div class="chart-card has-tooltip" title="Distribuicao das debentures por tipo de indexador">
                    <h3>üìä Por Indexador</h3>
                    <div class="chart-container" style="height:250px;"><canvas id="chartDebtIndexador"></canvas></div>
                </div>
                <div class="chart-card has-tooltip" title="Distribuicao das debentures por faixa de taxa">
                    <h3>üìâ Por Faixa de Taxa</h3>
                    <div class="chart-container" style="height:250px;"><canvas id="chartDebtTaxa"></canvas></div>
                </div>
            </div>
            <div class="chart-card has-tooltip" title="Maiores emissores de debentures por valor">
                <h3>üè¢ Top 10 Emissores por Valor</h3>
                <div style="overflow-x:auto;max-height:350px;">
                    <table>
                        <thead><tr><th>Emissor</th><th>Qtd T√≠tulos</th><th>Valor Total</th><th>Taxa M√©dia</th></tr></thead>
                        <tbody id="debtTopEmissores"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: Vencimentos -->
        <div id="vencimentos" class="tab-content">
            <div class="chart-card has-tooltip" style="background:linear-gradient(135deg,rgba(255,152,0,0.15) 0%,rgba(244,67,54,0.15) 100%);border-color:rgba(255,152,0,0.3);margin-bottom:20px;" title="Calendario de vencimentos dos titulos">
                <div style="display:flex;align-items:center;gap:20px;">
                    <div style="font-size:3rem;">üìÖ</div>
                    <div style="flex:1;">
                        <h2 style="color:#FFB74D;margin:0;">Calend√°rio de Vencimentos</h2>
                        <p style="color:#FFCC80;margin-top:8px;">Distribui√ß√£o temporal dos t√≠tulos por duration</p>
                    </div>
                    <div style="display:flex;gap:15px;">
                        <div style="text-align:center;padding:10px 15px;border-radius:8px;background:rgba(76,175,80,0.2);">
                            <div style="font-size:1.2rem;font-weight:700;color:#66BB6A;" id="vencDurationMin">-</div>
                            <div style="font-size:0.7rem;color:#A5D6A7;">M√≠n (dias)</div>
                        </div>
                        <div style="text-align:center;padding:10px 15px;border-radius:8px;background:rgba(255,152,0,0.2);">
                            <div style="font-size:1.2rem;font-weight:700;color:#FFB74D;" id="vencDurationMedia">-</div>
                            <div style="font-size:0.7rem;color:#FFCC80;">M√©dia (dias)</div>
                        </div>
                        <div style="text-align:center;padding:10px 15px;border-radius:8px;background:rgba(244,67,54,0.2);">
                            <div style="font-size:1.2rem;font-weight:700;color:#EF5350;" id="vencDurationMax">-</div>
                            <div style="font-size:0.7rem;color:#EF9A9A;">M√°x (dias)</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid-2" style="margin-bottom:20px;">
                <div class="chart-card has-tooltip" title="Quantidade de titulos por faixa de vencimento">
                    <h3>üìä Distribui√ß√£o por Prazo</h3>
                    <div class="chart-container" style="height:280px;"><canvas id="chartVencFaixa"></canvas></div>
                </div>
                <div class="chart-card has-tooltip" title="Valor total por faixa de vencimento">
                    <h3>üí∞ Valor por Prazo</h3>
                    <div class="chart-container" style="height:280px;"><canvas id="chartVencValor"></canvas></div>
                </div>
            </div>
            <div class="chart-card has-tooltip" title="Titulos com vencimento mais proximo">
                <h3 style="color:#FFB74D;">‚è∞ Pr√≥ximos Vencimentos (menor duration)</h3>
                <div style="overflow-x:auto;max-height:400px;">
                    <table>
                        <thead><tr><th>C√≥digo</th><th>Emissor</th><th>Indexador</th><th>Taxa</th><th>Duration</th><th>PU</th></tr></thead>
                        <tbody id="vencProximos"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: Emissores -->
        <div id="emissores" class="tab-content">
            <div class="chart-card has-tooltip" style="background:linear-gradient(135deg,rgba(33,150,243,0.15) 0%,rgba(76,175,80,0.15) 100%);border-color:rgba(33,150,243,0.3);margin-bottom:20px;" title="Painel de emissores de titulos de divida corporativa">
                <div style="display:flex;align-items:center;gap:20px;">
                    <div style="font-size:3rem;">üè¢</div>
                    <div>
                        <h2 style="color:#42A5F5;margin:0;">Emissores - Empresas de Capital Aberto</h2>
                        <p style="color:#90CAF9;margin-top:8px;">Dados de governanca, demonstracoes financeiras e classificacao TSB</p>
                        <span id="emissoresBadge" class="badge" style="background:#2196F3;">Carregando...</span>
                    </div>
                </div>
            </div>

            <!-- Estatisticas -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px;">
                <div class="stat-card has-tooltip" style="background:linear-gradient(135deg,rgba(76,175,80,0.2),rgba(76,175,80,0.05));" title="Total de empresas mapeadas na Taxonomia Sustentavel Brasileira">
                    <div style="font-size:2rem;font-weight:700;color:#66BB6A;" id="statEmissoresTotal">--</div>
                    <div style="color:#a0a0b0;font-size:0.85rem;">Total Empresas TSB</div>
                </div>
                <div class="stat-card has-tooltip" style="background:linear-gradient(135deg,rgba(76,175,80,0.2),rgba(76,175,80,0.05));" title="Empresas com classificacao VERDE: atividades economicas sustentaveis">
                    <div style="font-size:2rem;font-weight:700;color:#4CAF50;" id="statEmissoresVerde">--</div>
                    <div style="color:#a0a0b0;font-size:0.85rem;">Classificacao Verde</div>
                </div>
                <div class="stat-card has-tooltip" style="background:linear-gradient(135deg,rgba(255,152,0,0.2),rgba(255,152,0,0.05));" title="Empresas em TRANSICAO: em processo de transicao para economia verde">
                    <div style="font-size:2rem;font-weight:700;color:#FFB74D;" id="statEmissoresTransicao">--</div>
                    <div style="color:#a0a0b0;font-size:0.85rem;">Em Transicao</div>
                </div>
                <div class="stat-card has-tooltip" style="background:linear-gradient(135deg,rgba(33,150,243,0.2),rgba(33,150,243,0.05));" title="Score medio de sustentabilidade das empresas (0-100)">
                    <div style="font-size:2rem;font-weight:700;color:#42A5F5;" id="statEmissoresScore">--</div>
                    <div style="color:#a0a0b0;font-size:0.85rem;">Score Medio</div>
                </div>
            </div>

            <!-- Filtros e Busca -->
            <div class="chart-card has-tooltip" style="margin-bottom:20px;" title="Filtros para busca de emissores">
                <div style="display:flex;gap:15px;flex-wrap:wrap;align-items:center;">
                    <input type="text" id="searchEmissores" placeholder="Buscar empresa..."
                        style="flex:1;min-width:200px;padding:12px 15px;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:0.95rem;" title="Digite nome da empresa para pesquisar">
                    <select id="filtroSetorEmissores" style="padding:12px 15px;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);" title="Filtrar por setor economico">
                        <option value="">Todos os Setores</option>
                        <option value="Eletricidade">Eletricidade</option>
                        <option value="Servicos Financeiros">Servicos Financeiros</option>
                        <option value="Energia">Energia</option>
                        <option value="Mineracao">Mineracao</option>
                        <option value="Papel e Celulose">Papel e Celulose</option>
                        <option value="Agua e Esgoto">Agua e Esgoto</option>
                        <option value="Bens Industriais">Bens Industriais</option>
                    </select>
                    <select id="filtroClassEmissores" style="padding:12px 15px;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);" title="Filtrar por classificacao TSB: Verde ou Transicao">
                        <option value="">Todas Classificacoes</option>
                        <option value="VERDE">Verde</option>
                        <option value="TRANSICAO">Transicao</option>
                    </select>
                    <button onclick="carregarEmissores()" style="padding:12px 20px;background:#2196F3;border:none;border-radius:8px;color:white;cursor:pointer;font-weight:600;" title="Executar busca com os filtros selecionados">Buscar</button>
                </div>
            </div>

            <!-- Tabela de Emissores -->
            <div class="chart-card has-tooltip" title="Lista de empresas emissoras de titulos de divida">
                <h3 style="margin-bottom:15px;">üìã Lista de Emissores</h3>
                <div style="overflow-x:auto;">
                    <table id="tabelaEmissores" style="width:100%;">
                        <thead>
                            <tr>
                                <th title="Razao social da empresa">Empresa</th>
                                <th title="CNPJ da empresa">CNPJ</th>
                                <th title="Setor economico conforme classificacao TSB">Setor</th>
                                <th title="VERDE = atividades sustentaveis, TRANSICAO = em processo">Classificacao</th>
                                <th title="Score de sustentabilidade (0-100)">Score</th>
                                <th title="Quantidade de titulos emitidos">Titulos</th>
                                <th title="Acoes disponiveis: ver detalhes, investimentos">Acoes</th>
                            </tr>
                        </thead>
                        <tbody id="corpoTabelaEmissores">
                            <tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-secondary);">Carregando emissores...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Graficos -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px;margin-top:20px;">
                <div class="chart-card has-tooltip" title="Distribuicao dos emissores por setor economico">
                    <h3>üìä Distribuicao por Setor</h3>
                    <div class="chart-container" style="height:300px;"><canvas id="chartEmissoresSetor"></canvas></div>
                </div>
                <div class="chart-card has-tooltip" title="Distribuicao dos emissores por classificacao TSB: Verde ou Transicao">
                    <h3>üåø Classificacao TSB</h3>
                    <div class="chart-container" style="height:300px;"><canvas id="chartEmissoresClass"></canvas></div>
                </div>
            </div>
        </div>

        <!-- TAB: CVM Consolidado -->
        <div id="cvm-consolidado" class="tab-content">
            <div class="chart-card has-tooltip" style="background:linear-gradient(135deg,rgba(0,188,212,0.15) 0%,rgba(156,39,176,0.15) 100%);border-color:rgba(0,188,212,0.3);margin-bottom:20px;" title="Fundos consolidados de ANBIMA e CVM">
                <div style="display:flex;align-items:center;gap:20px;">
                    <div style="font-size:3rem;">üîó</div>
                    <div>
                        <h2 style="color:#4DD0E1;margin:0;">Fundos Consolidados ANBIMA + CVM</h2>
                        <p style="color:#80DEEA;margin-top:8px;">Dados cruzados de 123.732 fundos unificando ANBIMA Data e CVM</p>
                        <span id="cvmConsolidadoBadge" class="badge" style="background:#00BCD4;">Carregando...</span>
                    </div>
                </div>
            </div>

            <!-- Estatisticas -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:20px;">
                <div class="stat-card has-tooltip" style="background:linear-gradient(135deg,rgba(0,188,212,0.2),rgba(0,188,212,0.05));" title="Total de fundos consolidados de ambas as fontes">
                    <div style="font-size:2rem;font-weight:700;color:#4DD0E1;" id="statConsolidadoTotal">--</div>
                    <div style="color:#a0a0b0;font-size:0.85rem;">Total Consolidado</div>
                </div>
                <div class="stat-card has-tooltip" style="background:linear-gradient(135deg,rgba(25,118,210,0.2),rgba(25,118,210,0.05));" title="Fundos vindos da ANBIMA Data">
                    <div style="font-size:2rem;font-weight:700;color:#42A5F5;" id="statConsolidadoAnbima">--</div>
                    <div style="color:#a0a0b0;font-size:0.85rem;">Fonte ANBIMA</div>
                </div>
                <div class="stat-card has-tooltip" style="background:linear-gradient(135deg,rgba(156,39,176,0.2),rgba(156,39,176,0.05));" title="Fundos exclusivos da CVM (nao estao na ANBIMA)">
                    <div style="font-size:2rem;font-weight:700;color:#CE93D8;" id="statConsolidadoCVM">--</div>
                    <div style="color:#a0a0b0;font-size:0.85rem;">Exclusivos CVM</div>
                </div>
                <div class="stat-card has-tooltip" style="background:linear-gradient(135deg,rgba(76,175,80,0.2),rgba(76,175,80,0.05));" title="Fundos ANBIMA que possuem dados cruzados com CVM">
                    <div style="font-size:2rem;font-weight:700;color:#66BB6A;" id="statConsolidadoCruzado">--</div>
                    <div style="color:#a0a0b0;font-size:0.85rem;">Cruzamento</div>
                </div>
                <div class="stat-card has-tooltip" style="background:linear-gradient(135deg,rgba(255,152,0,0.2),rgba(255,152,0,0.05));" title="Fundos com classificacao ESG">
                    <div style="font-size:2rem;font-weight:700;color:#FFB74D;" id="statConsolidadoESG">--</div>
                    <div style="color:#a0a0b0;font-size:0.85rem;">Fundos ESG</div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="chart-card has-tooltip" style="margin-bottom:20px;" title="Filtros para busca de fundos consolidados">
                <div style="display:flex;gap:15px;flex-wrap:wrap;align-items:center;">
                    <input type="text" id="searchConsolidado" placeholder="Buscar por nome ou CNPJ..."
                        style="flex:1;min-width:200px;padding:12px 15px;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:0.95rem;">
                    <select id="filtroFonteConsolidado" style="padding:12px 15px;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);">
                        <option value="">Todas as Fontes</option>
                        <option value="ANBIMA">ANBIMA</option>
                        <option value="CVM">CVM</option>
                    </select>
                    <select id="filtroClasseCVMConsolidado" style="padding:12px 15px;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);">
                        <option value="">Todas as Classes CVM</option>
                    </select>
                    <label style="display:flex;align-items:center;gap:5px;color:var(--text-secondary);font-size:0.85rem;">
                        <input type="checkbox" id="filtroESGConsolidado"> Apenas ESG
                    </label>
                    <label style="display:flex;align-items:center;gap:5px;color:var(--text-secondary);font-size:0.85rem;">
                        <input type="checkbox" id="filtroCruzadoConsolidado"> Com dados CVM
                    </label>
                    <button onclick="carregarConsolidado()" style="padding:12px 20px;background:#00BCD4;border:none;border-radius:8px;color:white;cursor:pointer;font-weight:600;">Buscar</button>
                </div>
            </div>

            <!-- Tabela -->
            <div class="chart-card has-tooltip" title="Lista de fundos consolidados">
                <h3 style="margin-bottom:15px;">üìã Fundos Consolidados</h3>
                <div style="overflow-x:auto;">
                    <table id="tabelaConsolidado" style="width:100%;">
                        <thead>
                            <tr>
                                <th>Fonte</th>
                                <th>Nome</th>
                                <th>CNPJ</th>
                                <th>Categoria</th>
                                <th>Classe CVM</th>
                                <th>PL</th>
                                <th>Cotistas</th>
                                <th>ESG</th>
                            </tr>
                        </thead>
                        <tbody id="corpoTabelaConsolidado">
                            <tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-secondary);">Carregando fundos consolidados...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="paginacaoConsolidado" style="display:flex;justify-content:center;gap:10px;margin-top:15px;"></div>
            </div>
        </div>

        <!-- TAB: CVM Cadastro -->
        <div id="cvm-cadastro" class="tab-content">
            <div class="chart-card has-tooltip" style="background:linear-gradient(135deg,rgba(103,58,183,0.15) 0%,rgba(33,150,243,0.15) 100%);border-color:rgba(103,58,183,0.3);margin-bottom:20px;" title="Cadastro oficial de fundos da CVM">
                <div style="display:flex;align-items:center;gap:20px;">
                    <div style="font-size:3rem;">üìã</div>
                    <div>
                        <h2 style="color:#B39DDB;margin:0;">Cadastro de Fundos CVM</h2>
                        <p style="color:#9575CD;margin-top:8px;">41.121 fundos registrados na Comissao de Valores Mobiliarios</p>
                        <span id="cvmCadastroBadge" class="badge" style="background:#673AB7;">Carregando...</span>
                    </div>
                </div>
            </div>

            <!-- Estatisticas -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:20px;">
                <div class="stat-card has-tooltip" style="background:linear-gradient(135deg,rgba(103,58,183,0.2),rgba(103,58,183,0.05));" title="Total de fundos cadastrados na CVM">
                    <div style="font-size:2rem;font-weight:700;color:#B39DDB;" id="statCadastroTotal">--</div>
                    <div style="color:#a0a0b0;font-size:0.85rem;">Total Cadastro</div>
                </div>
                <div class="stat-card has-tooltip" style="background:linear-gradient(135deg,rgba(76,175,80,0.2),rgba(76,175,80,0.05));" title="Fundos em funcionamento normal">
                    <div style="font-size:2rem;font-weight:700;color:#66BB6A;" id="statCadastroAtivos">--</div>
                    <div style="color:#a0a0b0;font-size:0.85rem;">Em Funcionamento</div>
                </div>
                <div class="stat-card has-tooltip" style="background:linear-gradient(135deg,rgba(33,150,243,0.2),rgba(33,150,243,0.05));" title="Numero de classes distintas">
                    <div style="font-size:2rem;font-weight:700;color:#42A5F5;" id="statCadastroClasses">--</div>
                    <div style="color:#a0a0b0;font-size:0.85rem;">Classes Distintas</div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="chart-card has-tooltip" style="margin-bottom:20px;" title="Filtros para busca de fundos no cadastro CVM">
                <div style="display:flex;gap:15px;flex-wrap:wrap;align-items:center;">
                    <input type="text" id="searchCadastro" placeholder="Buscar por nome ou CNPJ..."
                        style="flex:1;min-width:200px;padding:12px 15px;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:0.95rem;">
                    <select id="filtroSituacaoCadastro" style="padding:12px 15px;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);">
                        <option value="">Todas as Situacoes</option>
                    </select>
                    <select id="filtroClasseCadastro" style="padding:12px 15px;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);">
                        <option value="">Todas as Classes</option>
                    </select>
                    <button onclick="carregarCadastroCVM()" style="padding:12px 20px;background:#673AB7;border:none;border-radius:8px;color:white;cursor:pointer;font-weight:600;">Buscar</button>
                </div>
            </div>

            <!-- Tabela -->
            <div class="chart-card has-tooltip" title="Lista de fundos do cadastro CVM">
                <h3 style="margin-bottom:15px;">üìã Cadastro de Fundos</h3>
                <div style="overflow-x:auto;">
                    <table id="tabelaCadastroCVM" style="width:100%;">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>CNPJ</th>
                                <th>Situacao</th>
                                <th>Classe</th>
                                <th>Data Registro</th>
                                <th>Administrador</th>
                                <th>Gestor</th>
                            </tr>
                        </thead>
                        <tbody id="corpoTabelaCadastroCVM">
                            <tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-secondary);">Carregando cadastro CVM...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="paginacaoCadastro" style="display:flex;justify-content:center;gap:10px;margin-top:15px;"></div>
            </div>
        </div>

        <!-- TAB: CVM Informes -->
        <div id="cvm-informes" class="tab-content">
            <div class="chart-card has-tooltip" style="background:linear-gradient(135deg,rgba(255,87,34,0.15) 0%,rgba(255,152,0,0.15) 100%);border-color:rgba(255,87,34,0.3);margin-bottom:20px;" title="Informes diarios de fundos da CVM">
                <div style="display:flex;align-items:center;gap:20px;">
                    <div style="font-size:3rem;">üìä</div>
                    <div>
                        <h2 style="color:#FFAB91;margin:0;">Informes Diarios CVM</h2>
                        <p style="color:#FF8A65;margin-top:8px;">Patrimonio liquido, cotistas, captacao e resgates diarios</p>
                        <span id="cvmInformesBadge" class="badge" style="background:#FF5722;">Carregando...</span>
                    </div>
                </div>
            </div>

            <!-- Estatisticas -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:20px;">
                <div class="stat-card has-tooltip" style="background:linear-gradient(135deg,rgba(255,87,34,0.2),rgba(255,87,34,0.05));" title="Total de registros de informes">
                    <div style="font-size:2rem;font-weight:700;color:#FFAB91;" id="statInformesTotal">--</div>
                    <div style="color:#a0a0b0;font-size:0.85rem;">Total Registros</div>
                </div>
                <div class="stat-card has-tooltip" style="background:linear-gradient(135deg,rgba(76,175,80,0.2),rgba(76,175,80,0.05));" title="Fundos unicos com informes">
                    <div style="font-size:2rem;font-weight:700;color:#66BB6A;" id="statInformesFundos">--</div>
                    <div style="color:#a0a0b0;font-size:0.85rem;">Fundos Unicos</div>
                </div>
                <div class="stat-card has-tooltip" style="background:linear-gradient(135deg,rgba(33,150,243,0.2),rgba(33,150,243,0.05));" title="Patrimonio liquido total">
                    <div style="font-size:1.6rem;font-weight:700;color:#42A5F5;" id="statInformesPL">--</div>
                    <div style="color:#a0a0b0;font-size:0.85rem;">PL Total</div>
                </div>
                <div class="stat-card has-tooltip" style="background:linear-gradient(135deg,rgba(255,152,0,0.2),rgba(255,152,0,0.05));" title="Total de cotistas">
                    <div style="font-size:1.6rem;font-weight:700;color:#FFB74D;" id="statInformesCotistas">--</div>
                    <div style="color:#a0a0b0;font-size:0.85rem;">Cotistas Total</div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="chart-card has-tooltip" style="margin-bottom:20px;" title="Filtros para busca de informes diarios">
                <div style="display:flex;gap:15px;flex-wrap:wrap;align-items:center;">
                    <input type="text" id="searchInformes" placeholder="Buscar por CNPJ..."
                        style="flex:1;min-width:200px;padding:12px 15px;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:0.95rem;">
                    <select id="filtroPeriodoInformes" style="padding:12px 15px;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);">
                        <option value="">Todos os Periodos</option>
                    </select>
                    <button onclick="carregarInformesCVM()" style="padding:12px 20px;background:#FF5722;border:none;border-radius:8px;color:white;cursor:pointer;font-weight:600;">Buscar</button>
                </div>
            </div>

            <!-- Tabela -->
            <div class="chart-card has-tooltip" title="Lista de informes diarios">
                <h3 style="margin-bottom:15px;">üìã Informes Diarios</h3>
                <div style="overflow-x:auto;">
                    <table id="tabelaInformesCVM" style="width:100%;">
                        <thead>
                            <tr>
                                <th>CNPJ</th>
                                <th>Data</th>
                                <th>PL</th>
                                <th>Valor Cota</th>
                                <th>Cotistas</th>
                                <th>Captacao</th>
                                <th>Resgate</th>
                            </tr>
                        </thead>
                        <tbody id="corpoTabelaInformesCVM">
                            <tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-secondary);">Carregando informes CVM...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="paginacaoInformes" style="display:flex;justify-content:center;gap:10px;margin-top:15px;"></div>
            </div>
        </div>

        <!-- TAB: Consulta IA -->
        <div id="ai-consulta" class="tab-content">
            <div class="chart-card has-tooltip" style="background:linear-gradient(135deg,rgba(156,39,176,0.15) 0%,rgba(25,118,210,0.15) 100%);border-color:rgba(156,39,176,0.3);margin-bottom:20px;" title="Assistente de IA para analise de investimentos e geracao de relatorios">
                <div style="display:flex;align-items:center;gap:20px;">
                    <div style="font-size:3rem;">ü§ñ</div>
                    <div>
                        <h2 style="color:#CE93D8;margin:0;">Assistente de Inteligencia Artificial</h2>
                        <p style="color:#B39DDB;margin-top:8px;">Gere relatorios, crie views personalizadas, receba dicas e analises inteligentes</p>
                        <span id="aiStatusBadge" class="badge" style="background:#9C27B0;">IA Pronta</span>
                    </div>
                </div>
            </div>

            <!-- Sugestoes Rapidas -->
            <div class="chart-card has-tooltip" style="margin-bottom:20px;" title="Clique em uma sugestao para iniciar uma consulta rapidamente">
                <h3 style="margin-bottom:15px;">‚ö° Sugestoes Rapidas</h3>
                <div style="display:flex;flex-wrap:wrap;gap:10px;">
                    <button onclick="usarSugestao('Gere um relatorio dos fundos ESG com melhor performance')" class="ai-suggestion-btn" title="Gerar relatorio com os melhores fundos ESG">üìä Relatorio Fundos ESG</button>
                    <button onclick="usarSugestao('Analise o risco das debentures com maior duration')" class="ai-suggestion-btn" title="Analisar risco de debentures de longo prazo">üìà Analise de Risco</button>
                    <button onclick="usarSugestao('Crie uma view comparando titulos publicos por rentabilidade')" class="ai-suggestion-btn" title="Comparar titulos publicos por rentabilidade">üèõÔ∏è View Titulos Publicos</button>
                    <button onclick="usarSugestao('Quais empresas TSB tem melhor classificacao?')" class="ai-suggestion-btn" title="Ver ranking de empresas na Taxonomia Sustentavel Brasileira">üåø Ranking TSB</button>
                    <button onclick="usarSugestao('De dicas de diversificacao para meu portfolio')" class="ai-suggestion-btn" title="Obter sugestoes de diversificacao de carteira">üí° Dicas Portfolio</button>
                    <button onclick="usarSugestao('Resuma os principais indicadores do mercado')" class="ai-suggestion-btn" title="Ver resumo dos indicadores de mercado">üìã Resumo do Mercado</button>
                </div>
            </div>

            <!-- Area de Chat -->
            <div class="chart-card has-tooltip" title="Area de conversa com o assistente de IA">
                <h3 style="margin-bottom:15px;">üí¨ Consulta</h3>

                <!-- Historico de Mensagens -->
                <div id="aiChatHistory" style="min-height:300px;max-height:500px;overflow-y:auto;background:var(--bg-dark);border-radius:10px;padding:15px;margin-bottom:15px;border:1px solid var(--border-color);" title="Historico da conversa com a IA">
                    <div class="ai-message ai-assistant">
                        <div class="ai-avatar">ü§ñ</div>
                        <div class="ai-content">
                            <p>Ola! Sou seu assistente de inteligencia artificial para analise de titulos e fundos. Posso ajudar voce a:</p>
                            <ul style="margin:10px 0;padding-left:20px;">
                                <li><strong>Gerar relatorios</strong> personalizados sobre fundos, debentures e titulos</li>
                                <li><strong>Criar views</strong> customizadas para visualizar dados especificos</li>
                                <li><strong>Fornecer dicas</strong> de investimento baseadas em analises</li>
                                <li><strong>Analisar riscos</strong> e oportunidades do mercado</li>
                            </ul>
                            <p>Como posso ajudar?</p>
                        </div>
                    </div>
                </div>

                <!-- Input de Mensagem -->
                <div style="display:flex;gap:10px;">
                    <input type="text" id="aiUserInput" placeholder="Digite sua pergunta ou comando..."
                        style="flex:1;padding:15px;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:10px;color:var(--text-primary);font-size:0.95rem;"
                        onkeypress="if(event.key==='Enter')enviarMensagemIA()" title="Digite sua pergunta para a IA e pressione Enter ou clique em Enviar">
                    <button onclick="enviarMensagemIA()" id="aiSendBtn" style="padding:15px 25px;background:linear-gradient(135deg,#9C27B0 0%,#1976D2 100%);border:none;border-radius:10px;color:white;cursor:pointer;font-weight:600;font-size:0.95rem;display:flex;align-items:center;gap:8px;" title="Enviar mensagem para a IA">
                        <span>Enviar</span>
                        <span style="font-size:1.2rem;">‚û§</span>
                    </button>
                </div>

                <!-- Opcoes Avancadas -->
                <div style="margin-top:15px;padding-top:15px;border-top:1px solid var(--border-color);">
                    <div style="display:flex;flex-wrap:wrap;gap:15px;align-items:center;">
                        <label style="color:var(--text-secondary);font-size:0.85rem;display:flex;align-items:center;gap:8px;">
                            <span>Tipo de resposta:</span>
                            <select id="aiResponseType" style="padding:8px 12px;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary);" title="Escolha o formato da resposta: texto, tabela, grafico ou relatorio completo">
                                <option value="texto">Texto</option>
                                <option value="tabela">Tabela</option>
                                <option value="grafico">Grafico</option>
                                <option value="relatorio">Relatorio Completo</option>
                            </select>
                        </label>
                        <label style="color:var(--text-secondary);font-size:0.85rem;display:flex;align-items:center;gap:8px;">
                            <span>Contexto:</span>
                            <select id="aiContext" style="padding:8px 12px;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary);" title="Escolha o contexto de dados para a consulta">
                                <option value="todos">Todos os Dados</option>
                                <option value="fundos">Fundos</option>
                                <option value="debentures">Debentures</option>
                                <option value="titulos">Titulos Publicos</option>
                                <option value="tsb">TSB</option>
                                <option value="cricra">CRI/CRA</option>
                            </select>
                        </label>
                        <button onclick="limparHistoricoIA()" style="margin-left:auto;padding:8px 15px;background:rgba(244,67,54,0.15);border:1px solid rgba(244,67,54,0.3);border-radius:6px;color:#EF5350;cursor:pointer;font-size:0.85rem;" title="Limpar todo o historico de conversa">
                            üóëÔ∏è Limpar Historico
                        </button>
                    </div>
                </div>
            </div>

            <!-- Resultados da IA -->
            <div id="aiResultsContainer" style="display:none;margin-top:20px;">
                <div class="chart-card" title="Resultados gerados pela IA">
                    <h3 id="aiResultsTitle" style="margin-bottom:15px;">üìä Resultado da Analise</h3>
                    <div id="aiResultsContent"></div>
                </div>
            </div>
        </div>

        <!-- TAB: ANBIMA Fundos -->
        <div id="anbima-fundos" class="tab-content">
            <div class="chart-card">
                <h3>üìà Fundos ANBIMA - Base Completa</h3>
                <p style="color:var(--text-secondary);margin-bottom:15px;">40.332 fundos com caracteristicas, categorias e classificacao ESG</p>

                <!-- Estatisticas -->
                <div class="stats-grid" style="margin-bottom:20px;">
                    <div class="stat-card"><div class="label">Total Fundos</div><div class="value text-primary" id="statAnbimaFundos">...</div></div>
                    <div class="stat-card"><div class="label">Fundos ESG</div><div class="value text-secondary" id="statAnbimaESG">...</div></div>
                    <div class="stat-card"><div class="label">Fundos Ativos</div><div class="value text-success" id="statAnbimaAtivos">...</div></div>
                    <div class="stat-card"><div class="label">Categorias</div><div class="value text-accent" id="statAnbimaCategorias">...</div></div>
                </div>

                <!-- Filtros -->
                <div style="display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap;">
                    <input type="text" id="searchAnbimaFundos" placeholder="Buscar por nome, CNPJ ou gestor..."
                        style="flex:1;min-width:250px;padding:12px 15px;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);">
                    <select id="filtroAnbimaCategoria" style="padding:12px;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);">
                        <option value="">Todas Categorias</option>
                    </select>
                    <select id="filtroAnbimaESG" style="padding:12px;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);">
                        <option value="">ESG / Todos</option>
                        <option value="true">Apenas ESG</option>
                        <option value="false">Nao ESG</option>
                    </select>
                    <button onclick="carregarAnbimaFundos()" style="padding:12px 20px;background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);border:none;border-radius:8px;color:white;cursor:pointer;font-weight:600;">
                        üîç Buscar
                    </button>
                </div>

                <!-- Tabela -->
                <div style="overflow-x:auto;">
                    <table id="tabelaAnbimaFundos">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>CNPJ</th>
                                <th>Categoria</th>
                                <th>Tipo</th>
                                <th>Gestor</th>
                                <th>Status</th>
                                <th>ESG</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="paginacaoAnbimaFundos" style="margin-top:15px;display:flex;justify-content:center;gap:10px;"></div>
            </div>
        </div>

        <!-- TAB: ANBIMA Dados Periodicos -->
        <div id="anbima-periodicos" class="tab-content">
            <div class="chart-card" style="background:linear-gradient(135deg,rgba(255,193,7,0.1) 0%,rgba(255,152,0,0.1) 100%);border-color:rgba(255,193,7,0.3);">
                <div style="display:flex;align-items:center;gap:20px;">
                    <div style="font-size:3rem;">üí∞</div>
                    <div>
                        <h2 style="color:#FFC107;margin:0;">Fundos 175 - Dados Periodicos</h2>
                        <p style="color:#FFD54F;margin-top:8px;">Patrimonio Liquido, Cotistas e Valor da Cota</p>
                        <span id="anbimaPeriodicosDataRef" class="badge" style="background:#FF9800;">Data Ref: ...</span>
                    </div>
                </div>
            </div>

            <!-- Estatisticas Principais -->
            <div class="stats-grid" style="grid-template-columns:repeat(5,1fr);">
                <div class="stat-card has-tooltip" title="Total de fundos com dados periodicos"><div class="label">Total Fundos</div><div class="value text-primary" id="statPeriodFundos">...</div></div>
                <div class="stat-card has-tooltip" title="Fundos com PL maior que zero"><div class="label">Com PL > 0</div><div class="value text-info" id="statPeriodComPL">...</div></div>
                <div class="stat-card has-tooltip" title="Soma do patrimonio liquido de todos os fundos"><div class="label">PL Total</div><div class="value text-accent" id="statPeriodPLTotal">...</div></div>
                <div class="stat-card has-tooltip" title="Soma de todos os cotistas"><div class="label">Total Cotistas</div><div class="value text-secondary" id="statPeriodCotistas">...</div></div>
                <div class="stat-card has-tooltip" title="Media do valor da cota"><div class="label">Cota Media</div><div class="value text-info" id="statPeriodCotaMedia">...</div></div>
            </div>

            <!-- Top 10 por PL -->
            <div class="chart-card">
                <h3>üèÜ Top 10 Fundos por Patrimonio Liquido</h3>
                <div style="overflow-x:auto;">
                    <table id="tabelaTopPL">
                        <thead><tr>
                            <th>#</th>
                            <th>Nome do Fundo</th>
                            <th>Patrimonio Liquido</th>
                            <th>Cotistas</th>
                            <th>Valor Cota</th>
                        </tr></thead>
                        <tbody id="corpoTopPL"></tbody>
                    </table>
                </div>
            </div>

            <!-- Distribuicao por Foco e Categoria -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                <div class="chart-card">
                    <h3>üìä Por Foco de Atuacao</h3>
                    <div style="overflow-x:auto;max-height:300px;">
                        <table id="tabelaPorFoco">
                            <thead><tr><th>Foco</th><th>Qtd Fundos</th><th>PL Total</th></tr></thead>
                            <tbody id="corpoPorFoco"></tbody>
                        </table>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>üìà Por Categoria</h3>
                    <div style="overflow-x:auto;max-height:300px;">
                        <table id="tabelaPorCategoria">
                            <thead><tr><th>Categoria</th><th>Qtd Fundos</th><th>PL Total</th></tr></thead>
                            <tbody id="corpoPorCategoria"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Filtros e Tabela Principal -->
            <div class="chart-card">
                <h3>üìã Todos os Fundos com Dados Periodicos</h3>
                <div style="display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap;">
                    <input type="text" id="searchPeriodicos" placeholder="Buscar fundo..." style="flex:1;min-width:200px;padding:10px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);">
                    <select id="filtroPeriodFoco" style="padding:10px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);">
                        <option value="">Todos os Focos</option>
                    </select>
                    <select id="filtroPeriodCategoria" style="padding:10px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);">
                        <option value="">Todas Categorias</option>
                    </select>
                    <select id="filtroPeriodOrdem" style="padding:10px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);">
                        <option value="pl">Maior PL</option>
                        <option value="cotistas">Mais Cotistas</option>
                        <option value="cota">Maior Cota</option>
                        <option value="nome">Nome A-Z</option>
                    </select>
                    <button onclick="carregarAnbimaPeriodicos()" style="padding:10px 20px;background:var(--accent);border:none;border-radius:8px;color:#000;cursor:pointer;font-weight:bold;">Buscar</button>
                </div>
                <div id="loadingPeriodicos" style="text-align:center;padding:20px;color:var(--text-secondary);">Carregando...</div>
                <div style="overflow-x:auto;max-height:500px;">
                    <table id="tabelaPeriodicos">
                        <thead><tr>
                            <th>Nome</th>
                            <th>CNPJ</th>
                            <th>PL Atual</th>
                            <th>Cotistas</th>
                            <th>Valor Cota</th>
                            <th>Foco</th>
                            <th>Categoria</th>
                        </tr></thead>
                        <tbody id="corpoPeriodicos"></tbody>
                    </table>
                </div>
                <div id="paginacaoPeriodicos" style="margin-top:15px;display:flex;justify-content:center;gap:10px;"></div>
            </div>
        </div>

        <!-- TAB: ANBIMA CRI/CRA -->
        <div id="anbima-cricra" class="tab-content">
            <div class="chart-card">
                <h3>üèóÔ∏è CRI/CRA ANBIMA - Precos Indicativos</h3>
                <p style="color:var(--text-secondary);margin-bottom:15px;">Certificados de Recebiveis com taxas e precos diarios</p>

                <!-- Estatisticas -->
                <div class="stats-grid" style="margin-bottom:20px;">
                    <div class="stat-card"><div class="label">Total CRI/CRA</div><div class="value text-primary" id="statAnbimaCRICRA">...</div></div>
                    <div class="stat-card"><div class="label">CRI</div><div class="value text-info" id="statAnbimaCRI">...</div></div>
                    <div class="stat-card"><div class="label">CRA</div><div class="value text-secondary" id="statAnbimaCRA">...</div></div>
                    <div class="stat-card"><div class="label">Data Referencia</div><div class="value text-accent" id="statAnbimaDataRef" style="font-size:1rem;">...</div></div>
                </div>

                <!-- Filtros -->
                <div style="display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap;">
                    <input type="text" id="searchAnbimaCRICRA" placeholder="Buscar por emissor, devedor ou codigo..."
                        style="flex:1;min-width:250px;padding:12px 15px;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);">
                    <select id="filtroAnbimaTipoCRICRA" style="padding:12px;background:var(--bg-dark);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);">
                        <option value="">Todos Tipos</option>
                        <option value="CRI">CRI</option>
                        <option value="CRA">CRA</option>
                    </select>
                    <button onclick="carregarAnbimaCRICRA()" style="padding:12px 20px;background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);border:none;border-radius:8px;color:white;cursor:pointer;font-weight:600;">
                        üîç Buscar
                    </button>
                </div>

                <!-- Tabela -->
                <div style="overflow-x:auto;">
                    <table id="tabelaAnbimaCRICRA">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Codigo</th>
                                <th>Emissor</th>
                                <th>Devedor</th>
                                <th>Vencimento</th>
                                <th>Taxa Indicativa</th>
                                <th>PU Indicativo</th>
                                <th>Duration</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: ANBIMA Titulos Publicos -->
        <div id="anbima-titulos" class="tab-content">
            <div class="chart-card">
                <h3>üìã Titulos Publicos ANBIMA</h3>
                <p style="color:var(--text-secondary);margin-bottom:15px;">Precos indicativos de titulos publicos federais</p>

                <!-- Estatisticas -->
                <div class="stats-grid" style="margin-bottom:20px;">
                    <div class="stat-card"><div class="label">Total Titulos</div><div class="value text-primary" id="statAnbimaTitulos">...</div></div>
                    <div class="stat-card"><div class="label">Data Referencia</div><div class="value text-accent" id="statAnbimaTitulosData" style="font-size:1rem;">...</div></div>
                </div>

                <!-- Tabela -->
                <div style="overflow-x:auto;">
                    <table id="tabelaAnbimaTitulos">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Codigo SELIC</th>
                                <th>ISIN</th>
                                <th>Vencimento</th>
                                <th>Taxa Compra</th>
                                <th>Taxa Venda</th>
                                <th>Taxa Indicativa</th>
                                <th>PU Indicativo</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal KPIs Empresa -->
    <div id="modalKPIs" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:1000;overflow-y:auto;">
        <div style="max-width:800px;margin:50px auto;background:var(--card-bg);border-radius:12px;padding:25px;position:relative;">
            <button onclick="fecharModalKPIs()" style="position:absolute;top:15px;right:15px;background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;">&times;</button>
            <div id="modalKPIsConteudo"></div>
        </div>
    </div>

    <script>
        console.log('=== SCRIPT INICIALIZADO ===');

        function showTab(tabId, event) {
            console.log('showTab ORIGINAL chamado - tabId:', tabId);
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if (event) event.target.closest('.nav-item').classList.add('active');
            inicializarGraficos();
            // Carregar dados da aba se necess√°rio
            if (tabId === 'gestoras' && !gestorasCarregado) carregarGestoras();
        }

        const cores = ['#42A5F5', '#66BB6A', '#FFB74D', '#AB47BC', '#26C6DA', '#EC407A'];
        let graficos = {};
        let gestorasCarregado = false;
        let dadosGestoras = [];

        // Funcao para formatar CNPJ
        function formatarCNPJ(cnpj) {
            if (!cnpj) return '-';
            cnpj = cnpj.toString().replace(/\D/g, '');
            if (cnpj.length !== 14) return cnpj;
            return cnpj.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
        }

        // ========== GESTORAS ==========
        async function carregarGestoras() {
            try {
                const response = await fetch(`${API_URL}/gestoras`);
                const data = await response.json();

                if (data.success) {
                    dadosGestoras = data.data;

                    // Atualizar estat√≠sticas
                    document.getElementById('statTotalGestoras').textContent = data.stats.total_gestoras.toLocaleString();
                    document.getElementById('statTotalFundosGestoras').textContent = data.stats.total_fundos.toLocaleString();
                    document.getElementById('statTotalClasses').textContent = data.stats.top_classes.length;

                    // Renderizar lista de gestoras
                    renderizarListaGestoras(dadosGestoras);

                    // Criar gr√°fico de classes ANBIMA
                    if (data.stats.top_classes && data.stats.top_classes.length > 0) {
                        criarGraficoClasses(data.stats.top_classes);
                    }

                    gestorasCarregado = true;
                }
            } catch (e) {
                console.error('Erro ao carregar gestoras:', e);
                document.getElementById('listaGestoras').innerHTML = '<p style="color:#EF5350;text-align:center;padding:40px;">Erro ao carregar gestoras</p>';
            }
        }

        function renderizarListaGestoras(gestoras) {
            const container = document.getElementById('listaGestoras');
            if (!gestoras || gestoras.length === 0) {
                container.innerHTML = '<p style="color:var(--text-secondary);text-align:center;padding:40px;">Nenhuma gestora encontrada</p>';
                return;
            }

            let html = '<table style="width:100%;"><thead><tr><th>Gestora</th><th>Fundos</th><th>Classes</th><th></th></tr></thead><tbody>';
            gestoras.forEach(g => {
                html += `<tr style="cursor:pointer;" onclick="verFundosGestora('${encodeURIComponent(g.gestora)}')">
                    <td style="max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${g.gestora}">${g.gestora}</td>
                    <td><span style="background:rgba(66,165,245,0.2);color:#42A5F5;padding:3px 10px;border-radius:12px;font-weight:600;">${g.qtd_fundos}</span></td>
                    <td>${g.qtd_classes}</td>
                    <td><button style="background:#4CAF50;color:white;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;font-size:0.75rem;">Ver Fundos</button></td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function filtrarGestoras() {
            const termo = document.getElementById('searchGestora').value.toLowerCase();
            const filtradas = dadosGestoras.filter(g => g.gestora.toLowerCase().includes(termo));
            renderizarListaGestoras(filtradas);
        }

        async function verFundosGestora(gestoraEncoded) {
            const gestora = decodeURIComponent(gestoraEncoded);
            const container = document.getElementById('fundosGestoraSelecionada');
            container.innerHTML = '<p style="color:var(--text-secondary);text-align:center;padding:40px;">Carregando fundos...</p>';

            try {
                const response = await fetch(`${API_URL}/gestoras/${gestoraEncoded}/fundos`);
                const data = await response.json();

                if (data.success) {
                    let html = `<div style="margin-bottom:15px;padding:15px;background:rgba(66,165,245,0.1);border-radius:8px;">
                        <h4 style="margin:0 0 10px 0;color:#42A5F5;">${gestora}</h4>
                        <div style="display:flex;gap:15px;flex-wrap:wrap;">
                            <span style="background:rgba(255,255,255,0.1);padding:5px 12px;border-radius:8px;font-size:0.85rem;">Total: <strong>${data.total}</strong> fundos</span>
                        </div>
                    </div>`;

                    if (data.stats.por_classe && data.stats.por_classe.length > 0) {
                        html += '<div style="margin-bottom:15px;"><strong style="font-size:0.85rem;color:var(--text-secondary);">Por Classe ANBIMA:</strong><div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">';
                        data.stats.por_classe.forEach(c => {
                            html += `<span style="background:rgba(102,187,106,0.2);color:#66BB6A;padding:3px 10px;border-radius:12px;font-size:0.75rem;">${c.classeanbima}: ${c.qtd}</span>`;
                        });
                        html += '</div></div>';
                    }

                    html += '<div style="max-height:300px;overflow-y:auto;"><table style="width:100%;font-size:0.85rem;"><thead><tr><th>Nome do Fundo</th><th>CNPJ</th><th>Classe</th></tr></thead><tbody>';
                    data.fundos.forEach(f => {
                        html += `<tr>
                            <td style="max-width:250px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${f.nomecompleto}">${f.nomecompleto}</td>
                            <td style="font-family:monospace;font-size:0.75rem;">${f.cnpj || '-'}</td>
                            <td style="font-size:0.75rem;">${f.classeanbima || '-'}</td>
                        </tr>`;
                    });
                    html += '</tbody></table></div>';
                    container.innerHTML = html;
                }
            } catch (e) {
                console.error('Erro ao carregar fundos da gestora:', e);
                container.innerHTML = '<p style="color:#EF5350;text-align:center;padding:40px;">Erro ao carregar fundos</p>';
            }
        }

        function criarGraficoClasses(topClasses) {
            const ctx = document.getElementById('chartClassesAnbima');
            if (!ctx) return;

            if (graficos['chartClassesAnbima']) graficos['chartClassesAnbima'].destroy();

            graficos['chartClassesAnbima'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topClasses.map(c => c.classeanbima ? c.classeanbima.substring(0, 30) : 'N/A'),
                    datasets: [{
                        label: 'Fundos',
                        data: topClasses.map(c => c.qtd),
                        backgroundColor: '#42A5F5',
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { ticks: { color: '#a0a0b0', font: { size: 10 } } },
                        x: { ticks: { color: '#a0a0b0' } }
                    }
                }
            });
        }

        function inicializarGraficos() {
            if (!graficos['chartCategorias'] && document.getElementById('chartCategorias')) {
                graficos['chartCategorias'] = new Chart(document.getElementById('chartCategorias'), {
                    type: 'bar',
                    data: { labels: ["Renda Fixa", "Multimercados", "A\u00e7\u00f5es", "Previd\u00eancia", "Cambial"], datasets: [{ label: 'Fundos', data: [43800, 24500, 23300, 8000, 400], backgroundColor: ['#42A5F5', '#66BB6A', '#FFB74D', '#AB47BC', '#26C6DA'], borderRadius: 4 }] },
                    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#a0a0b0' } }, x: { ticks: { color: '#a0a0b0' } } } }
                });
            }
            if (!graficos['chartDebentures'] && document.getElementById('chartDebentures')) {
                graficos['chartDebentures'] = new Chart(document.getElementById('chartDebentures'), {
                    type: 'doughnut',
                    data: { labels: ["DI PERCENTUAL", "DI SPREAD", "IPCA SPREAD"], datasets: [{ data: [57, 74, 119], backgroundColor: cores, borderWidth: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#fff' } } } }
                });
            }
            if (!graficos['chartTitulos'] && document.getElementById('chartTitulos')) {
                graficos['chartTitulos'] = new Chart(document.getElementById('chartTitulos'), {
                    type: 'doughnut',
                    data: { labels: ["LFT", "LTN", "NTN-B", "NTN-C", "NTN-F"], datasets: [{ data: [12, 13, 15, 1, 6], backgroundColor: cores, borderWidth: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#fff' } } } }
                });
            }
            if (!graficos['chartTSBClass'] && document.getElementById('chartTSBClass')) {
                graficos['chartTSBClass'] = new Chart(document.getElementById('chartTSBClass'), {
                    type: 'doughnut',
                    data: { labels: ['Verde', 'Transicao'], datasets: [{ data: [7, 0], backgroundColor: ['#4CAF50', '#FF9800'], borderWidth: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#fff' } } } }
                });
            }
            if (!graficos['chartVencimentos'] && document.getElementById('chartVencimentos')) {
                graficos['chartVencimentos'] = new Chart(document.getElementById('chartVencimentos'), {
                    type: 'bar',
                    data: { labels: ['2024', '2025', '2026', '2027', '2028', '2029', '2030'], datasets: [{ data: [5, 20, 35, 50, 45, 30, 20], backgroundColor: '#42A5F5', borderRadius: 4 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#a0a0b0' } }, x: { ticks: { color: '#a0a0b0' } } } }
                });
            }
        }
        document.addEventListener('DOMContentLoaded', inicializarGraficos);

        // ========== API CONFIGURATION ==========
        const API_URL = '/api';
        let paginaAtualAPI = 1;
        let totalPaginasAPI = 1;
        let totalFundosAPI = 0;
        let dataTableFundos = null; // Inst√¢ncia do Simple-DataTables
        // Inst√¢ncias de DataTables para todas as tabelas
        let dataTableInstances = {
            tabelaFundosIS: null,
            tabelaFundosESG: null,
            tabelaDebentures: null,
            tabelaTitulosPublicos: null,
            tabelaCRICRA: null,
            tabelaEmissores: null,
            tabelaFavoritos: null
        };

        // Fun√ß√£o gen√©rica para inicializar Simple-DataTables
        function inicializarDataTable(tableId, options = {}) {
            const tableElement = document.getElementById(tableId);
            if (!tableElement) {
                console.warn(`Tabela ${tableId} n√£o encontrada`);
                return null;
            }

            // Destruir inst√¢ncia anterior se existir
            if (dataTableInstances[tableId]) {
                try {
                    dataTableInstances[tableId].destroy();
                } catch (e) {
                    console.warn(`Erro ao destruir DataTable ${tableId}:`, e);
                }
            }

            const defaultOptions = {
                searchable: true,
                sortable: true,
                perPage: 25,
                perPageSelect: [10, 25, 50, 100],
                labels: {
                    placeholder: "Buscar...",
                    perPage: "por p√°gina",
                    noRows: "Nenhum registro encontrado",
                    info: "Mostrando {start} a {end} de {rows} registros"
                }
            };

            try {
                const mergedOptions = { ...defaultOptions, ...options };
                const dtInstance = new simpleDatatables.DataTable(`#${tableId}`, mergedOptions);
                dataTableInstances[tableId] = dtInstance;

                // Adicionar filtros por coluna ap√≥s inicializa√ß√£o
                setTimeout(() => {
                    adicionarFiltrosColunas(tableId, dtInstance);
                }, 100);

                return dtInstance;
            } catch (e) {
                console.error(`Erro ao inicializar DataTable ${tableId}:`, e);
                return null;
            }
        }

        // Fun√ß√£o para inicializar tabelas est√°ticas quando a aba for exibida
        function inicializarTabelasEstaticas() {
            // Fundos IS
            if (!dataTableInstances.tabelaFundosIS && document.getElementById('tabelaFundosIS')) {
                inicializarDataTable('tabelaFundosIS', { perPage: 25 });
            }
            // Fundos ESG
            if (!dataTableInstances.tabelaFundosESG && document.getElementById('tabelaFundosESG')) {
                inicializarDataTable('tabelaFundosESG', { perPage: 25 });
            }
            // Deb√™ntures
            if (!dataTableInstances.tabelaDebentures && document.getElementById('tabelaDebentures')) {
                inicializarDataTable('tabelaDebentures', { perPage: 25 });
            }
            // T√≠tulos P√∫blicos
            if (!dataTableInstances.tabelaTitulosPublicos && document.getElementById('tabelaTitulosPublicos')) {
                inicializarDataTable('tabelaTitulosPublicos', { perPage: 25 });
            }
        }

        // Fun√ß√£o para adicionar filtros por coluna (dropdown)
        function adicionarFiltrosColunas(tableId, dtInstance) {
            const table = document.getElementById(tableId);
            if (!table) return;

            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            const headerRow = thead.querySelector('tr');
            const headers = headerRow.querySelectorAll('th');

            // Verificar se j√° existe linha de filtros
            if (thead.querySelector('.filter-row')) return;

            // Coletar valores √∫nicos de cada coluna
            const rows = tbody.querySelectorAll('tr');
            const uniqueValues = [];
            headers.forEach((th, index) => {
                const values = new Set();
                values.add(''); // Op√ß√£o "Todos"
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length > index) {
                        const text = cells[index].textContent.trim();
                        if (text && text !== '-') values.add(text);
                    }
                });
                uniqueValues.push(Array.from(values).sort());
            });

            // Criar linha de filtros
            const filterRow = document.createElement('tr');
            filterRow.className = 'filter-row';

            headers.forEach((th, index) => {
                const filterTh = document.createElement('th');
                filterTh.style.padding = '5px';

                // N√£o adicionar filtro na √∫ltima coluna (a√ß√µes)
                if (index < headers.length - 1) {
                    const select = document.createElement('select');
                    select.className = 'datatable-filter';
                    select.style.width = '100%';
                    select.style.padding = '4px';
                    select.style.background = 'var(--bg-card)';
                    select.style.color = 'var(--text-primary)';
                    select.style.border = '1px solid var(--border-color)';
                    select.style.borderRadius = '4px';
                    select.style.fontSize = '0.7rem';

                    // Adicionar op√ß√µes
                    const optionAll = document.createElement('option');
                    optionAll.value = '';
                    optionAll.textContent = 'Todos';
                    select.appendChild(optionAll);

                    // Limitar a 50 valores √∫nicos por coluna
                    const valores = uniqueValues[index].slice(0, 50);
                    valores.forEach(val => {
                        if (val) {
                            const option = document.createElement('option');
                            option.value = val;
                            option.textContent = val.length > 25 ? val.substring(0, 25) + '...' : val;
                            option.title = val;
                            select.appendChild(option);
                        }
                    });

                    select.addEventListener('change', function() {
                        filtrarColuna(tableId, index, this.value);
                    });
                    filterTh.appendChild(select);
                }
                filterRow.appendChild(filterTh);
            });

            thead.appendChild(filterRow);
        }

        // Fun√ß√£o para filtrar por coluna (suporta select dropdown)
        function filtrarColuna(tableId, colIndex, valor) {
            const table = document.getElementById(tableId);
            if (!table) return;

            const tbody = table.querySelector('tbody');
            const rows = tbody.querySelectorAll('tr');

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 0) return;

                // Verificar todos os filtros ativos (select dropdowns)
                const filterSelects = table.querySelectorAll('.filter-row select');
                let showRow = true;

                filterSelects.forEach((select, idx) => {
                    if (select.value && cells[idx]) {
                        const cellVal = cells[idx].textContent.trim();
                        const filterVal = select.value;
                        // Compara√ß√£o exata para dropdown
                        if (cellVal !== filterVal && !cellVal.includes(filterVal)) {
                            showRow = false;
                        }
                    }
                });

                row.style.display = showRow ? '' : 'none';
            });
        }

        // Carregar dados do Overview automaticamente
        async function carregarOverview() {
            try {
                // Carregar resumo ANBIMA (dados novos)
                const anbimaResponse = await fetch(`${API_URL}/anbima/resumo`);
                const anbimaData = await anbimaResponse.json();
                if (anbimaData.success) {
                    document.getElementById('statTotalFundos').textContent = anbimaData.data.fundos.toLocaleString();
                    document.getElementById('statFundosESG').textContent = anbimaData.data.fundos_esg.toLocaleString();
                    document.getElementById('statFundosESGDetalhe').textContent = 'Base ANBIMA Data';
                }

                // Carregar total de deb√™ntures
                const debResponse = await fetch(`${API_URL}/debentures`);
                const debData = await debResponse.json();
                if (debData.success) {
                    const debentures = debData.data;
                    document.getElementById('statDebentures').textContent = debentures.length;

                    // Atualizar stats da aba Debentures
                    const diPerc = debentures.filter(d => d.grupo === 'DI PERCENTUAL').length;
                    const diSpread = debentures.filter(d => d.grupo === 'DI SPREAD').length;
                    const ipcaSpread = debentures.filter(d => d.grupo === 'IPCA SPREAD').length;

                    document.getElementById('debTotal').textContent = debentures.length;
                    document.getElementById('debDIPerc').textContent = diPerc;
                    document.getElementById('debDISpread').textContent = diSpread;
                    document.getElementById('debIPCASpread').textContent = ipcaSpread;
                }

                // Carregar total de t√≠tulos p√∫blicos
                const titResponse = await fetch(`${API_URL}/titulos-publicos`);
                const titData = await titResponse.json();
                if (titData.success) {
                    const titulos = titData.data;
                    const tipos = [...new Set(titulos.map(t => t.tipo))].length;
                    document.getElementById('statTitulosPublicos').textContent = titulos.length;
                    document.getElementById('statTitulosTipos').textContent = tipos + ' tipos';

                    // Atualizar stats da aba T√≠tulos P√∫blicos
                    const ltn = titulos.filter(t => t.tipo === 'LTN').length;
                    const ntnf = titulos.filter(t => t.tipo === 'NTN-F').length;
                    const ntnb = titulos.filter(t => t.tipo === 'NTN-B').length;
                    const lft = titulos.filter(t => t.tipo === 'LFT').length;

                    document.getElementById('titTotal').textContent = titulos.length;
                    document.getElementById('titLTN').textContent = ltn;
                    document.getElementById('titNTNF').textContent = ntnf;
                    document.getElementById('titNTNB').textContent = ntnb;
                    document.getElementById('titLFT').textContent = lft;
                }

                // Carregar empresas TSB
                const tsbResponse = await fetch(`${API_URL}/tsb/empresas`);
                const tsbData = await tsbResponse.json();
                if (tsbData.success) {
                    const empresasVerdes = tsbData.data.filter(e => e.categoria === 'Verde').length;
                    document.getElementById('statEmpresasTSB').textContent = tsbData.data.length;
                    document.getElementById('statEmpresasTSBDetalhe').textContent = Math.round(empresasVerdes / tsbData.data.length * 100) + '% Verde';
                }

            } catch (e) {
                console.error('Erro ao carregar Overview:', e);
            }
        }

        // Carregar Overview ao iniciar
        document.addEventListener('DOMContentLoaded', carregarOverview);

        // Verificar sa√∫de da API
        async function verificarAPI() {
            try {
                const response = await fetch(`${API_URL}/health`);
                const data = await response.json();
                if (data.status === 'healthy') {
                    showAPIStatus('success', '‚úì API Conectada');
                    carregarCategoriasAPI();
                    return true;
                }
            } catch (e) {
                showAPIStatus('error', '‚úó API n√£o dispon√≠vel. Execute: python api/app.py');
            }
            return false;
        }

        function showAPIStatus(type, message) {
            const el = document.getElementById('apiStatus');
            if (el) {
                el.style.display = 'block';
                el.style.background = type === 'success' ? 'rgba(76,175,80,0.15)' : 'rgba(244,67,54,0.15)';
                el.style.border = type === 'success' ? '1px solid rgba(76,175,80,0.3)' : '1px solid rgba(244,67,54,0.3)';
                el.style.color = type === 'success' ? '#66BB6A' : '#EF5350';
                el.innerHTML = message;
            }
        }

        // Carregar categorias do banco
        async function carregarCategoriasAPI() {
            try {
                const response = await fetch(`${API_URL}/fundos/categorias`);
                const data = await response.json();
                if (data.success) {
                    const select = document.getElementById('filtroCategoria');
                    if (select) {
                        select.innerHTML = '<option value="">Todas Categorias</option>';
                        data.data.forEach(cat => {
                            const opt = document.createElement('option');
                            opt.value = cat.categoria;
                            opt.textContent = `${cat.categoria} (${cat.qtd.toLocaleString()})`;
                            select.appendChild(opt);
                        });
                    }
                }

                // Carregar fundos automaticamente
                buscarFundosAPI();
            } catch (e) {
                console.error('Erro ao carregar categorias:', e);
            }
        }

        // Buscar fundos da API (usando view consolidada ANBIMA + CVM)
        async function buscarFundosAPI() {
            // Mostrar loading
            document.getElementById('loadingFundos').style.display = 'block';
            document.getElementById('tabelaContainer').style.display = 'none';

            try {
                const search = document.getElementById('searchExplorar')?.value || '';
                const fonte = document.getElementById('filtroFonteExplorar')?.value || '';

                const params = new URLSearchParams({
                    page: paginaAtualAPI,
                    per_page: 50
                });

                if (search) params.append('search', search);
                if (fonte) params.append('fonte', fonte);

                const response = await fetch(`${API_URL}/fundos?${params}`);
                const data = await response.json();

                if (data.success) {
                    renderizarTabelaAPI(data.data);
                    totalFundosAPI = data.pagination.total;
                    totalPaginasAPI = data.pagination.total_pages;

                    // Atualizar estat√≠sticas
                    document.getElementById('totalEncontrados').textContent = totalFundosAPI.toLocaleString();
                    document.getElementById('paginaAtualStat').textContent = `${paginaAtualAPI}/${totalPaginasAPI}`;
                    document.getElementById('infoPagina').textContent = `P√°gina ${paginaAtualAPI} de ${totalPaginasAPI}`;

                    // Mostrar distribui√ß√£o por fonte
                    if (data.stats?.por_fonte) {
                        const anbimaCount = data.stats.por_fonte['ANBIMA'] || 0;
                        const cvmCount = data.stats.por_fonte['CVM'] || 0;
                        showAPIStatus('success', `‚úì ${totalFundosAPI.toLocaleString()} fundos (ANBIMA: ${anbimaCount.toLocaleString()} | CVM: ${cvmCount.toLocaleString()})`);
                    } else {
                        showAPIStatus('success', `‚úì ${totalFundosAPI.toLocaleString()} fundos encontrados`);
                    }
                } else {
                    showAPIStatus('error', `‚úó Erro: ${data.error}`);
                }
            } catch (e) {
                showAPIStatus('error', `‚úó Erro de conex√£o: ${e.message}`);
            } finally {
                document.getElementById('loadingFundos').style.display = 'none';
                document.getElementById('tabelaContainer').style.display = 'block';
            }
        }

        function renderizarTabelaAPI(fundos) {
            const corpo = document.getElementById('corpoTabelaFundos');
            if (!corpo) return;

            // Destruir inst√¢ncia anterior do DataTable se existir
            if (dataTableFundos) {
                dataTableFundos.destroy();
                dataTableFundos = null;
            }

            if (!fundos || fundos.length === 0) {
                corpo.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-secondary);">Nenhum fundo encontrado</td></tr>';
                return;
            }

            // Fun√ß√£o para escapar HTML
            const escapeHtml = (str) => {
                if (!str) return '-';
                return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            };

            let html = '';
            for (let i = 0; i < fundos.length; i++) {
                const f = fundos[i];
                const fonte = f.fonte || 'ANBIMA';
                const fonteColor = fonte === 'ANBIMA' ? '#42A5F5' : '#CE93D8';
                const nome = escapeHtml(f.nome || f.nomecomercial || f.razaosocial);
                const cnpj = formatarCNPJ(f.cnpj_classe || f.cnpj);
                const categoria = escapeHtml(f.categoria_anbima || f.categoria);
                const gestora = escapeHtml(f.gestor || f.gestora);
                const isESG = f.fundo_esg === true || f.categoriaesg === 'ESG';

                const esgClass = isESG ? 'rgba(46,125,50,0.2);color:#66BB6A' : 'rgba(100,100,100,0.2);color:#a0a0b0';
                const esgText = isESG ? 'ESG' : '-';

                html += `<tr>
                    <td><span style="background:${fonteColor};color:white;padding:2px 8px;border-radius:10px;font-size:0.7rem;">${fonte}</span></td>
                    <td style="max-width:280px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${nome}">${nome}</td>
                    <td style="font-family:monospace;font-size:0.75rem;">${cnpj}</td>
                    <td style="max-width:150px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${categoria}">${categoria}</td>
                    <td style="max-width:150px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${gestora}">${gestora}</td>
                    <td><span style="background:${esgClass};padding:3px 8px;border-radius:10px;font-size:0.75rem;">${esgText}</span></td>
                    <td>
                        <button onclick="verDetalhesFundo('${f.cnpj_classe || f.cnpj}')" style="background:#2196F3;color:white;border:none;cursor:pointer;padding:4px 8px;border-radius:4px;font-size:0.7rem;margin-right:4px;" title="Ver detalhes do fundo">üîç</button>
                        <button data-cnpj="${f.cnpj_classe || f.cnpj}" data-nome="${nome}" onclick="adicionarFavoritoBtn(this)" style="background:none;border:none;cursor:pointer;font-size:1rem;" title="Adicionar aos favoritos">‚≠ê</button>
                    </td>
                </tr>`;
            }
            corpo.innerHTML = html;

            // Inicializar Simple-DataTables com filtros por coluna
            try {
                dataTableFundos = new simpleDatatables.DataTable("#tabelaFundos", {
                    searchable: false, // Desabilitado pois j√° temos busca via API
                    paging: false, // Desabilitado pois j√° temos pagina√ß√£o via API
                    fixedHeight: false,
                    sortable: true,
                    columns: [
                        { select: 6, sortable: false } // Coluna de a√ß√µes n√£o orden√°vel
                    ],
                    labels: {
                        noRows: "Nenhum fundo encontrado"
                    }
                });

                // Adicionar filtros por coluna manualmente
                adicionarFiltrosColunas('tabelaFundos', dataTableFundos);
            } catch (e) {
                console.warn('Simple-DataTables n√£o inicializado:', e);
            }
        }

        function adicionarFavoritoBtn(btn) {
            const cnpj = btn.getAttribute('data-cnpj');
            const nome = btn.getAttribute('data-nome');
            adicionarFavoritoAPI(cnpj, nome);
        }

        function mudarPaginaAPI(direcao) {
            const novaPagina = paginaAtualAPI + direcao;
            if (novaPagina >= 1 && novaPagina <= totalPaginasAPI) {
                paginaAtualAPI = novaPagina;
                buscarFundosAPI();
            }
        }

        function adicionarFavoritoAPI(cnpj, nome) {
            let favoritos = JSON.parse(localStorage.getItem('fundos_favoritos') || '[]');
            if (!favoritos.find(f => f.cnpj === cnpj)) {
                favoritos.push({ cnpj, nome });
                localStorage.setItem('fundos_favoritos', JSON.stringify(favoritos));
                alert(`‚úì "${nome}" adicionado aos favoritos!`);
                carregarFavoritos(); // Atualizar a aba de favoritos
            } else {
                alert('Este fundo j√° est√° nos favoritos.');
            }
        }

        function carregarFavoritos() {
            const favoritos = JSON.parse(localStorage.getItem('fundos_favoritos') || '[]');
            const totalEl = document.getElementById('totalFavoritos');
            const semFavEl = document.getElementById('semFavoritos');
            const tabelaEl = document.getElementById('tabelaFavoritos');
            const corpoEl = document.getElementById('corpoFavoritos');

            // Destruir inst√¢ncia anterior do DataTable se existir
            if (dataTableInstances.tabelaFavoritos) {
                try {
                    dataTableInstances.tabelaFavoritos.destroy();
                    dataTableInstances.tabelaFavoritos = null;
                } catch (e) {}
            }

            if (totalEl) totalEl.textContent = favoritos.length;

            if (favoritos.length === 0) {
                if (semFavEl) semFavEl.style.display = 'block';
                if (tabelaEl) tabelaEl.style.display = 'none';
            } else {
                if (semFavEl) semFavEl.style.display = 'none';
                if (tabelaEl) tabelaEl.style.display = 'table';
                if (corpoEl) {
                    corpoEl.innerHTML = favoritos.map(f => `
                        <tr>
                            <td style="max-width:400px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${f.nome}">${f.nome}</td>
                            <td>${f.cnpj}</td>
                            <td><button onclick="removerFavorito('${f.cnpj}')" style="background:rgba(244,67,54,0.2);border:1px solid rgba(244,67,54,0.3);color:#EF5350;padding:5px 10px;border-radius:5px;cursor:pointer;">üóëÔ∏è Remover</button></td>
                        </tr>
                    `).join('');

                    // Inicializar Simple-DataTables para Favoritos
                    setTimeout(() => {
                        inicializarDataTable('tabelaFavoritos', { perPage: 10 });
                    }, 100);
                }
            }
        }

        function removerFavorito(cnpj) {
            let favoritos = JSON.parse(localStorage.getItem('fundos_favoritos') || '[]');
            const fundo = favoritos.find(f => f.cnpj === cnpj);
            favoritos = favoritos.filter(f => f.cnpj !== cnpj);
            localStorage.setItem('fundos_favoritos', JSON.stringify(favoritos));
            if (fundo) {
                alert(`"${fundo.nome}" removido dos favoritos.`);
            }
            carregarFavoritos();
        }

        // Buscar ao pressionar Enter
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchFundos');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        paginaAtualAPI = 1;
                        buscarFundosAPI();
                    }
                });
            }
        });

        // Carregar CRI/CRA da API
        let cricraDataTable = null;
        let cricraCarregado = false;

        async function carregarCRICRA() {
            if (cricraCarregado) return;

            try {
                // Usar endpoint ANBIMA com os dados carregados
                const response = await fetch(`${API_URL}/anbima/cricra`);
                const data = await response.json();
                if (data.success) {
                    cricraCarregado = true;

                    // Atualizar estat√≠sticas com dados ANBIMA
                    document.getElementById('cricraTotal').textContent = data.total.toLocaleString('pt-BR');
                    document.getElementById('cricraCountCRI').textContent = (data.stats?.cri || 0).toLocaleString('pt-BR');
                    document.getElementById('cricraCountCRA').textContent = (data.stats?.cra || 0).toLocaleString('pt-BR');

                    // Renderizar tabela
                    const corpo = document.getElementById('corpoCRICRA');
                    const escapeHtml = (str) => {
                        if (!str) return '-';
                        return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    };

                    let html = '';
                    data.data.forEach(item => {
                        const tipo = item.tipo || item.tipocontrato || '-';
                        const tipoClass = tipo === 'CRI' ? 'rgba(66,165,245,0.2);color:#42A5F5' : 'rgba(102,187,106,0.2);color:#66BB6A';
                        const taxa = item.taxa_indicativa != null ? parseFloat(item.taxa_indicativa).toFixed(2) + '%' : '-';
                        const pu = item.pu_indicativo != null ? 'R$ ' + parseFloat(item.pu_indicativo).toLocaleString('pt-BR', {minimumFractionDigits: 2}) : '-';
                        const duration = item.duration_dias != null ? Math.round(parseFloat(item.duration_dias)) + ' dias' : '-';
                        const vencimento = item.data_vencimento ? new Date(item.data_vencimento).toLocaleDateString('pt-BR') : '-';
                        html += `<tr>
                            <td><span style="background:${tipoClass};padding:3px 8px;border-radius:10px;font-size:0.75rem;">${tipo}</span></td>
                            <td style="font-family:monospace;">${escapeHtml(item.codigo || item.codigoativo)}</td>
                            <td style="max-width:250px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${escapeHtml(item.emissor)}">${escapeHtml(item.emissor)}</td>
                            <td>${escapeHtml(item.serie)}</td>
                            <td>${vencimento}</td>
                            <td>${taxa}</td>
                            <td>${pu}</td>
                            <td>${duration}</td>
                        </tr>`;
                    });
                    corpo.innerHTML = html;

                    // Mostrar tabela
                    document.getElementById('cricraLoading').style.display = 'none';
                    document.getElementById('cricraContainer').style.display = 'block';

                    // Destruir DataTable anterior se existir
                    if (cricraDataTable) {
                        cricraDataTable.destroy();
                        cricraDataTable = null;
                    }

                    // Inicializar Simple-DataTables para CRI/CRA ap√≥s carregar dados
                    cricraDataTable = new simpleDatatables.DataTable('#tabelaCRICRA', {
                        searchable: true,
                        sortable: true,
                        perPage: 25,
                        perPageSelect: [10, 25, 50, 100],
                        labels: {
                            placeholder: "Buscar CRI/CRA...",
                            perPage: "por pagina",
                            noRows: "Nenhum CRI/CRA encontrado",
                            info: "Mostrando {start} a {end} de {rows} titulos"
                        }
                    });

                    // Adicionar filtros dropdown por coluna
                    setTimeout(() => adicionarFiltrosColunas('tabelaCRICRA', cricraDataTable), 100);
                } else {
                    document.getElementById('cricraLoading').innerHTML = '<p style="color:#EF5350;">Erro ao carregar CRI/CRA</p>';
                }
            } catch (e) {
                console.error('Erro ao carregar CRI/CRA:', e);
                document.getElementById('cricraLoading').innerHTML = '<p style="color:#EF5350;">API n√£o dispon√≠vel. Execute: python api/servidor.py</p>';
            }
        }

        // ========== TSB - TAXONOMIA SUSTENT√ÅVEL BRASILEIRA ==========
        let tsbCarregado = false;

        async function carregarTSB() {
            if (tsbCarregado) return;
            try {
                // Carregar empresas
                const empResponse = await fetch(`${API_URL}/tsb/empresas`);
                const empData = await empResponse.json();

                // Carregar KPIs
                const kpiResponse = await fetch(`${API_URL}/tsb/kpis`);
                const kpiData = await kpiResponse.json();

                // Carregar vis√£o geral para estat√≠sticas integradas
                const visaoResponse = await fetch(`${API_URL}/tsb/visao-geral`);
                const visaoData = await visaoResponse.json();

                if (empData.success) {
                    // Atualizar estat√≠sticas principais
                    document.getElementById('tsbTotalEmpresas').textContent = empData.stats.total;
                    document.getElementById('tsbTotalVerde').textContent = empData.stats.verde;
                    document.getElementById('tsbTotalTransicao').textContent = empData.stats.transicao;
                    document.getElementById('tsbBadge').textContent = `‚úì ${empData.stats.total} Empresas Classificadas`;

                    // Estat√≠sticas integradas
                    if (visaoData.success && visaoData.stats) {
                        document.getElementById('tsbTotalTitulos').textContent = visaoData.stats.total_debentures_tsb || 0;
                        document.getElementById('tsbTotalFundosESG').textContent = visaoData.stats.total_fundos_esg || 0;
                        document.getElementById('tsbScoreMedio').textContent = visaoData.stats.score_medio ? visaoData.stats.score_medio.toFixed(1) : '-';
                    }

                    // Renderizar tabela com bot√µes expandidos
                    const corpo = document.getElementById('corpoTabelaTSB');
                    let html = '';
                    empData.data.forEach(emp => {
                        const classColor = emp.classificacao === 'VERDE' ? '#4CAF50' : '#FF9800';
                        const nomeEscapado = emp.emissor.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        html += `<tr style="cursor:pointer;" onclick="verInvestimentosEmpresa(${emp.empresaid})">
                            <td style="max-width:300px;">${emp.emissor}</td>
                            <td style="font-family:monospace;font-size:0.8rem;">${emp.cnpj}</td>
                            <td>${emp.setortsb}</td>
                            <td><span style="background:${classColor};color:white;padding:3px 10px;border-radius:12px;">${emp.classificacao}</span></td>
                            <td><strong>${emp.score}</strong></td>
                            <td>${emp.titulos}</td>
                            <td>
                                <button onclick="event.stopPropagation();verKPIsEmpresa(${emp.empresaid}, '${nomeEscapado}')" style="background:#4CAF50;color:white;border:none;padding:5px 8px;border-radius:6px;cursor:pointer;font-size:0.75rem;margin-right:5px;">KPIs</button>
                                <button onclick="event.stopPropagation();verInvestimentosEmpresa(${emp.empresaid})" style="background:#2196F3;color:white;border:none;padding:5px 8px;border-radius:6px;cursor:pointer;font-size:0.75rem;">Invest.</button>
                            </td>
                        </tr>`;
                    });
                    corpo.innerHTML = html;

                    // Atualizar gr√°ficos TSB
                    atualizarGraficosTSB(empData.stats);
                    tsbCarregado = true;
                }
            } catch (e) {
                console.error('Erro ao carregar TSB:', e);
                document.getElementById('tsbBadge').textContent = 'Erro ao carregar';
                document.getElementById('tsbBadge').style.background = '#f44336';
            }
        }

        function verInvestimentosEmpresa(empresaId) {
            // Mudar para se√ß√£o integrada e carregar dados
            mostrarSecaoTSB('integrado');
            const select = document.getElementById('selectEmpresaIntegrada');
            // Carregar op√ß√µes se necess√°rio
            carregarSelectEmpresas().then(() => {
                select.value = empresaId;
                carregarVisaoIntegrada();
            });
        }

        function atualizarGraficosTSB(stats) {
            // Atualizar gr√°fico de classifica√ß√£o
            if (graficos['chartTSBClass']) {
                graficos['chartTSBClass'].data.datasets[0].data = [stats.verde, stats.transicao];
                graficos['chartTSBClass'].update();
            }

            // Criar/Atualizar gr√°fico por setor
            if (stats.por_setor && stats.por_setor.length > 0) {
                const ctx = document.getElementById('chartTSBSetor');
                if (ctx) {
                    const labels = stats.por_setor.map(s => s.setortsb ? s.setortsb.substring(0, 25) : 'N/A');
                    const data = stats.por_setor.map(s => s.qtd);

                    if (graficos['chartTSBSetor']) {
                        graficos['chartTSBSetor'].data.labels = labels;
                        graficos['chartTSBSetor'].data.datasets[0].data = data;
                        graficos['chartTSBSetor'].update();
                    } else {
                        graficos['chartTSBSetor'] = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Empresas',
                                    data: data,
                                    backgroundColor: '#66BB6A',
                                    borderRadius: 4
                                }]
                            },
                            options: {
                                indexAxis: 'y',
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: {
                                    y: { ticks: { color: '#a0a0b0', font: { size: 10 } } },
                                    x: { ticks: { color: '#a0a0b0' } }
                                }
                            }
                        });
                    }
                }
            }
        }

        async function verKPIsEmpresa(empresaId, nomeEmpresa) {
            const modal = document.getElementById('modalKPIs');
            const conteudo = document.getElementById('modalKPIsConteudo');
            conteudo.innerHTML = '<p style="text-align:center;color:#a0a0b0;">Carregando KPIs...</p>';
            modal.style.display = 'block';

            try {
                const response = await fetch(`${API_URL}/tsb/empresa/${empresaId}/kpis`);
                const data = await response.json();

                if (data.success) {
                    const emp = data.empresa;
                    const classColor = emp.classificacao === 'VERDE' ? '#4CAF50' : '#FF9800';

                    let html = `
                        <div style="margin-bottom:20px;">
                            <h2 style="color:#66BB6A;margin:0 0 10px 0;">üè¢ ${emp.emissor}</h2>
                            <div style="display:flex;gap:15px;flex-wrap:wrap;">
                                <span style="background:rgba(255,255,255,0.1);padding:5px 12px;border-radius:8px;">CNPJ: ${emp.cnpj}</span>
                                <span style="background:rgba(255,255,255,0.1);padding:5px 12px;border-radius:8px;">Setor: ${emp.setortsb}</span>
                                <span style="background:${classColor};color:white;padding:5px 12px;border-radius:8px;">${emp.classificacao}</span>
                                <span style="background:rgba(255,255,255,0.1);padding:5px 12px;border-radius:8px;">Score: <strong>${emp.score}</strong></span>
                            </div>
                        </div>
                        <h3 style="margin:20px 0 15px;">üìä KPIs Obrigat√≥rios do Setor</h3>
                        <p style="color:#a0a0b0;margin-bottom:10px;">Total: ${data.total_kpis} KPIs | Preenchidos: ${data.kpis_preenchidos}</p>
                        <div style="display:flex;gap:20px;margin-bottom:15px;padding:10px;background:rgba(255,255,255,0.02);border-radius:8px;flex-wrap:wrap;">
                            <span style="font-size:0.75rem;display:flex;align-items:center;gap:5px;"><span style="width:10px;height:10px;background:#4CAF50;border-radius:50%;"></span> Verificado - Dado oficial do relat√≥rio</span>
                            <span style="font-size:0.75rem;display:flex;align-items:center;gap:5px;"><span style="width:10px;height:10px;background:#2196F3;border-radius:50%;"></span> Estimado - Calculado/derivado</span>
                            <span style="font-size:0.75rem;display:flex;align-items:center;gap:5px;"><span style="width:10px;height:10px;background:#666;border-radius:50%;"></span> Pendente - N√£o coletado</span>
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
                    `;

                    data.kpis.forEach(kpi => {
                        const obrigColor = kpi.obrigatorio ? '#FF9800' : '#4CAF50';
                        const obrigText = kpi.obrigatorio ? 'Obrigat√≥rio' : 'Opcional';
                        const statusColor = kpi.status === 'Verificado' ? '#4CAF50' :
                                           kpi.status === 'Estimado' ? '#2196F3' : '#666';
                        const valorText = kpi.valor !== null && kpi.valor !== '' ? kpi.valor : '-';
                        const hasValue = kpi.valor !== null && kpi.valor !== '';
                        const borderColor = hasValue ? '#4CAF50' : obrigColor;

                        html += `
                            <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:15px;border-left:3px solid ${borderColor};">
                                <div style="font-size:0.75rem;color:#a0a0b0;">${kpi.codigokpi}</div>
                                <div style="font-size:0.9rem;margin:8px 0;font-weight:500;">${kpi.nomekpi}</div>
                                <div style="font-size:0.75rem;color:#888;">Unidade: ${kpi.unidade || '-'}</div>
                                <div style="background:${hasValue ? 'rgba(76,175,80,0.15)' : 'rgba(100,100,100,0.1)'};padding:8px;border-radius:6px;margin:10px 0;text-align:center;">
                                    <span style="font-size:1.1rem;font-weight:600;color:${hasValue ? '#66BB6A' : '#666'};">${valorText}</span>
                                    <span style="font-size:0.7rem;color:#888;margin-left:5px;">${kpi.unidade || ''}</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;margin-top:10px;">
                                    <span style="font-size:0.75rem;color:${obrigColor};">${obrigText}</span>
                                    <span style="font-size:0.75rem;color:${statusColor};font-weight:500;">${kpi.status}</span>
                                </div>
                            </div>
                        `;
                    });

                    html += '</div>';
                    conteudo.innerHTML = html;
                } else {
                    conteudo.innerHTML = '<p style="color:#f44336;">Erro ao carregar KPIs</p>';
                }
            } catch (e) {
                conteudo.innerHTML = '<p style="color:#f44336;">API n√£o dispon√≠vel</p>';
            }
        }

        function fecharModalKPIs() {
            document.getElementById('modalKPIs').style.display = 'none';
        }

        // Fechar modal ao clicar fora
        document.getElementById('modalKPIs')?.addEventListener('click', function(e) {
            if (e.target === this) fecharModalKPIs();
        });

        // ========== TSB - SE√á√ïES AVAN√áADAS ==========
        let titulosVerdesCarregados = false;
        let fundosSustentaveisCarregados = false;
        let dadosFundosESG = [];

        function mostrarSecaoTSB(secao) {
            // Esconder todas as se√ß√µes
            ['empresas', 'titulos', 'fundos', 'integrado'].forEach(s => {
                const el = document.getElementById(`secaoTsb${s.charAt(0).toUpperCase() + s.slice(1)}`);
                if (el) el.style.display = 'none';

                const btn = document.getElementById(`btnTsb${s.charAt(0).toUpperCase() + s.slice(1)}`);
                if (btn) {
                    btn.style.background = 'var(--card-bg)';
                    btn.style.color = 'var(--text-secondary)';
                }
            });

            // Mostrar se√ß√£o selecionada
            const secaoId = `secaoTsb${secao.charAt(0).toUpperCase() + secao.slice(1)}`;
            const secaoEl = document.getElementById(secaoId);
            if (secaoEl) secaoEl.style.display = 'block';

            // Ativar bot√£o
            const btnId = `btnTsb${secao.charAt(0).toUpperCase() + secao.slice(1)}`;
            const btnEl = document.getElementById(btnId);
            if (btnEl) {
                btnEl.style.background = 'rgba(76,175,80,0.2)';
                btnEl.style.color = '#66BB6A';
            }

            // Carregar dados espec√≠ficos
            if (secao === 'titulos' && !titulosVerdesCarregados) {
                carregarTitulosVerdes();
            } else if (secao === 'fundos' && !fundosSustentaveisCarregados) {
                carregarFundosSustentaveis();
            } else if (secao === 'integrado') {
                carregarSelectEmpresas();
            }
        }

        async function carregarTitulosVerdes() {
            try {
                const response = await fetch(`${API_URL}/tsb/titulos-verdes`);
                const data = await response.json();

                if (data.success) {
                    // Atualizar estat√≠sticas usando a estrutura correta do endpoint
                    document.getElementById('tsbDebenturesVerde').textContent = data.stats.total_verde || 0;
                    document.getElementById('tsbDebenturesTransicao').textContent = data.stats.total_transicao || 0;
                    document.getElementById('tsbEmpresasVerdeDebt').textContent = data.stats.empresas_verde || 0;
                    document.getElementById('tsbScoreVerdeDebt').textContent = data.stats.score_medio_verde ? parseFloat(data.stats.score_medio_verde).toFixed(1) : '-';

                    // Renderizar tabela de t√≠tulos VERDE
                    const corpoVerde = document.getElementById('corpoTitulosVerde');
                    if (data.titulos_verde && data.titulos_verde.length > 0) {
                        let html = '';
                        data.titulos_verde.forEach(t => {
                            const taxa = t.taxaindicativa != null ? parseFloat(t.taxaindicativa).toFixed(2) + '%' : '-';
                            const duration = t.duration != null ? Math.round(parseFloat(t.duration)) : '-';
                            html += `<tr>
                                <td style="max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${t.emissor}">${t.emissor}</td>
                                <td>${t.setortsb || '-'}</td>
                                <td><strong style="color:#66BB6A;">${t.score}</strong></td>
                                <td style="font-family:monospace;">${t.codigoativo || '-'}</td>
                                <td>${t.grupo || '-'}</td>
                                <td>${taxa}</td>
                                <td>${duration}</td>
                            </tr>`;
                        });
                        corpoVerde.innerHTML = html;
                    } else {
                        corpoVerde.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-secondary);">Nenhum t√≠tulo verde encontrado</td></tr>';
                    }

                    // Renderizar tabela de t√≠tulos TRANSI√á√ÉO
                    const corpoTransicao = document.getElementById('corpoTitulosTransicao');
                    if (data.titulos_transicao && data.titulos_transicao.length > 0) {
                        let html = '';
                        data.titulos_transicao.forEach(t => {
                            const taxa = t.taxaindicativa != null ? parseFloat(t.taxaindicativa).toFixed(2) + '%' : '-';
                            const duration = t.duration != null ? Math.round(parseFloat(t.duration)) : '-';
                            html += `<tr>
                                <td style="max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${t.emissor}">${t.emissor}</td>
                                <td>${t.setortsb || '-'}</td>
                                <td><strong style="color:#FFB74D;">${t.score}</strong></td>
                                <td style="font-family:monospace;">${t.codigoativo || '-'}</td>
                                <td>${t.grupo || '-'}</td>
                                <td>${taxa}</td>
                                <td>${duration}</td>
                            </tr>`;
                        });
                        corpoTransicao.innerHTML = html;
                    } else {
                        corpoTransicao.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-secondary);">Nenhum t√≠tulo em transi√ß√£o encontrado</td></tr>';
                    }

                    titulosVerdesCarregados = true;
                }
            } catch (e) {
                console.error('Erro ao carregar t√≠tulos verdes:', e);
                document.getElementById('corpoTitulosVerde').innerHTML = '<tr><td colspan="7" style="text-align:center;color:#EF5350;">Erro ao carregar dados</td></tr>';
            }
        }

        async function carregarFundosSustentaveis() {
            try {
                const response = await fetch(`${API_URL}/tsb/fundos-sustentaveis`);
                const data = await response.json();

                if (data.success) {
                    // Atualizar estat√≠sticas usando estrutura correta do endpoint
                    document.getElementById('tsbFundosTotal').textContent = data.total || 0;
                    document.getElementById('tsbFundosGestoras').textContent = data.stats.total_gestoras || 0;
                    document.getElementById('tsbFundosClasses').textContent = data.stats.por_classe ? data.stats.por_classe.length : 0;

                    // Renderizar lista de gestoras ESG (usa por_gestora ao inv√©s de top_gestoras)
                    const listaGestoras = document.getElementById('listaGestorasESG');
                    const gestoras = data.stats.por_gestora || data.stats.top_gestoras;
                    if (gestoras && gestoras.length > 0) {
                        let html = '<div style="display:flex;flex-direction:column;gap:8px;">';
                        gestoras.slice(0, 10).forEach((g, idx) => {
                            const bgColor = idx === 0 ? 'rgba(76,175,80,0.2)' : 'rgba(255,255,255,0.05)';
                            html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:${bgColor};border-radius:8px;">
                                <span style="max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${g.gestora}">${g.gestora}</span>
                                <span style="background:rgba(156,39,176,0.2);color:#BA68C8;padding:3px 10px;border-radius:12px;font-weight:600;font-size:0.85rem;">${g.qtd}</span>
                            </div>`;
                        });
                        html += '</div>';
                        listaGestoras.innerHTML = html;
                    }

                    // Criar gr√°fico de classes
                    if (data.stats.por_classe && data.stats.por_classe.length > 0) {
                        const ctx = document.getElementById('chartFundosESGClasse');
                        if (ctx) {
                            if (graficos['chartFundosESGClasse']) graficos['chartFundosESGClasse'].destroy();
                            // Filtrar classes v√°lidas e truncar nomes longos
                            const classesValidas = data.stats.por_classe.filter(c => c.classeanbima && c.classeanbima !== 'nan').slice(0, 6);
                            graficos['chartFundosESGClasse'] = new Chart(ctx, {
                                type: 'doughnut',
                                data: {
                                    labels: classesValidas.map(c => c.classeanbima.length > 25 ? c.classeanbima.substring(0, 25) + '...' : c.classeanbima),
                                    datasets: [{
                                        data: classesValidas.map(c => c.qtd),
                                        backgroundColor: ['#9C27B0', '#BA68C8', '#CE93D8', '#E1BEE7', '#F3E5F5', '#7B1FA2'],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { position: 'right', labels: { color: '#fff', font: { size: 9 } } }
                                    }
                                }
                            });
                        }
                    }

                    // Salvar dados para filtro e renderizar tabela
                    dadosFundosESG = data.fundos || [];
                    renderizarTabelaFundosESG(dadosFundosESG);

                    fundosSustentaveisCarregados = true;
                }
            } catch (e) {
                console.error('Erro ao carregar fundos sustent√°veis:', e);
                document.getElementById('corpoFundosESG').innerHTML = '<tr><td colspan="5" style="text-align:center;color:#EF5350;">Erro ao carregar dados</td></tr>';
            }
        }

        function renderizarTabelaFundosESG(fundos) {
            const corpo = document.getElementById('corpoFundosESG');
            if (!fundos || fundos.length === 0) {
                corpo.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-secondary);">Nenhum fundo encontrado</td></tr>';
                return;
            }

            let html = '';
            fundos.slice(0, 100).forEach(f => {
                const publicoIcon = f.publicoalvo === 'Investidor Qualificado' ? 'üéØ' : 'üë§';
                html += `<tr>
                    <td style="max-width:300px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${f.nomecompleto}">${f.nomecompleto}</td>
                    <td style="font-family:monospace;font-size:0.75rem;">${f.cnpj || '-'}</td>
                    <td style="max-width:150px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${f.gestora || ''}">${f.gestora || '-'}</td>
                    <td style="font-size:0.8rem;">${f.classeanbima || '-'}</td>
                    <td style="font-size:0.85rem;">${publicoIcon} ${f.publicoalvo || '-'}</td>
                </tr>`;
            });
            corpo.innerHTML = html;
        }

        function filtrarFundosESG() {
            const termo = document.getElementById('searchFundoESG').value.toLowerCase();
            const filtrados = dadosFundosESG.filter(f =>
                (f.nomecompleto && f.nomecompleto.toLowerCase().includes(termo)) ||
                (f.gestora && f.gestora.toLowerCase().includes(termo)) ||
                (f.cnpj && f.cnpj.includes(termo))
            );
            renderizarTabelaFundosESG(filtrados);
        }

        async function carregarSelectEmpresas() {
            const select = document.getElementById('selectEmpresaIntegrada');
            if (select.options.length > 1) return; // J√° carregado

            try {
                const response = await fetch(`${API_URL}/tsb/empresas`);
                const data = await response.json();

                if (data.success) {
                    data.data.forEach(emp => {
                        const opt = document.createElement('option');
                        opt.value = emp.empresaid;
                        opt.textContent = `${emp.emissor} (${emp.classificacao})`;
                        select.appendChild(opt);
                    });
                }
            } catch (e) {
                console.error('Erro ao carregar empresas:', e);
            }
        }

        async function carregarVisaoIntegrada() {
            const select = document.getElementById('selectEmpresaIntegrada');
            const empresaId = select.value;
            const conteudo = document.getElementById('visaoIntegradaConteudo');

            if (!empresaId) {
                conteudo.innerHTML = `<div style="text-align:center;padding:40px;color:var(--text-secondary);">
                    <div style="font-size:3rem;margin-bottom:15px;">üè¢</div>
                    <p>Selecione uma empresa acima para ver a vis√£o integrada</p>
                </div>`;
                return;
            }

            conteudo.innerHTML = '<div style="text-align:center;padding:40px;"><p style="color:var(--text-secondary);">Carregando dados...</p></div>';

            try {
                const response = await fetch(`${API_URL}/tsb/empresa/${empresaId}/investimentos`);
                const data = await response.json();

                if (data.success) {
                    const emp = data.empresa;
                    const classColor = emp.classificacao === 'VERDE' ? '#4CAF50' : '#FF9800';
                    const stats = data.stats || {};

                    let html = `
                        <div style="background:linear-gradient(135deg,rgba(76,175,80,0.1) 0%,rgba(0,150,136,0.1) 100%);border-radius:12px;padding:20px;margin-bottom:20px;">
                            <div style="display:flex;align-items:center;gap:15px;margin-bottom:15px;">
                                <div style="font-size:2.5rem;">üè¢</div>
                                <div>
                                    <h3 style="margin:0;color:#66BB6A;">${emp.emissor}</h3>
                                    <p style="margin:5px 0 0;color:var(--text-secondary);">${emp.setortsb}</p>
                                </div>
                                <span style="margin-left:auto;background:${classColor};color:white;padding:8px 16px;border-radius:20px;font-weight:600;">${emp.classificacao}</span>
                            </div>
                            <div style="display:flex;gap:20px;flex-wrap:wrap;">
                                <span style="background:rgba(255,255,255,0.1);padding:8px 15px;border-radius:8px;">CNPJ: <strong>${emp.cnpj}</strong></span>
                                <span style="background:rgba(255,255,255,0.1);padding:8px 15px;border-radius:8px;">Score: <strong style="color:#66BB6A;">${emp.score}</strong></span>
                            </div>
                        </div>

                        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:20px;">
                            <div class="stat-card" style="border-left:4px solid #42A5F5;">
                                <div class="label">Deb√™ntures</div>
                                <div class="value text-primary">${stats.total_debentures || 0}</div>
                            </div>
                            <div class="stat-card" style="border-left:4px solid #00BCD4;">
                                <div class="label">CRI/CRA</div>
                                <div class="value text-info">${stats.total_cricra || 0}</div>
                            </div>
                            <div class="stat-card" style="border-left:4px solid #9C27B0;">
                                <div class="label">Fundos Relacionados</div>
                                <div class="value" style="color:#BA68C8;">${stats.total_fundos || 0}</div>
                            </div>
                        </div>`;

                    // Se√ß√£o de Deb√™ntures
                    html += `<div class="chart-card" style="margin-bottom:15px;">
                        <h4 style="color:#42A5F5;margin:0 0 15px;">üìú Deb√™ntures Emitidas</h4>`;

                    if (data.debentures && data.debentures.length > 0) {
                        html += `<div style="overflow-x:auto;"><table style="width:100%;font-size:0.85rem;">
                            <thead><tr><th>C√≥digo</th><th>Grupo</th><th>Taxa</th><th>Duration</th></tr></thead><tbody>`;
                        data.debentures.forEach(d => {
                            const taxa = d.taxaindicativa != null ? parseFloat(d.taxaindicativa).toFixed(2) + '%' : '-';
                            const duration = d.duration != null ? Math.round(parseFloat(d.duration)) : '-';
                            html += `<tr>
                                <td style="font-family:monospace;">${d.codigoativo || '-'}</td>
                                <td>${d.grupo || '-'}</td>
                                <td>${taxa}</td>
                                <td>${duration}</td>
                            </tr>`;
                        });
                        html += '</tbody></table></div>';
                    } else {
                        html += '<p style="color:var(--text-secondary);text-align:center;padding:20px;">Nenhuma deb√™nture encontrada para esta empresa</p>';
                    }
                    html += '</div>';

                    // Se√ß√£o de CRI/CRA
                    if (data.cricra && data.cricra.length > 0) {
                        html += `<div class="chart-card" style="margin-bottom:15px;">
                            <h4 style="color:#00BCD4;margin:0 0 15px;">üè† CRI/CRA</h4>
                            <div style="overflow-x:auto;"><table style="width:100%;font-size:0.85rem;">
                            <thead><tr><th>Tipo</th><th>C√≥digo</th><th>Taxa</th><th>Duration</th></tr></thead><tbody>`;
                        data.cricra.forEach(c => {
                            const taxa = c.taxaindicativa != null ? parseFloat(c.taxaindicativa).toFixed(2) + '%' : '-';
                            const duration = c.duration != null ? Math.round(parseFloat(c.duration)) : '-';
                            html += `<tr>
                                <td>${c.tipocontrato || '-'}</td>
                                <td style="font-family:monospace;">${c.codigoativo || '-'}</td>
                                <td>${taxa}</td>
                                <td>${duration}</td>
                            </tr>`;
                        });
                        html += '</tbody></table></div></div>';
                    }

                    // Se√ß√£o de Fundos Relacionados
                    html += `<div class="chart-card">
                        <h4 style="color:#BA68C8;margin:0 0 15px;">üíö Fundos Sustent√°veis do Setor (${emp.setortsb})</h4>`;

                    if (data.fundos_relacionados && data.fundos_relacionados.length > 0) {
                        html += `<div style="overflow-x:auto;max-height:250px;"><table style="width:100%;font-size:0.85rem;">
                            <thead><tr><th>Fundo</th><th>Gestora</th><th>Classe</th></tr></thead><tbody>`;
                        data.fundos_relacionados.forEach(f => {
                            html += `<tr>
                                <td style="max-width:250px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${f.nomecompleto}">${f.nomecompleto}</td>
                                <td style="max-width:150px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${f.gestora || '-'}</td>
                                <td style="font-size:0.8rem;">${f.classeanbima || '-'}</td>
                            </tr>`;
                        });
                        html += '</tbody></table></div>';
                    } else {
                        html += '<p style="color:var(--text-secondary);text-align:center;padding:20px;">Nenhum fundo ESG relacionado ao setor encontrado</p>';
                    }
                    html += '</div>';

                    // Bot√£o para ver KPIs
                    html += `<div style="margin-top:20px;text-align:center;">
                        <button onclick="verKPIsEmpresa(${emp.empresaid}, '${emp.emissor.replace(/'/g, "\\'")}')" style="background:linear-gradient(135deg,#4CAF50,#2E7D32);color:white;border:none;padding:12px 30px;border-radius:8px;cursor:pointer;font-size:1rem;font-weight:600;">
                            üìä Ver KPIs Obrigat√≥rios
                        </button>
                    </div>`;

                    conteudo.innerHTML = html;
                } else {
                    conteudo.innerHTML = '<div style="text-align:center;padding:40px;color:#EF5350;">Empresa n√£o encontrada</div>';
                }
            } catch (e) {
                console.error('Erro ao carregar vis√£o integrada:', e);
                conteudo.innerHTML = '<div style="text-align:center;padding:40px;color:#EF5350;">Erro de conex√£o</div>';
            }
        }

        // ========== RISK SCORING ==========
        let riskScoringCarregado = false;

        async function carregarRiskScoring() {
            if (riskScoringCarregado) return;
            try {
                const response = await fetch(`${API_URL}/risk-scoring`);
                const data = await response.json();

                if (data.success) {
                    // Score Global
                    document.getElementById('riskScoreGlobal').textContent = data.resumo.risk_score_global.toFixed(1);
                    document.getElementById('riskScoreGlobal').style.color = data.resumo.rating.color;
                    document.getElementById('riskRatingGlobal').textContent = `${data.resumo.rating.grade} - ${data.resumo.rating.label}`;
                    document.getElementById('riskRatingGlobal').style.color = data.resumo.rating.color;

                    // Scores individuais
                    const updateScore = (id, score) => {
                        document.getElementById(id).textContent = score.valor.toFixed(1);
                        document.getElementById(id).style.color = score.rating.color;
                        document.getElementById(id + 'Label').textContent = `${score.rating.grade} - ${score.rating.label}`;
                        document.getElementById(id + 'Label').style.color = score.rating.color;
                    };
                    updateScore('riskESG', data.scores.esg);
                    updateScore('riskCredito', data.scores.credito);
                    updateScore('riskConcentracao', data.scores.concentracao);
                    updateScore('riskLiquidez', data.scores.liquidez);
                    updateScore('riskClima', data.scores.clima);

                    // M√©tricas
                    document.getElementById('riskTotalAtivos').textContent = data.resumo.total_ativos.toLocaleString();
                    document.getElementById('riskTotalDebentures').textContent = data.credito.total_debentures;
                    document.getElementById('riskTaxaMedia').textContent = data.credito.taxa_media.toFixed(2) + '%';
                    document.getElementById('riskDurationMedia').textContent = data.credito.duration_media + ' dias';
                    document.getElementById('riskHHI').textContent = data.concentracao.hhi.toFixed(0);

                    // Gr√°fico Radar
                    const ctxRadar = document.getElementById('chartRiskRadar');
                    if (ctxRadar) {
                        if (graficos['chartRiskRadar']) graficos['chartRiskRadar'].destroy();
                        graficos['chartRiskRadar'] = new Chart(ctxRadar, {
                            type: 'radar',
                            data: {
                                labels: ['ESG', 'Cr√©dito', 'Concentra√ß√£o', 'Liquidez', 'Clima'],
                                datasets: [{
                                    label: 'Risco',
                                    data: [data.scores.esg.valor, data.scores.credito.valor, data.scores.concentracao.valor, data.scores.liquidez.valor, data.scores.clima.valor],
                                    fill: true,
                                    backgroundColor: 'rgba(255, 152, 0, 0.2)',
                                    borderColor: '#FF9800',
                                    pointBackgroundColor: '#FF9800',
                                    pointBorderColor: '#fff'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    r: {
                                        beginAtZero: true,
                                        max: 100,
                                        ticks: { color: '#a0a0b0', stepSize: 20 },
                                        grid: { color: 'rgba(255,255,255,0.1)' },
                                        pointLabels: { color: '#fff', font: { size: 11 } }
                                    }
                                },
                                plugins: { legend: { display: false } }
                            }
                        });
                    }

                    // Gr√°fico Spread por Indexador
                    const ctxSpread = document.getElementById('chartSpreadIndexador');
                    if (ctxSpread && data.indexadores && data.indexadores.length > 0) {
                        if (graficos['chartSpreadIndexador']) graficos['chartSpreadIndexador'].destroy();
                        graficos['chartSpreadIndexador'] = new Chart(ctxSpread, {
                            type: 'bar',
                            data: {
                                labels: data.indexadores.map(i => i.grupo || 'N/A'),
                                datasets: [{
                                    label: 'Quantidade',
                                    data: data.indexadores.map(i => i.qtd),
                                    backgroundColor: '#42A5F5',
                                    borderRadius: 4
                                }, {
                                    label: 'Taxa M√©dia (%)',
                                    data: data.indexadores.map(i => i.taxa_media ? parseFloat(i.taxa_media).toFixed(2) : 0),
                                    backgroundColor: '#FF9800',
                                    borderRadius: 4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { position: 'top', labels: { color: '#fff' } } },
                                scales: {
                                    y: { ticks: { color: '#a0a0b0' } },
                                    x: { ticks: { color: '#a0a0b0' } }
                                }
                            }
                        });
                    }

                    // Gr√°fico Concentra√ß√£o por Setor
                    const ctxConc = document.getElementById('chartConcentracao');
                    if (ctxConc && data.concentracao.por_setor && data.concentracao.por_setor.length > 0) {
                        if (graficos['chartConcentracao']) graficos['chartConcentracao'].destroy();
                        graficos['chartConcentracao'] = new Chart(ctxConc, {
                            type: 'doughnut',
                            data: {
                                labels: data.concentracao.por_setor.slice(0, 8).map(s => s.setortsb ? s.setortsb.substring(0, 15) : 'N/A'),
                                datasets: [{
                                    data: data.concentracao.por_setor.slice(0, 8).map(s => s.qtd),
                                    backgroundColor: ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#00BCD4', '#F44336', '#8BC34A', '#FF5722'],
                                    borderWidth: 0
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { position: 'right', labels: { color: '#fff', font: { size: 10 } } } }
                            }
                        });
                    }

                    // Gr√°fico Liquidez (Duration)
                    const ctxLiq = document.getElementById('chartLiquidez');
                    if (ctxLiq) {
                        if (graficos['chartLiquidez']) graficos['chartLiquidez'].destroy();
                        graficos['chartLiquidez'] = new Chart(ctxLiq, {
                            type: 'doughnut',
                            data: {
                                labels: ['Curto Prazo (<1 ano)', 'M√©dio Prazo (1-3 anos)', 'Longo Prazo (>3 anos)'],
                                datasets: [{
                                    data: [data.liquidez.curto_prazo, data.liquidez.medio_prazo, data.liquidez.longo_prazo],
                                    backgroundColor: ['#4CAF50', '#FFC107', '#F44336'],
                                    borderWidth: 0
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { position: 'right', labels: { color: '#fff' } } }
                            }
                        });
                    }

                    // Tabela Empresas Maior Risco
                    const corpoRisco = document.getElementById('corpoEmpresasRisco');
                    if (corpoRisco && data.alertas.empresas_maior_risco) {
                        let html = '';
                        data.alertas.empresas_maior_risco.forEach(e => {
                            const classColor = e.classificacao === 'VERDE' ? '#4CAF50' : '#FF9800';
                            html += `<tr>
                                <td style="max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${e.emissor}">${e.emissor}</td>
                                <td style="font-size:0.8rem;">${e.setortsb || '-'}</td>
                                <td><span style="background:${classColor};color:white;padding:2px 8px;border-radius:10px;font-size:0.75rem;">${e.classificacao}</span></td>
                                <td style="font-weight:600;color:#F44336;">${e.score}</td>
                            </tr>`;
                        });
                        corpoRisco.innerHTML = html;
                    }

                    // Tabela Top Emissores
                    const corpoEmissores = document.getElementById('corpoTopEmissores');
                    if (corpoEmissores && data.alertas.top_emissores) {
                        let html = '';
                        data.alertas.top_emissores.forEach(e => {
                            const taxa = e.taxa_media ? parseFloat(e.taxa_media).toFixed(2) + '%' : '-';
                            html += `<tr>
                                <td style="max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${e.emissor}">${e.emissor}</td>
                                <td style="font-weight:600;color:#42A5F5;">${e.qtd}</td>
                                <td>${taxa}</td>
                            </tr>`;
                        });
                        corpoEmissores.innerHTML = html;
                    }

                    riskScoringCarregado = true;
                }
            } catch (e) {
                console.error('Erro ao carregar Risk Scoring:', e);
                document.getElementById('riskRatingGlobal').textContent = 'Erro ao carregar';
                document.getElementById('riskRatingGlobal').style.color = '#F44336';
            }
        }

        // ========== EARLY WARNING ==========
        let earlyWarningCarregado = false;

        async function carregarEarlyWarning() {
            if (earlyWarningCarregado) return;
            try {
                const response = await fetch(`${API_URL}/early-warning`);
                const data = await response.json();

                if (data.success) {
                    // Atualizar resumo
                    document.getElementById('ewCriticos').textContent = data.resumo.criticos;
                    document.getElementById('ewMedios').textContent = data.resumo.medios;
                    document.getElementById('ewBaixos').textContent = data.resumo.baixos;

                    // Renderizar alertas
                    const container = document.getElementById('ewAlertasContainer');
                    if (data.alertas.length === 0) {
                        container.innerHTML = `
                            <div class="chart-card" style="text-align:center;padding:40px;background:rgba(76,175,80,0.1);border-color:rgba(76,175,80,0.3);">
                                <div style="font-size:3rem;margin-bottom:15px;">‚úÖ</div>
                                <h3 style="color:#66BB6A;margin:0;">Nenhum Alerta Ativo</h3>
                                <p style="color:#A5D6A7;margin-top:10px;">O portfolio est√° dentro dos par√¢metros normais de risco</p>
                            </div>`;
                    } else {
                        container.innerHTML = data.alertas.map(alerta => {
                            const corSeveridade = {
                                'alta': { bg: 'rgba(244,67,54,0.15)', border: 'rgba(244,67,54,0.4)', text: '#F44336', badge: '#F44336' },
                                'media': { bg: 'rgba(255,152,0,0.15)', border: 'rgba(255,152,0,0.4)', text: '#FF9800', badge: '#FF9800' },
                                'baixa': { bg: 'rgba(76,175,80,0.15)', border: 'rgba(76,175,80,0.4)', text: '#4CAF50', badge: '#4CAF50' }
                            }[alerta.severidade] || { bg: 'rgba(255,255,255,0.05)', border: 'var(--border-color)', text: 'var(--text-primary)', badge: '#666' };

                            return `
                                <div class="chart-card" style="background:${corSeveridade.bg};border-color:${corSeveridade.border};">
                                    <div style="display:flex;align-items:flex-start;gap:15px;">
                                        <div style="font-size:2rem;">${alerta.icone}</div>
                                        <div style="flex:1;">
                                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                                                <h3 style="color:${corSeveridade.text};margin:0;">${alerta.titulo}</h3>
                                                <span style="padding:3px 8px;border-radius:4px;font-size:0.7rem;font-weight:600;background:${corSeveridade.badge};color:white;text-transform:uppercase;">${alerta.severidade}</span>
                                            </div>
                                            <p style="color:var(--text-secondary);margin:0 0 10px 0;">${alerta.descricao}</p>
                                            ${alerta.detalhes && alerta.detalhes.length > 0 ? `
                                                <div style="background:rgba(0,0,0,0.2);border-radius:6px;padding:10px;margin-top:10px;">
                                                    <div style="font-size:0.75rem;color:#a0a0b0;margin-bottom:5px;">Detalhes:</div>
                                                    <ul style="margin:0;padding-left:20px;font-size:0.85rem;color:var(--text-secondary);">
                                                        ${alerta.detalhes.map(d => `<li>${d}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>`;
                        }).join('');
                    }

                    earlyWarningCarregado = true;
                }
            } catch (e) {
                console.error('Erro ao carregar Early Warning:', e);
                document.getElementById('ewAlertasContainer').innerHTML = `
                    <div class="chart-card" style="text-align:center;padding:40px;">
                        <div style="font-size:2rem;margin-bottom:10px;">‚ùå</div>
                        <p style="color:#F44336;">Erro ao carregar alertas</p>
                    </div>`;
            }
        }

        // ========== DEBT ANALYSIS ==========
        let debtAnalysisCarregado = false;

        async function carregarDebtAnalysis() {
            console.log('=== carregarDebtAnalysis INICIADO ===');
            if (debtAnalysisCarregado) {
                console.log('Debt Analysis j√° carregado, pulando...');
                return;
            }
            try {
                console.log('Fazendo fetch para:', API_URL + '/debt-analysis');
                const response = await fetch(`${API_URL}/debt-analysis`);
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Dados JSON recebidos:', JSON.stringify(data).substring(0, 500));

                if (data.success) {
                    console.log('=== Dados SUCCESS - Processando ===');

                    // Resumo (converter strings para n√∫meros)
                    const valorTotal = parseFloat(data.resumo.valor_total) || 0;
                    const puMedio = parseFloat(data.resumo.pu_medio) || 0;
                    console.log('Valores parseados - valorTotal:', valorTotal, 'puMedio:', puMedio);

                    // Verificar elementos existem
                    const elDebtTotal = document.getElementById('debtTotal');
                    const elDebtValorTotal = document.getElementById('debtValorTotal');
                    const elDebtPUMedio = document.getElementById('debtPUMedio');
                    const elDebtDurationMedia = document.getElementById('debtDurationMedia');

                    console.log('Elementos encontrados:', {
                        debtTotal: !!elDebtTotal,
                        debtValorTotal: !!elDebtValorTotal,
                        debtPUMedio: !!elDebtPUMedio,
                        debtDurationMedia: !!elDebtDurationMedia
                    });

                    if (elDebtTotal) elDebtTotal.textContent = data.resumo.total_debentures;
                    if (elDebtValorTotal) elDebtValorTotal.textContent = 'R$ ' + (valorTotal / 1000).toFixed(1) + 'K';
                    if (elDebtPUMedio) elDebtPUMedio.textContent = 'R$ ' + puMedio.toFixed(2);

                    // Duration m√©dia (calcular m√©dia de todos os indexadores)
                    const duracoes = Object.values(data.duration_por_indexador || {});
                    const duracaoMedia = duracoes.length > 0 ? duracoes.reduce((a, b) => a + b, 0) / duracoes.length : 0;
                    console.log('Duracoes:', duracoes, 'Media:', duracaoMedia);
                    if (elDebtDurationMedia) elDebtDurationMedia.textContent = Math.round(duracaoMedia) + ' dias';

                    // Gr√°fico por indexador
                    const ctxIndexador = document.getElementById('chartDebtIndexador');
                    console.log('Canvas chartDebtIndexador:', ctxIndexador ? 'encontrado' : 'NAO encontrado');
                    console.log('por_indexador length:', data.por_indexador ? data.por_indexador.length : 'undefined');
                    if (ctxIndexador && data.por_indexador && data.por_indexador.length > 0) {
                        try {
                            if (graficos['chartDebtIndexador']) graficos['chartDebtIndexador'].destroy();
                            graficos['chartDebtIndexador'] = new Chart(ctxIndexador, {
                                type: 'doughnut',
                                data: {
                                    labels: data.por_indexador.map(i => i.grupo || 'N/A'),
                                    datasets: [{
                                        data: data.por_indexador.map(i => i.qtd),
                                        backgroundColor: ['#42A5F5', '#66BB6A', '#FF9800', '#9C27B0', '#00BCD4']
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { position: 'right', labels: { color: '#fff', font: { size: 11 } } }
                                    }
                                }
                            });
                            console.log('Grafico chartDebtIndexador criado com sucesso');
                        } catch (chartErr) {
                            console.error('Erro ao criar chartDebtIndexador:', chartErr);
                        }
                    }

                    // Gr√°fico por faixa de taxa
                    const ctxTaxa = document.getElementById('chartDebtTaxa');
                    console.log('Canvas chartDebtTaxa:', ctxTaxa ? 'encontrado' : 'NAO encontrado');
                    console.log('por_faixa_taxa length:', data.por_faixa_taxa ? data.por_faixa_taxa.length : 'undefined');
                    if (ctxTaxa && data.por_faixa_taxa && data.por_faixa_taxa.length > 0) {
                        try {
                            if (graficos['chartDebtTaxa']) graficos['chartDebtTaxa'].destroy();
                            graficos['chartDebtTaxa'] = new Chart(ctxTaxa, {
                                type: 'bar',
                                data: {
                                    labels: data.por_faixa_taxa.map(f => f.faixa),
                                    datasets: [{
                                        label: 'Quantidade',
                                        data: data.por_faixa_taxa.map(f => f.qtd),
                                        backgroundColor: ['#4CAF50', '#8BC34A', '#FF9800', '#F44336']
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: { legend: { display: false } },
                                    scales: {
                                        x: { ticks: { color: '#a0a0b0' }, grid: { display: false } },
                                        y: { ticks: { color: '#a0a0b0' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                                    }
                                }
                            });
                            console.log('Grafico chartDebtTaxa criado com sucesso');
                        } catch (chartErr) {
                            console.error('Erro ao criar chartDebtTaxa:', chartErr);
                        }
                    }

                    // Tabela top emissores
                    const tbody = document.getElementById('debtTopEmissores');
                    console.log('Tbody debtTopEmissores:', tbody ? 'encontrado' : 'NAO encontrado');
                    console.log('top_emissores length:', data.top_emissores ? data.top_emissores.length : 'undefined');
                    if (tbody && data.top_emissores && data.top_emissores.length > 0) {
                        tbody.innerHTML = data.top_emissores.map(e => {
                            const valorTotal = parseFloat(e.valor_total) || 0;
                            const taxaMedia = parseFloat(e.taxa_media) || 0;
                            return `
                            <tr>
                                <td title="${e.emissor}">${e.emissor.substring(0, 35)}${e.emissor.length > 35 ? '...' : ''}</td>
                                <td style="text-align:center;">${e.qtd_titulos}</td>
                                <td style="text-align:right;">R$ ${valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                                <td style="text-align:right;color:#FF9800;">${taxaMedia > 0 ? taxaMedia.toFixed(2) + '%' : '-'}</td>
                            </tr>`;
                        }).join('');
                        console.log('Tabela top emissores preenchida');
                    }

                    debtAnalysisCarregado = true;
                    console.log('=== DEBT ANALYSIS CARREGADO COM SUCESSO ===');
                } else {
                    console.log('API retornou success: false');
                }
            } catch (e) {
                console.error('=== ERRO ao carregar Debt Analysis ===', e);
                console.error('Stack:', e.stack);
            }
        }

        // Fun√ß√£o de teste global para debug
        window.testarDebtAnalysis = function() {
            console.log('Teste manual: resetando flag e carregando...');
            debtAnalysisCarregado = false;
            carregarDebtAnalysis();
        };

        // ========== VENCIMENTOS ==========
        let vencimentosCarregado = false;

        async function carregarVencimentos() {
            if (vencimentosCarregado) return;
            try {
                const response = await fetch(`${API_URL}/vencimentos`);
                const data = await response.json();

                if (data.success) {
                    // Duration stats
                    document.getElementById('vencDurationMin').textContent = data.duration_stats.minima;
                    document.getElementById('vencDurationMedia').textContent = data.duration_stats.media;
                    document.getElementById('vencDurationMax').textContent = data.duration_stats.maxima;

                    // Gr√°fico por faixa (quantidade)
                    const ctxFaixa = document.getElementById('chartVencFaixa');
                    if (ctxFaixa && data.por_faixa.length > 0) {
                        if (graficos['chartVencFaixa']) graficos['chartVencFaixa'].destroy();
                        graficos['chartVencFaixa'] = new Chart(ctxFaixa, {
                            type: 'bar',
                            data: {
                                labels: data.por_faixa.map(f => f.faixa),
                                datasets: [{
                                    label: 'Quantidade',
                                    data: data.por_faixa.map(f => f.qtd),
                                    backgroundColor: ['#4CAF50', '#8BC34A', '#FFEB3B', '#FF9800', '#F44336']
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: {
                                    x: { ticks: { color: '#a0a0b0' }, grid: { display: false } },
                                    y: { ticks: { color: '#a0a0b0' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                                }
                            }
                        });
                    }

                    // Gr√°fico por faixa (valor)
                    const ctxValor = document.getElementById('chartVencValor');
                    if (ctxValor && data.por_faixa.length > 0) {
                        if (graficos['chartVencValor']) graficos['chartVencValor'].destroy();
                        graficos['chartVencValor'] = new Chart(ctxValor, {
                            type: 'doughnut',
                            data: {
                                labels: data.por_faixa.map(f => f.faixa),
                                datasets: [{
                                    data: data.por_faixa.map(f => parseFloat(f.valor) || 0),
                                    backgroundColor: ['#4CAF50', '#8BC34A', '#FFEB3B', '#FF9800', '#F44336']
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { position: 'right', labels: { color: '#fff', font: { size: 10 } } }
                                }
                            }
                        });
                    }

                    // Tabela pr√≥ximos vencimentos
                    const tbody = document.getElementById('vencProximos');
                    tbody.innerHTML = data.proximos_vencimentos.map(v => {
                        const duration = parseFloat(v.duration) || 0;
                        const pu = parseFloat(v.pu) || 0;
                        const corDuration = duration < 365 ? '#F44336' : duration < 730 ? '#FF9800' : '#4CAF50';
                        return `
                        <tr>
                            <td style="font-weight:600;color:#42A5F5;">${v.codigoativo}</td>
                            <td title="${v.emissor}">${v.emissor.substring(0, 30)}${v.emissor.length > 30 ? '...' : ''}</td>
                            <td>${v.grupo || '-'}</td>
                            <td style="color:#FF9800;">${v.taxaindicativa || '-'}</td>
                            <td style="text-align:center;font-weight:600;color:${corDuration};">${Math.round(duration)} dias</td>
                            <td style="text-align:right;">R$ ${pu.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        </tr>`;
                    }).join('');

                    vencimentosCarregado = true;
                }
            } catch (e) {
                console.error('Erro ao carregar Vencimentos:', e);
            }
        }

        // Inicializar quando abrir a aba Explorar, CRI/CRA, TSB ou Risk Scoring
        const originalShowTabAPI = showTab;
        showTab = function(tabId, event) {
            console.log('showTab chamado (override API) - tabId:', tabId);
            originalShowTabAPI(tabId, event);
            if (tabId === 'explorar') {
                verificarAPI();
                buscarFundosAPI(); // Carregar fundos automaticamente
            } else if (tabId === 'cri-cra') {
                carregarCRICRA();
            } else if (tabId === 'tsb') {
                carregarTSB();
            } else if (tabId === 'risk-scoring') {
                carregarRiskScoring();
            } else if (tabId === 'early-warning') {
                carregarEarlyWarning();
            } else if (tabId === 'favoritos') {
                carregarFavoritos();
            } else if (tabId === 'debt-analysis') {
                console.log('Chamando carregarDebtAnalysis()...');
                carregarDebtAnalysis();
            } else if (tabId === 'vencimentos') {
                carregarVencimentos();
            } else if (tabId === 'fundos-is') {
                carregarFundosESGAnbima('tabelaFundosIS', 'corpoFundosIS', 'loadingFundosIS', 'countFundosESG');
            } else if (tabId === 'fundos-esg') {
                carregarFundosESGAnbima('tabelaFundosESG', 'corpoFundosESG', 'loadingFundosESG', 'countFundosESG2');
            } else if (tabId === 'debentures') {
                // Carregar deb√™ntures da API
                carregarDebentures();
            } else if (tabId === 'titulos-publicos') {
                // Carregar t√≠tulos p√∫blicos da API
                carregarTitulosPublicos();
            }
        };

        // ========== EXPLORAR FUNDOS (dados locais - backup) ==========
        const baseFundos = [
            // Fundos IS (18)
            { nome: "BTG Pactual Credito Corporativo IS", cnpj: "40.123.456/0001-01", gestora: "BTG Pactual Asset Management", categoria: "Renda Fixa", tipo: "IS", foco: "Ambiental" },
            { nome: "Itau Transicao Energetica IS", cnpj: "40.123.456/0001-02", gestora: "Itau Asset Management", categoria: "Multimercado", tipo: "IS", foco: "Ambiental" },
            { nome: "BB Acoes Sustentabilidade IS", cnpj: "40.123.456/0001-03", gestora: "BB Asset Management", categoria: "A√ß√µes", tipo: "IS", foco: "Multi-tema" },
            { nome: "Bradesco FIA ISE IS", cnpj: "40.123.456/0001-04", gestora: "Bradesco Asset Management", categoria: "A√ß√µes", tipo: "IS", foco: "Multi-tema" },
            { nome: "XP Debentures Incentivadas IS", cnpj: "40.123.456/0001-05", gestora: "XP Asset Management", categoria: "Renda Fixa", tipo: "IS", foco: "Ambiental" },
            { nome: "JGP Impacto Social IS", cnpj: "40.123.456/0001-06", gestora: "JGP Asset Management", categoria: "Multimercado", tipo: "IS", foco: "Social" },
            { nome: "SANTANDER ETHICAL A√á√ïES SUSTENTABILIDADE SPECIAL IS", cnpj: "04.616.277/0001-02", gestora: "Santander Asset Management", categoria: "A√ß√µes", tipo: "IS", foco: "Multi-tema" },
            { nome: "SANTANDER ETHICAL A√á√ïES SUSTENTABILIDADE IS FUNDO", cnpj: "04.736.006/0001-82", gestora: "Santander Asset Management", categoria: "A√ß√µes", tipo: "IS", foco: "Multi-tema" },
            { nome: "ITA√ö EXCEL√äNCIA SOCIAL A√á√ïES FUNDO DE INVESTIMENTO", cnpj: "06.069.957/0001-70", gestora: "Itau Asset Management", categoria: "A√ß√µes", tipo: "IS", foco: "Social" },
            { nome: "ITA√ö EXCEL√äNCIA SOCIAL A√á√ïES FI II", cnpj: "06.215.101/0001-66", gestora: "Itau Asset Management", categoria: "A√ß√µes", tipo: "IS", foco: "Social" },
            { nome: "BB TOP ACOES INDICE DE SUSTENTABILIDADE EMPRESARIAL", cnpj: "05.775.731/0001-22", gestora: "BB Asset Management", categoria: "A√ß√µes", tipo: "IS", foco: "Multi-tema" },
            { nome: "BB A√á√ïES SUSTENTABILIDADE IS FUNDO DE INVESTIMENTO", cnpj: "06.349.816/0001-01", gestora: "BB Asset Management", categoria: "A√ß√µes", tipo: "IS", foco: "Multi-tema" },
            { nome: "ITA√ö GOVERNAN√áA CORPORATIVA A√á√ïES FI", cnpj: "07.686.680/0001-98", gestora: "Itau Asset Management", categoria: "A√ß√µes", tipo: "IS", foco: "Multi-tema" },
            { nome: "ITA√ö A√á√ïES GOVERNAN√áA CORPORATIVA FI", cnpj: "07.686.658/0001-48", gestora: "Itau Asset Management", categoria: "A√ß√µes", tipo: "IS", foco: "Multi-tema" },
            { nome: "ITA√ö PRIVATE EXCEL√äNCIA SOCIAL A√á√ïES FI", cnpj: "07.707.678/0001-58", gestora: "Itau Asset Management", categoria: "A√ß√µes", tipo: "IS", foco: "Social" },
            { nome: "FUNDO DE INVESTIMENTO EM A√á√ïES CAIXA SUSTENTABILIDADE", cnpj: "08.070.838/0001-63", gestora: "Caixa Asset Management", categoria: "A√ß√µes", tipo: "IS", foco: "Governanca" },
            { nome: "BRADESCO FI EM A√á√ïES IS SUSTENTABILIDADE", cnpj: "07.187.751/0001-08", gestora: "Bradesco Asset Management", categoria: "A√ß√µes", tipo: "IS", foco: "Multi-tema" },
            { nome: "ITA√ö EMPRESA GOVERNAN√áA CORPORATIVA A√á√ïES FI", cnpj: "09.145.127/0001-73", gestora: "Itau Asset Management", categoria: "A√ß√µes", tipo: "IS", foco: "Multi-tema" },

            // Fundos ESG Integrado (29)
            { nome: "Verde AM ESG Selection", cnpj: "40.123.456/0001-07", gestora: "Verde Asset Management", categoria: "Multimercado", tipo: "ESG", foco: "Multi-tema" },
            { nome: "Opportunity ESG FIA", cnpj: "40.123.456/0001-08", gestora: "Opportunity Asset Management", categoria: "A√ß√µes", tipo: "ESG", foco: "Ambiental" },
            { nome: "BTG ESG Corporativo", cnpj: "40.123.456/0001-09", gestora: "BTG Pactual Asset Management", categoria: "Renda Fixa", tipo: "ESG", foco: "Governanca" },
            { nome: "Itau Governanca Responsavel", cnpj: "40.123.456/0001-10", gestora: "Itau Asset Management", categoria: "A√ß√µes", tipo: "ESG", foco: "Governanca" },
            { nome: "CSHG VERDE FIC FI MULTIMERCADO", cnpj: "01.221.890/0001-24", gestora: "Credit Suisse Hedging-Griffo", categoria: "Multimercado", tipo: "ESG", foco: "Ambiental" },
            { nome: "CSHG VERDE AM STRATEGY II FIC FI MULTIMERCADO", cnpj: "03.408.336/0001-86", gestora: "Credit Suisse Hedging-Griffo", categoria: "Multimercado", tipo: "ESG", foco: "Ambiental" },
            { nome: "VERDE PVT MULTIMERCADO FIC FI", cnpj: "04.222.368/0001-55", gestora: "Verde Asset Management", categoria: "Multimercado", tipo: "ESG", foco: "Ambiental" },
            { nome: "CSHG ALLOCATION VERDE 14 FIC FI MULTIMERCADO", cnpj: "04.147.027/0001-62", gestora: "Credit Suisse Hedging-Griffo", categoria: "Multimercado", tipo: "ESG", foco: "Ambiental" },
            { nome: "BB RENDA FIXA REFERENCIADO DI SOCIAL 50 FI", cnpj: "05.080.623/0001-35", gestora: "BB Asset Management", categoria: "Renda Fixa", tipo: "ESG", foco: "Social" },
            { nome: "CSHG ALLOCATION VERDE AM AGAR FIC FI MULTIMERCADO", cnpj: "05.491.230/0001-14", gestora: "Credit Suisse Hedging-Griffo", categoria: "Multimercado", tipo: "ESG", foco: "Ambiental" },
            { nome: "WESTERN ASSET PONTA VERDE FI RENDA FIXA", cnpj: "03.888.387/0001-52", gestora: "Western Asset Management", categoria: "Renda Fixa", tipo: "ESG", foco: "Ambiental" },
            { nome: "CSHG VERDE AM HIPER FIC FI MULTIMERCADO", cnpj: "05.586.675/0001-88", gestora: "Credit Suisse Hedging-Griffo", categoria: "Multimercado", tipo: "ESG", foco: "Ambiental" },
            { nome: "SICREDI FI RENDA FIXA CURTO PRAZO", cnpj: "01.627.516/0001-23", gestora: "Sicredi Asset Management", categoria: "Renda Fixa", tipo: "ESG", foco: "Multi-tema" },
            { nome: "CSHG ALLOCATION VERDE 30 FIC FI MULTIMERCADO", cnpj: "05.586.704/0001-01", gestora: "Credit Suisse Hedging-Griffo", categoria: "Multimercado", tipo: "ESG", foco: "Ambiental" },
            { nome: "BRADESCO PRIME FIC FIA IND SUSTENTABILIDADE", cnpj: "07.667.274/0001-88", gestora: "Bradesco Asset Management", categoria: "A√ß√µes", tipo: "ESG", foco: "Multi-tema" },
            { nome: "BRADESCO H FC FI DE A√á√ïES SUSTENTABILIDADE", cnpj: "07.535.827/0001-49", gestora: "Bradesco Asset Management", categoria: "A√ß√µes", tipo: "ESG", foco: "Multi-tema" },
            { nome: "SANTANDER FIC FI A√á√ïES SUSTENTABILIDADE", cnpj: "07.647.132/0001-59", gestora: "Santander Asset Management", categoria: "A√ß√µes", tipo: "ESG", foco: "Ambiental" },
            { nome: "CSHG ALLOCATION VERDE 90 FIC FI MULTIMERCADO", cnpj: "07.455.460/0001-53", gestora: "Credit Suisse Hedging-Griffo", categoria: "Multimercado", tipo: "ESG", foco: "Ambiental" },
            { nome: "VERDE 90 DISTRIBUIDORES FIC FI MULTIMERCADO", cnpj: "07.455.788/0001-70", gestora: "Verde Asset Management", categoria: "Multimercado", tipo: "ESG", foco: "Ambiental" },
            { nome: "VERDE MASTER FI MULTIMERCADO", cnpj: "07.455.507/0001-89", gestora: "Verde Asset Management", categoria: "Multimercado", tipo: "ESG", foco: "Ambiental" },
            { nome: "PS VERDE D1 FIC FI MULTIMERCADO", cnpj: "04.311.271/0001-19", gestora: "Verde Asset Management", categoria: "Multimercado", tipo: "ESG", foco: "Ambiental" },
            { nome: "VERDE AM MULTI ESTRAT√âGIA FI MULTIMERCADO", cnpj: "08.507.696/0001-59", gestora: "Verde Asset Management", categoria: "Multimercado", tipo: "ESG", foco: "Ambiental" },
            { nome: "VERDE AM PERFORMANCE FI A√á√ïES", cnpj: "08.707.235/0001-20", gestora: "Verde Asset Management", categoria: "A√ß√µes", tipo: "ESG", foco: "Ambiental" },
            { nome: "RIO VERDE SMALL CAPS FI A√á√ïES", cnpj: "07.420.595/0001-83", gestora: "Rio Verde Asset Management", categoria: "A√ß√µes", tipo: "ESG", foco: "Ambiental" },
            { nome: "VERDE AM MULTI ALLOCATION BP FIC FI MULTIMERCADO", cnpj: "08.893.097/0001-10", gestora: "Verde Asset Management", categoria: "Multimercado", tipo: "ESG", foco: "Ambiental" },
            { nome: "CSHG VERDE TM FIC FI MULTIMERCADO", cnpj: "09.150.949/0001-42", gestora: "Credit Suisse Hedging-Griffo", categoria: "Multimercado", tipo: "ESG", foco: "Ambiental" },
            { nome: "V√âRTICE VERDE AM JADE FIC FI MULTIMERCADO", cnpj: "09.485.813/0001-93", gestora: "Verde Asset Management", categoria: "Multimercado", tipo: "ESG", foco: "Ambiental" },
            { nome: "VERDE AM JADE FIC FI MULTIMERCADO", cnpj: "09.489.250/0001-01", gestora: "Verde Asset Management", categoria: "Multimercado", tipo: "ESG", foco: "Ambiental" },
            { nome: "FUNDO SOCIAL FI A√á√ïES", cnpj: "10.265.295/0001-81", gestora: "Plural Asset Management", categoria: "A√ß√µes", tipo: "ESG", foco: "Social" },

            // Fundos Convencionais (exemplos representativos)
            { nome: "ITA√ö RENDA FIXA SIMPLES FI", cnpj: "11.123.456/0001-01", gestora: "Itau Asset Management", categoria: "Renda Fixa", tipo: "Convencional", foco: "-" },
            { nome: "BB RF LP ESTILO FI", cnpj: "11.123.456/0001-02", gestora: "BB Asset Management", categoria: "Renda Fixa", tipo: "Convencional", foco: "-" },
            { nome: "BRADESCO FI RF REFERENCIADO DI", cnpj: "11.123.456/0001-03", gestora: "Bradesco Asset Management", categoria: "Renda Fixa", tipo: "Convencional", foco: "-" },
            { nome: "SANTANDER FI MASTER RF DI", cnpj: "11.123.456/0001-04", gestora: "Santander Asset Management", categoria: "Renda Fixa", tipo: "Convencional", foco: "-" },
            { nome: "CAIXA FI BRASIL RF", cnpj: "11.123.456/0001-05", gestora: "Caixa Asset Management", categoria: "Renda Fixa", tipo: "Convencional", foco: "-" },
            { nome: "XP SELECTION FI MULTIMERCADO", cnpj: "11.123.456/0001-06", gestora: "XP Asset Management", categoria: "Multimercado", tipo: "Convencional", foco: "-" },
            { nome: "BTG PACTUAL ABSOLUTO FI MULTIMERCADO", cnpj: "11.123.456/0001-07", gestora: "BTG Pactual Asset Management", categoria: "Multimercado", tipo: "Convencional", foco: "-" },
            { nome: "SAFRA GALILEO FI MULTIMERCADO", cnpj: "11.123.456/0001-08", gestora: "Safra Asset Management", categoria: "Multimercado", tipo: "Convencional", foco: "-" },
            { nome: "ITA√ö DIVERSIFICADO FI MULTIMERCADO", cnpj: "11.123.456/0001-09", gestora: "Itau Asset Management", categoria: "Multimercado", tipo: "Convencional", foco: "-" },
            { nome: "BB MULTIMERCADO LP ESTILO FI", cnpj: "11.123.456/0001-10", gestora: "BB Asset Management", categoria: "Multimercado", tipo: "Convencional", foco: "-" },
            { nome: "ALASKA BLACK FI A√á√ïES BDR NIVEL I", cnpj: "11.123.456/0001-11", gestora: "Alaska Asset Management", categoria: "A√ß√µes", tipo: "Convencional", foco: "-" },
            { nome: "DYNAMO COUGAR FI A√á√ïES", cnpj: "11.123.456/0001-12", gestora: "Dynamo Asset Management", categoria: "A√ß√µes", tipo: "Convencional", foco: "-" },
            { nome: "ATMOS A√á√ïES FI", cnpj: "11.123.456/0001-13", gestora: "Atmos Capital", categoria: "A√ß√µes", tipo: "Convencional", foco: "-" },
            { nome: "BRASIL CAPITAL FI A√á√ïES", cnpj: "11.123.456/0001-14", gestora: "Brasil Capital", categoria: "A√ß√µes", tipo: "Convencional", foco: "-" },
            { nome: "CONSTELLATION COMPOUNDERS FI A√á√ïES", cnpj: "11.123.456/0001-15", gestora: "Constellation Asset Management", categoria: "A√ß√µes", tipo: "Convencional", foco: "-" },
            { nome: "ITA√ö PREV RF FI", cnpj: "11.123.456/0001-16", gestora: "Itau Asset Management", categoria: "Previd√™ncia", tipo: "Convencional", foco: "-" },
            { nome: "BB PREV RF FI", cnpj: "11.123.456/0001-17", gestora: "BB Asset Management", categoria: "Previd√™ncia", tipo: "Convencional", foco: "-" },
            { nome: "BRADESCO PREV PGBL FI", cnpj: "11.123.456/0001-18", gestora: "Bradesco Asset Management", categoria: "Previd√™ncia", tipo: "Convencional", foco: "-" },
            { nome: "SANTANDER PREV MULTI FI", cnpj: "11.123.456/0001-19", gestora: "Santander Asset Management", categoria: "Previd√™ncia", tipo: "Convencional", foco: "-" },
            { nome: "XP PREV MODERADO FI", cnpj: "11.123.456/0001-20", gestora: "XP Asset Management", categoria: "Previd√™ncia", tipo: "Convencional", foco: "-" },
            { nome: "ITA√ö CAMBIAL D√ìLAR FI", cnpj: "11.123.456/0001-21", gestora: "Itau Asset Management", categoria: "Cambial", tipo: "Convencional", foco: "-" },
            { nome: "BB CAMBIAL D√ìLAR FI", cnpj: "11.123.456/0001-22", gestora: "BB Asset Management", categoria: "Cambial", tipo: "Convencional", foco: "-" },
            { nome: "BRADESCO CAMBIAL D√ìLAR FI", cnpj: "11.123.456/0001-23", gestora: "Bradesco Asset Management", categoria: "Cambial", tipo: "Convencional", foco: "-" },
            { nome: "SANTANDER CAMBIAL D√ìLAR FI", cnpj: "11.123.456/0001-24", gestora: "Santander Asset Management", categoria: "Cambial", tipo: "Convencional", foco: "-" },
            { nome: "ARX LONG SHORT FI MULTIMERCADO", cnpj: "11.123.456/0001-25", gestora: "ARX Investimentos", categoria: "Multimercado", tipo: "Convencional", foco: "-" },
            { nome: "ADAM MACRO FI MULTIMERCADO", cnpj: "11.123.456/0001-26", gestora: "Adam Capital", categoria: "Multimercado", tipo: "Convencional", foco: "-" },
            { nome: "KAPITALO KAPPA FI MULTIMERCADO", cnpj: "11.123.456/0001-27", gestora: "Kapitalo Investimentos", categoria: "Multimercado", tipo: "Convencional", foco: "-" },
            { nome: "SPX NIMITZ FI MULTIMERCADO", cnpj: "11.123.456/0001-28", gestora: "SPX Capital", categoria: "Multimercado", tipo: "Convencional", foco: "-" },
            { nome: "LEGACY CAPITAL FI MULTIMERCADO", cnpj: "11.123.456/0001-29", gestora: "Legacy Capital", categoria: "Multimercado", tipo: "Convencional", foco: "-" },
            { nome: "IBIUNA HEDGE STH FI MULTIMERCADO", cnpj: "11.123.456/0001-30", gestora: "Ibiuna Investimentos", categoria: "Multimercado", tipo: "Convencional", foco: "-" },
            { nome: "TRUXT MACRO FI MULTIMERCADO", cnpj: "11.123.456/0001-31", gestora: "Truxt Investimentos", categoria: "Multimercado", tipo: "Convencional", foco: "-" },
            { nome: "GENOA CAPITAL RADAR FI MULTIMERCADO", cnpj: "11.123.456/0001-32", gestora: "Genoa Capital", categoria: "Multimercado", tipo: "Convencional", foco: "-" },
            { nome: "VINLAND MACRO FI MULTIMERCADO", cnpj: "11.123.456/0001-33", gestora: "Vinland Capital", categoria: "Multimercado", tipo: "Convencional", foco: "-" },
            { nome: "CANVAS ENDURO FI MULTIMERCADO", cnpj: "11.123.456/0001-34", gestora: "Canvas Capital", categoria: "Multimercado", tipo: "Convencional", foco: "-" },
            { nome: "GAP ABSOLUTO FI MULTIMERCADO", cnpj: "11.123.456/0001-35", gestora: "GAP Asset Management", categoria: "Multimercado", tipo: "Convencional", foco: "-" },
            { nome: "ABSOLUT PARTNERS FI MULTIMERCADO", cnpj: "11.123.456/0001-36", gestora: "Absolute Investimentos", categoria: "Multimercado", tipo: "Convencional", foco: "-" },
            { nome: "AZ QUEST SMALL MID CAPS FI A√á√ïES", cnpj: "11.123.456/0001-37", gestora: "AZ Quest Investimentos", categoria: "A√ß√µes", tipo: "Convencional", foco: "-" },
            { nome: "EQUITAS SELECTION FI A√á√ïES", cnpj: "11.123.456/0001-38", gestora: "Equitas Investimentos", categoria: "A√ß√µes", tipo: "Convencional", foco: "-" },
            { nome: "MOAT CAPITAL FI A√á√ïES", cnpj: "11.123.456/0001-39", gestora: "Moat Capital", categoria: "A√ß√µes", tipo: "Convencional", foco: "-" },
            { nome: "REAL INVESTOR FI A√á√ïES", cnpj: "11.123.456/0001-40", gestora: "Real Investor Asset", categoria: "A√ß√µes", tipo: "Convencional", foco: "-" },
        ];

        let fundosFiltrados = [...baseFundos];
        let paginaAtual = 1;
        const itensPorPagina = 15;
        let ordenacaoAtual = { campo: 'nome', direcao: 'asc' };

        function inicializarExplorar() {
            // Preencher select de gestoras (apenas se ainda n√£o preenchido)
            const selectGestora = document.getElementById('filtroGestora');
            if (selectGestora && selectGestora.options.length <= 1) {
                const gestoras = [...new Set(baseFundos.map(f => f.gestora))].sort();
                gestoras.forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g;
                    opt.textContent = g;
                    selectGestora.appendChild(opt);
                });
            }
            // N√£o filtrar/renderizar automaticamente - deixar a API carregar os dados
        }

        function filtrarFundos() {
            const busca = (document.getElementById('searchFundos')?.value || '').toLowerCase();
            const categoria = document.getElementById('filtroCategoria')?.value || '';
            const tipo = document.getElementById('filtroTipo')?.value || '';
            const gestora = document.getElementById('filtroGestora')?.value || '';

            fundosFiltrados = baseFundos.filter(f => {
                const matchBusca = !busca ||
                    f.nome.toLowerCase().includes(busca) ||
                    f.cnpj.toLowerCase().includes(busca) ||
                    f.gestora.toLowerCase().includes(busca);
                const matchCategoria = !categoria || f.categoria === categoria;
                const matchTipo = !tipo || f.tipo === tipo;
                const matchGestora = !gestora || f.gestora === gestora;
                return matchBusca && matchCategoria && matchTipo && matchGestora;
            });

            // Aplicar ordena√ß√£o
            ordenarArray();

            paginaAtual = 1;
            renderizarTabela();
            atualizarEstatisticas();
        }

        function ordenarArray() {
            fundosFiltrados.sort((a, b) => {
                let valA = a[ordenacaoAtual.campo] || '';
                let valB = b[ordenacaoAtual.campo] || '';
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();
                if (valA < valB) return ordenacaoAtual.direcao === 'asc' ? -1 : 1;
                if (valA > valB) return ordenacaoAtual.direcao === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function ordenarFundos(campo) {
            if (ordenacaoAtual.campo === campo) {
                ordenacaoAtual.direcao = ordenacaoAtual.direcao === 'asc' ? 'desc' : 'asc';
            } else {
                ordenacaoAtual.campo = campo;
                ordenacaoAtual.direcao = 'asc';
            }
            ordenarArray();
            renderizarTabela();
        }

        function renderizarTabela() {
            const corpo = document.getElementById('corpoTabelaFundos');
            if (!corpo) return;

            const inicio = (paginaAtual - 1) * itensPorPagina;
            const fim = inicio + itensPorPagina;
            const fundosPagina = fundosFiltrados.slice(inicio, fim);

            corpo.innerHTML = fundosPagina.map(f => `
                <tr>
                    <td style="max-width:300px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${f.nome}">${f.nome}</td>
                    <td style="font-family:monospace;font-size:0.75rem;">${f.cnpj}</td>
                    <td>${f.gestora}</td>
                    <td>${f.categoria}</td>
                    <td><span style="background:${f.tipo === 'IS' ? 'rgba(76,175,80,0.2);color:#66BB6A' : f.tipo === 'ESG' ? 'rgba(255,152,0,0.2);color:#FFB74D' : 'rgba(100,100,100,0.2);color:#a0a0b0'};padding:3px 8px;border-radius:10px;font-size:0.75rem;">${f.tipo}</span></td>
                    <td>${f.foco}</td>
                    <td><button onclick="adicionarFavorito('${f.cnpj}')" style="background:none;border:none;cursor:pointer;font-size:1rem;" title="Adicionar aos favoritos">‚≠ê</button></td>
                </tr>
            `).join('');

            const totalPaginas = Math.ceil(fundosFiltrados.length / itensPorPagina) || 1;
            document.getElementById('infoPagina').textContent = `P√°gina ${paginaAtual} de ${totalPaginas}`;
        }

        function mudarPagina(direcao) {
            const totalPaginas = Math.ceil(fundosFiltrados.length / itensPorPagina) || 1;
            const novaPagina = paginaAtual + direcao;
            if (novaPagina >= 1 && novaPagina <= totalPaginas) {
                paginaAtual = novaPagina;
                renderizarTabela();
            }
        }

        function atualizarEstatisticas() {
            // N√£o atualizar se a API ainda n√£o carregou (evitar mostrar dados locais)
            if (totalFundosAPI > 0) return;
            document.getElementById('totalEncontrados').textContent = fundosFiltrados.length.toLocaleString('pt-BR');
            const totalIS = document.getElementById('totalIS');
            const totalESG = document.getElementById('totalESG');
            if (totalIS) totalIS.textContent = fundosFiltrados.filter(f => f.tipo === 'IS').length;
            if (totalESG) totalESG.textContent = fundosFiltrados.filter(f => f.tipo === 'ESG').length;
        }

        function adicionarFavorito(cnpj) {
            const fundo = baseFundos.find(f => f.cnpj === cnpj);
            if (fundo) {
                let favoritos = JSON.parse(localStorage.getItem('fundos_favoritos') || '[]');
                if (!favoritos.find(f => f.cnpj === cnpj)) {
                    favoritos.push(fundo);
                    localStorage.setItem('fundos_favoritos', JSON.stringify(favoritos));
                    alert(`‚úì "${fundo.nome}" adicionado aos favoritos!`);
                } else {
                    alert('Este fundo j√° est√° nos favoritos.');
                }
            }
        }

        // Inicializar quando a aba Explorar for aberta
        const originalShowTab = showTab;
        showTab = function(tabId, event) {
            originalShowTab(tabId, event);
            if (tabId === 'explorar') {
                inicializarExplorar();
            }
        };

        // Inicializar se j√° estiver na aba
        document.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('explorar')?.classList.contains('active')) {
                inicializarExplorar();
            }
        });

        // ========== EMISSORES ==========
        let emissoresCarregado = false;
        let dadosEmissores = [];

        async function carregarEmissores() {
            const search = document.getElementById('searchEmissores')?.value || '';
            const setor = document.getElementById('filtroSetorEmissores')?.value || '';
            const classif = document.getElementById('filtroClassEmissores')?.value || '';

            try {
                // Carregar estatisticas
                const statsResp = await fetch(`${API_URL}/emissores/stats`);
                const statsData = await statsResp.json();

                if (statsData.success) {
                    const stats = statsData.data;
                    document.getElementById('statEmissoresTotal').textContent = stats.total_tsb || 0;
                    document.getElementById('statEmissoresVerde').textContent = stats.por_classificacao?.VERDE || 0;
                    document.getElementById('statEmissoresTransicao').textContent = stats.por_classificacao?.TRANSICAO || 0;
                    document.getElementById('statEmissoresScore').textContent = stats.score_medio || '--';
                    document.getElementById('emissoresBadge').textContent = `${stats.total_tsb} Empresas`;

                    // Graficos
                    atualizarGraficosEmissores(stats);
                }

                // Carregar lista
                const resp = await fetch(`${API_URL}/emissores?search=${encodeURIComponent(search)}`);
                const data = await resp.json();

                if (data.success) {
                    dadosEmissores = data.data;

                    // Filtrar localmente
                    let filtrados = dadosEmissores;
                    if (setor) filtrados = filtrados.filter(e => e.setor === setor);
                    if (classif) filtrados = filtrados.filter(e => e.classificacao === classif);

                    renderizarTabelaEmissores(filtrados);
                }

                emissoresCarregado = true;
            } catch (e) {
                console.error('Erro ao carregar emissores:', e);
                document.getElementById('corpoTabelaEmissores').innerHTML =
                    '<tr><td colspan="7" style="text-align:center;padding:40px;color:#EF5350;">Erro ao carregar. Verifique a API.</td></tr>';
            }
        }

        function renderizarTabelaEmissores(emissores) {
            const corpo = document.getElementById('corpoTabelaEmissores');
            if (!emissores || emissores.length === 0) {
                corpo.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-secondary);">Nenhum emissor encontrado</td></tr>';
                return;
            }

            let html = '';
            emissores.forEach(e => {
                const classColor = e.classificacao === 'VERDE' ? '#4CAF50' : '#FF9800';
                const scoreColor = e.score >= 85 ? '#4CAF50' : e.score >= 70 ? '#FF9800' : '#EF5350';

                html += `<tr>
                    <td style="font-weight:600;">${e.razaosocial || e.emissor || '-'}</td>
                    <td style="font-family:monospace;font-size:0.8rem;">${e.cnpj || '-'}</td>
                    <td>${e.setor || e.setortsb || '-'}</td>
                    <td><span style="background:${classColor};color:white;padding:3px 10px;border-radius:12px;font-size:0.8rem;">${e.classificacao || '-'}</span></td>
                    <td style="font-weight:700;color:${scoreColor};">${e.score || '-'}</td>
                    <td style="font-size:0.85rem;">${e.titulos || '-'}</td>
                    <td>
                        <button onclick="verDetalhesEmissor('${e.cnpj}')" style="background:#2196F3;color:white;border:none;padding:5px 12px;border-radius:6px;cursor:pointer;font-size:0.8rem;">Detalhes</button>
                    </td>
                </tr>`;
            });
            corpo.innerHTML = html;

            // Inicializar Simple-DataTables para Emissores ap√≥s carregar dados
            setTimeout(() => {
                // Destruir inst√¢ncia anterior se existir (para recarregamentos)
                if (dataTableInstances.tabelaEmissores) {
                    try {
                        dataTableInstances.tabelaEmissores.destroy();
                        dataTableInstances.tabelaEmissores = null;
                    } catch (e) {}
                }
                inicializarDataTable('tabelaEmissores', { perPage: 25 });
            }, 100);
        }

        function atualizarGraficosEmissores(stats) {
            // Grafico por Setor
            if (stats.por_setor && stats.por_setor.length > 0) {
                const ctxSetor = document.getElementById('chartEmissoresSetor');
                if (ctxSetor) {
                    if (graficos['chartEmissoresSetor']) graficos['chartEmissoresSetor'].destroy();
                    graficos['chartEmissoresSetor'] = new Chart(ctxSetor, {
                        type: 'bar',
                        data: {
                            labels: stats.por_setor.map(s => s.setortsb),
                            datasets: [{
                                label: 'Empresas',
                                data: stats.por_setor.map(s => s.qtd),
                                backgroundColor: ['#42A5F5', '#66BB6A', '#FFA726', '#AB47BC', '#26A69A', '#EF5350', '#78909C']
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                    });
                }
            }

            // Grafico Classificacao
            if (stats.por_classificacao) {
                const ctxClass = document.getElementById('chartEmissoresClass');
                if (ctxClass) {
                    if (graficos['chartEmissoresClass']) graficos['chartEmissoresClass'].destroy();
                    graficos['chartEmissoresClass'] = new Chart(ctxClass, {
                        type: 'doughnut',
                        data: {
                            labels: ['Verde', 'Transicao'],
                            datasets: [{
                                data: [stats.por_classificacao.VERDE || 0, stats.por_classificacao.TRANSICAO || 0],
                                backgroundColor: ['#4CAF50', '#FF9800']
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }
            }
        }

        async function verDetalhesEmissor(cnpj) {
            try {
                const resp = await fetch(`${API_URL}/emissores/${encodeURIComponent(cnpj)}`);
                const data = await resp.json();

                if (data.success) {
                    const emp = data.empresa;
                    let html = `<h2 style="color:#42A5F5;margin-bottom:15px;">üè¢ ${emp.razaosocial || emp.emissor}</h2>
                        <div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px;">
                            <span style="background:rgba(255,255,255,0.1);padding:8px 15px;border-radius:8px;">CNPJ: ${emp.cnpj}</span>
                            <span style="background:rgba(255,255,255,0.1);padding:8px 15px;border-radius:8px;">Setor: ${emp.setor || emp.setortsb}</span>
                            ${emp.classificacao ? `<span style="background:${emp.classificacao === 'VERDE' ? '#4CAF50' : '#FF9800'};color:white;padding:8px 15px;border-radius:8px;">${emp.classificacao}</span>` : ''}
                            ${emp.score ? `<span style="background:rgba(255,255,255,0.1);padding:8px 15px;border-radius:8px;">Score: <strong>${emp.score}</strong></span>` : ''}
                        </div>`;

                    if (data.kpis && data.kpis.length > 0) {
                        html += `<h3 style="margin:20px 0 10px;">üìä KPIs TSB</h3>
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;">`;
                        data.kpis.forEach(k => {
                            const statusColor = k.status === 'Verificado' ? '#4CAF50' : '#2196F3';
                            html += `<div style="background:rgba(255,255,255,0.03);padding:12px;border-radius:8px;border-left:3px solid ${statusColor};">
                                <div style="font-size:0.75rem;color:#888;">${k.codigokpi}</div>
                                <div style="font-size:1.1rem;font-weight:600;color:#66BB6A;">${k.valor || '-'} ${k.unidade || ''}</div>
                                <div style="font-size:0.7rem;color:${statusColor};">${k.status}</div>
                            </div>`;
                        });
                        html += '</div>';
                    }

                    if (data.governanca && data.governanca.length > 0) {
                        html += `<h3 style="margin:20px 0 10px;">üìã Governanca Corporativa</h3>
                            <div style="max-height:200px;overflow-y:auto;">`;
                        const grouped = {};
                        data.governanca.forEach(g => {
                            if (!grouped[g.capitulo]) grouped[g.capitulo] = [];
                            grouped[g.capitulo].push(g);
                        });
                        for (const cap in grouped) {
                            const adotadas = grouped[cap].filter(g => g.praticaadotada === 'Sim').length;
                            const total = grouped[cap].length;
                            const pct = Math.round((adotadas / total) * 100);
                            const barColor = pct >= 80 ? '#4CAF50' : pct >= 50 ? '#FF9800' : '#EF5350';
                            html += `<div style="margin-bottom:10px;">
                                <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                                    <span>${cap}</span>
                                    <span style="color:${barColor};">${pct}%</span>
                                </div>
                                <div style="background:rgba(255,255,255,0.1);height:8px;border-radius:4px;">
                                    <div style="background:${barColor};width:${pct}%;height:100%;border-radius:4px;"></div>
                                </div>
                            </div>`;
                        }
                        html += '</div>';
                    }

                    // Mostrar em modal
                    const modal = document.getElementById('modalKPIs');
                    document.getElementById('modalKPIsConteudo').innerHTML = html;
                    modal.style.display = 'block';
                }
            } catch (e) {
                alert('Erro ao carregar detalhes: ' + e.message);
            }
        }

        // Carregar ao abrir aba
        const originalShowTabEmissores = showTab;
        showTab = function(tabId, event) {
            originalShowTabEmissores(tabId, event);
            if (tabId === 'emissores' && !emissoresCarregado) {
                carregarEmissores();
            }
        };

        // Enter para buscar
        document.addEventListener('DOMContentLoaded', function() {
            const searchEm = document.getElementById('searchEmissores');
            if (searchEm) {
                searchEm.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') carregarEmissores();
                });
            }
        });

        // ========== CONSULTA IA ==========
        let aiHistorico = [];
        let aiProcessando = false;

        function usarSugestao(texto) {
            document.getElementById('aiUserInput').value = texto;
            enviarMensagemIA();
        }

        function adicionarMensagemChat(tipo, conteudo) {
            const chatHistory = document.getElementById('aiChatHistory');
            const avatar = tipo === 'user' ? 'üë§' : 'ü§ñ';

            const msgDiv = document.createElement('div');
            msgDiv.className = `ai-message ai-${tipo}`;
            msgDiv.innerHTML = `
                <div class="ai-avatar">${avatar}</div>
                <div class="ai-content">${conteudo}</div>
            `;
            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function mostrarTyping() {
            const chatHistory = document.getElementById('aiChatHistory');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'aiTypingIndicator';
            typingDiv.className = 'ai-message ai-assistant';
            typingDiv.innerHTML = `
                <div class="ai-avatar">ü§ñ</div>
                <div class="ai-content">
                    <div class="ai-typing">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            chatHistory.appendChild(typingDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function removerTyping() {
            const typing = document.getElementById('aiTypingIndicator');
            if (typing) typing.remove();
        }

        async function enviarMensagemIA() {
            if (aiProcessando) return;

            const input = document.getElementById('aiUserInput');
            const mensagem = input.value.trim();
            if (!mensagem) return;

            const tipoResposta = document.getElementById('aiResponseType').value;
            const contexto = document.getElementById('aiContext').value;

            // Mostrar mensagem do usu√°rio
            adicionarMensagemChat('user', `<p>${escapeHtmlIA(mensagem)}</p>`);
            input.value = '';

            // Mostrar indicador de digita√ß√£o
            aiProcessando = true;
            document.getElementById('aiSendBtn').disabled = true;
            document.getElementById('aiStatusBadge').textContent = 'Processando...';
            document.getElementById('aiStatusBadge').style.background = '#FF9800';
            mostrarTyping();

            try {
                const response = await fetch(`${API_URL}/ai/consulta`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mensagem: mensagem,
                        tipo_resposta: tipoResposta,
                        contexto: contexto,
                        historico: aiHistorico.slice(-5)
                    })
                });

                const data = await response.json();
                removerTyping();

                if (data.success) {
                    aiHistorico.push({ role: 'user', content: mensagem });
                    aiHistorico.push({ role: 'assistant', content: data.resposta });

                    adicionarMensagemChat('assistant', data.resposta);

                    // Se houver dados estruturados (tabela, gr√°fico)
                    if (data.dados_estruturados) {
                        mostrarResultadosIA(data.dados_estruturados, data.tipo);
                    }
                } else {
                    adicionarMensagemChat('assistant', `<p style="color:#EF5350;">Desculpe, ocorreu um erro: ${data.error}</p>`);
                }
            } catch (e) {
                removerTyping();
                // Usar resposta local quando a API n√£o estiver dispon√≠vel
                const respostaLocal = gerarRespostaLocal(mensagem, tipoResposta, contexto);
                aiHistorico.push({ role: 'user', content: mensagem });
                aiHistorico.push({ role: 'assistant', content: respostaLocal });
                adicionarMensagemChat('assistant', respostaLocal);
            } finally {
                aiProcessando = false;
                document.getElementById('aiSendBtn').disabled = false;
                document.getElementById('aiStatusBadge').textContent = 'IA Pronta';
                document.getElementById('aiStatusBadge').style.background = '#9C27B0';
            }
        }

        function gerarRespostaLocal(mensagem, tipo, contexto) {
            const msgLower = mensagem.toLowerCase();

            // An√°lise de contexto para gerar resposta relevante
            if (msgLower.includes('relatorio') || msgLower.includes('relat√≥rio')) {
                if (msgLower.includes('esg') || msgLower.includes('sustent')) {
                    return `<p><strong>üìä Relat√≥rio de Fundos ESG</strong></p>
                    <p>Com base nos dados dispon√≠veis, aqui est√° uma an√°lise dos fundos ESG:</p>
                    <table>
                        <tr><th>M√©trica</th><th>Valor</th></tr>
                        <tr><td>Total de Fundos ESG</td><td>47</td></tr>
                        <tr><td>Fundos IS (Investimento Sustent√°vel)</td><td>18</td></tr>
                        <tr><td>Fundos ESG Integrado</td><td>29</td></tr>
                        <tr><td>Foco Principal</td><td>Ambiental (51%)</td></tr>
                    </table>
                    <p><strong>Principais Gestoras ESG:</strong></p>
                    <ul>
                        <li>Ita√∫ Asset - 6 fundos</li>
                        <li>Verde Asset - 5 fundos</li>
                        <li>BB Asset - 3 fundos</li>
                    </ul>
                    <p>üí° <em>Dica: Os fundos IS t√™m crit√©rios mais rigorosos de sustentabilidade comparados aos ESG Integrado.</em></p>`;
                }
                return `<p><strong>üìä Relat√≥rio Geral do Mercado</strong></p>
                <table>
                    <tr><th>Categoria</th><th>Quantidade</th></tr>
                    <tr><td>Fundos Totais</td><td>100.000</td></tr>
                    <tr><td>Deb√™ntures</td><td>250</td></tr>
                    <tr><td>T√≠tulos P√∫blicos</td><td>47</td></tr>
                    <tr><td>CRI/CRA</td><td>150+</td></tr>
                    <tr><td>Empresas TSB</td><td>7</td></tr>
                </table>`;
            }

            if (msgLower.includes('risco') || msgLower.includes('analise')) {
                return `<p><strong>üìà An√°lise de Risco</strong></p>
                <p>Com base nos dados de deb√™ntures com maior duration:</p>
                <table>
                    <tr><th>Emissor</th><th>Duration</th><th>Taxa</th><th>Risco</th></tr>
                    <tr><td>TSLE11</td><td>1777 dias</td><td>IPCA + 7,56%</td><td style="color:#FF9800;">M√©dio-Alto</td></tr>
                    <tr><td>VALE48</td><td>1678 dias</td><td>IPCA + 6,78%</td><td style="color:#4CAF50;">M√©dio</td></tr>
                    <tr><td>CHPA11</td><td>1637 dias</td><td>IPCA + 9,22%</td><td style="color:#f44336;">Alto</td></tr>
                </table>
                <p>‚ö†Ô∏è <strong>Alertas:</strong></p>
                <ul>
                    <li>T√≠tulos com duration > 1500 dias t√™m maior sensibilidade a varia√ß√µes na taxa de juros</li>
                    <li>Spreads acima de 7% sobre IPCA indicam maior risco de cr√©dito</li>
                </ul>`;
            }

            if (msgLower.includes('view') || msgLower.includes('titulos') || msgLower.includes('t√≠tulos')) {
                return `<p><strong>üèõÔ∏è View de T√≠tulos P√∫blicos por Rentabilidade</strong></p>
                <table>
                    <tr><th>Tipo</th><th>Vencimento</th><th>Taxa</th><th>Recomenda√ß√£o</th></tr>
                    <tr><td>NTN-B</td><td>2060-08-15</td><td>5,81%</td><td style="color:#4CAF50;">Longo Prazo</td></tr>
                    <tr><td>NTN-F</td><td>2035-01-01</td><td>10,73%</td><td style="color:#4CAF50;">Prefixado</td></tr>
                    <tr><td>LTN</td><td>2030-01-01</td><td>10,61%</td><td style="color:#FF9800;">M√©dio Prazo</td></tr>
                    <tr><td>LFT</td><td>2030-03-01</td><td>0,18%</td><td style="color:#42A5F5;">Conservador</td></tr>
                </table>
                <p>üí° <em>NTN-Bs s√£o ideais para prote√ß√£o contra infla√ß√£o no longo prazo.</em></p>`;
            }

            if (msgLower.includes('tsb') || msgLower.includes('taxonomia') || msgLower.includes('verde')) {
                return `<p><strong>üåø Ranking TSB (Taxonomia Sustent√°vel Brasileira)</strong></p>
                <p>Empresas classificadas como <span style="color:#4CAF50;font-weight:bold;">VERDE</span>:</p>
                <table>
                    <tr><th>Empresa</th><th>Setor</th><th>Score</th></tr>
                    <tr><td>SABESP</td><td>√Ågua e Esgoto</td><td>95</td></tr>
                    <tr><td>COPASA</td><td>√Ågua e Esgoto</td><td>92</td></tr>
                    <tr><td>ENGIE</td><td>Eletricidade</td><td>90</td></tr>
                    <tr><td>TAESA</td><td>Eletricidade</td><td>88</td></tr>
                </table>
                <p>‚úÖ Todas as 7 empresas mapeadas possuem classifica√ß√£o Verde, indicando atividades eleg√≠veis para a transi√ß√£o sustent√°vel.</p>`;
            }

            if (msgLower.includes('dica') || msgLower.includes('portfolio') || msgLower.includes('diversific')) {
                return `<p><strong>üí° Dicas de Diversifica√ß√£o de Portfolio</strong></p>
                <p>Com base na an√°lise dos dados dispon√≠veis, recomendo:</p>
                <ol>
                    <li><strong>Renda Fixa (40-50%):</strong>
                        <ul>
                            <li>NTN-Bs para prote√ß√£o inflacion√°ria</li>
                            <li>Deb√™ntures incentivadas com spread > 6%</li>
                        </ul>
                    </li>
                    <li><strong>Fundos ESG (20-30%):</strong>
                        <ul>
                            <li>Fundos IS para maior rigor sustent√°vel</li>
                            <li>Foco em gestoras como Ita√∫ e Verde</li>
                        </ul>
                    </li>
                    <li><strong>T√≠tulos Estruturados (10-20%):</strong>
                        <ul>
                            <li>CRIs/CRAs de emissores s√≥lidos</li>
                            <li>Duration moderada (< 1000 dias)</li>
                        </ul>
                    </li>
                </ol>
                <p>‚ö†Ô∏è <em>Esta √© uma sugest√£o geral. Consulte seu assessor para adequar ao seu perfil de risco.</em></p>`;
            }

            if (msgLower.includes('resumo') || msgLower.includes('mercado') || msgLower.includes('indicador')) {
                return `<p><strong>üìã Resumo dos Principais Indicadores</strong></p>
                <table>
                    <tr><th>Indicador</th><th>Valor</th><th>Tend√™ncia</th></tr>
                    <tr><td>Total de Fundos</td><td>100.000</td><td>üìà Est√°vel</td></tr>
                    <tr><td>Fundos ESG</td><td>47</td><td>üìà Crescimento</td></tr>
                    <tr><td>Taxa m√©dia Deb√™ntures</td><td>IPCA + 6,5%</td><td>üìà Alta</td></tr>
                    <tr><td>Duration m√©dia</td><td>1.100 dias</td><td>‚û°Ô∏è Est√°vel</td></tr>
                    <tr><td>Empresas TSB Verde</td><td>7 (100%)</td><td>‚úÖ Positivo</td></tr>
                </table>
                <p><strong>Destaques:</strong></p>
                <ul>
                    <li>Mercado de fundos ESG em expans√£o</li>
                    <li>Spreads de cr√©dito elevados indicam oportunidades</li>
                    <li>Empresas TSB com boa classifica√ß√£o sustent√°vel</li>
                </ul>`;
            }

            // Resposta padr√£o
            return `<p>Entendi sua pergunta sobre "<em>${escapeHtmlIA(mensagem)}</em>".</p>
            <p>Posso ajudar voc√™ com:</p>
            <ul>
                <li>üìä <strong>Relat√≥rios</strong> - an√°lises detalhadas de fundos, t√≠tulos ou empresas</li>
                <li>üìà <strong>An√°lise de Risco</strong> - avalia√ß√£o de duration, spreads e ratings</li>
                <li>üèõÔ∏è <strong>Views Personalizadas</strong> - comparativos e rankings customizados</li>
                <li>üåø <strong>Dados TSB</strong> - classifica√ß√£o sustent√°vel de empresas</li>
                <li>üí° <strong>Dicas</strong> - sugest√µes de diversifica√ß√£o e estrat√©gias</li>
            </ul>
            <p>Experimente uma das sugest√µes r√°pidas acima ou seja mais espec√≠fico na sua pergunta!</p>`;
        }

        function escapeHtmlIA(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        function mostrarResultadosIA(dados, tipo) {
            const container = document.getElementById('aiResultsContainer');
            const content = document.getElementById('aiResultsContent');

            if (tipo === 'grafico' && dados.chartData) {
                content.innerHTML = '<div class="chart-container" style="height:300px;"><canvas id="aiResultChart"></canvas></div>';
                container.style.display = 'block';

                new Chart(document.getElementById('aiResultChart'), {
                    type: dados.chartType || 'bar',
                    data: dados.chartData,
                    options: { responsive: true, maintainAspectRatio: false }
                });
            } else if (tipo === 'tabela' && dados.rows) {
                let html = '<div style="overflow-x:auto;"><table>';
                if (dados.headers) {
                    html += '<thead><tr>' + dados.headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead>';
                }
                html += '<tbody>' + dados.rows.map(row =>
                    '<tr>' + row.map(cell => `<td>${cell}</td>`).join('') + '</tr>'
                ).join('') + '</tbody></table></div>';
                content.innerHTML = html;
                container.style.display = 'block';
            }
        }

        function limparHistoricoIA() {
            aiHistorico = [];
            const chatHistory = document.getElementById('aiChatHistory');
            chatHistory.innerHTML = `
                <div class="ai-message ai-assistant">
                    <div class="ai-avatar">ü§ñ</div>
                    <div class="ai-content">
                        <p>Hist√≥rico limpo! Como posso ajudar?</p>
                    </div>
                </div>
            `;
            document.getElementById('aiResultsContainer').style.display = 'none';
        }

        // ========== ANBIMA DATA ==========
        let anbimaFundosPage = 1;
        let anbimaFundosDataTable = null;
        let anbimaCRICRADataTable = null;
        let anbimaTitulosDataTable = null;

        async function carregarAnbimaFundos() {
            const search = document.getElementById('searchAnbimaFundos').value;
            const categoria = document.getElementById('filtroAnbimaCategoria').value;
            const esg = document.getElementById('filtroAnbimaESG').value;

            const params = new URLSearchParams({
                page: anbimaFundosPage,
                per_page: 50
            });
            if (search) params.append('search', search);
            if (categoria) params.append('categoria', categoria);
            if (esg) params.append('esg', esg);

            try {
                const response = await fetch(`${API_URL}/anbima/fundos?${params}`);
                const data = await response.json();

                if (data.success) {
                    // Atualizar estatisticas
                    document.getElementById('statAnbimaFundos').textContent = data.total.toLocaleString('pt-BR');
                    if (data.stats) {
                        document.getElementById('statAnbimaESG').textContent = data.stats.total_esg?.toLocaleString('pt-BR') || '0';
                        document.getElementById('statAnbimaAtivos').textContent = data.stats.ativos?.toLocaleString('pt-BR') || '0';
                        document.getElementById('statAnbimaCategorias').textContent = data.stats.categorias?.toLocaleString('pt-BR') || '0';

                        // Preencher select de categorias
                        const selectCategoria = document.getElementById('filtroAnbimaCategoria');
                        if (selectCategoria.options.length <= 1 && data.stats.lista_categorias) {
                            data.stats.lista_categorias.forEach(cat => {
                                const opt = document.createElement('option');
                                opt.value = cat;
                                opt.textContent = cat;
                                selectCategoria.appendChild(opt);
                            });
                        }
                    }

                    // Preencher tabela
                    const tbody = document.querySelector('#tabelaAnbimaFundos tbody');
                    tbody.innerHTML = data.data.map(f => `
                        <tr>
                            <td title="${f.nome || ''}">${(f.nome || '').substring(0, 50)}${(f.nome || '').length > 50 ? '...' : ''}</td>
                            <td>${formatarCNPJ(f.cnpj_classe || '')}</td>
                            <td>${f.categoria_anbima || '-'}</td>
                            <td>${f.tipo_anbima || '-'}</td>
                            <td title="${f.gestor || ''}">${(f.gestor || '').substring(0, 30)}${(f.gestor || '').length > 30 ? '...' : ''}</td>
                            <td><span style="color:${f.status === 'EM FUNCIONAMENTO NORMAL' ? 'var(--success)' : 'var(--text-secondary)'}">${f.status || '-'}</span></td>
                            <td>${f.fundo_esg ? '<span style="color:var(--secondary)">‚úì ESG</span>' : '-'}</td>
                        </tr>
                    `).join('');

                    // Inicializar DataTable
                    if (anbimaFundosDataTable) {
                        anbimaFundosDataTable.destroy();
                    }
                    anbimaFundosDataTable = new simpleDatatables.DataTable('#tabelaAnbimaFundos', {
                        searchable: true,
                        sortable: true,
                        perPage: 25,
                        perPageSelect: [10, 25, 50, 100],
                        labels: {
                            placeholder: "Buscar na tabela...",
                            perPage: "por pagina",
                            noRows: "Nenhum fundo encontrado",
                            info: "Mostrando {start} a {end} de {rows} registros"
                        }
                    });

                    // Adicionar filtros dropdown por coluna
                    setTimeout(() => adicionarFiltrosColunas('tabelaAnbimaFundos', anbimaFundosDataTable), 100);

                    // Paginacao servidor
                    renderizarPaginacaoAnbima(data.total, data.page, data.per_page);
                }
            } catch (error) {
                console.error('Erro ao carregar fundos ANBIMA:', error);
            }
        }

        function renderizarPaginacaoAnbima(total, page, perPage) {
            const totalPages = Math.ceil(total / perPage);
            const container = document.getElementById('paginacaoAnbimaFundos');

            let html = '';
            if (page > 1) {
                html += `<button onclick="anbimaFundosPage=${page-1};carregarAnbimaFundos()" style="padding:8px 15px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary);cursor:pointer;">‚Üê Anterior</button>`;
            }
            html += `<span style="padding:8px 15px;color:var(--text-secondary);">Pagina ${page} de ${totalPages} (${total.toLocaleString('pt-BR')} registros)</span>`;
            if (page < totalPages) {
                html += `<button onclick="anbimaFundosPage=${page+1};carregarAnbimaFundos()" style="padding:8px 15px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary);cursor:pointer;">Proxima ‚Üí</button>`;
            }
            container.innerHTML = html;
        }

        async function carregarAnbimaCRICRA() {
            const search = document.getElementById('searchAnbimaCRICRA').value;
            const tipo = document.getElementById('filtroAnbimaTipoCRICRA').value;

            const params = new URLSearchParams();
            if (search) params.append('search', search);
            if (tipo) params.append('tipo', tipo);

            try {
                const response = await fetch(`${API_URL}/anbima/cricra?${params}`);
                const data = await response.json();

                if (data.success) {
                    // Estatisticas
                    document.getElementById('statAnbimaCRICRA').textContent = data.total.toLocaleString('pt-BR');
                    document.getElementById('statAnbimaCRI').textContent = data.stats?.cri?.toLocaleString('pt-BR') || '0';
                    document.getElementById('statAnbimaCRA').textContent = data.stats?.cra?.toLocaleString('pt-BR') || '0';
                    document.getElementById('statAnbimaDataRef').textContent = data.stats?.data_referencia || '-';

                    // Tabela
                    const tbody = document.querySelector('#tabelaAnbimaCRICRA tbody');
                    tbody.innerHTML = data.data.map(c => `
                        <tr>
                            <td><span style="color:${c.tipo === 'CRI' ? 'var(--info)' : 'var(--secondary)'}">${c.tipo}</span></td>
                            <td>${c.codigo || '-'}</td>
                            <td title="${c.emissor || ''}">${(c.emissor || '').substring(0, 30)}${(c.emissor || '').length > 30 ? '...' : ''}</td>
                            <td title="${c.devedor || ''}">${(c.devedor || '').substring(0, 30)}${(c.devedor || '').length > 30 ? '...' : ''}</td>
                            <td>${c.data_vencimento ? new Date(c.data_vencimento).toLocaleDateString('pt-BR') : '-'}</td>
                            <td>${c.taxa_indicativa ? c.taxa_indicativa.toFixed(2) + '%' : '-'}</td>
                            <td>${c.pu_indicativo ? 'R$ ' + c.pu_indicativo.toLocaleString('pt-BR', {minimumFractionDigits: 2}) : '-'}</td>
                            <td>${c.duration_dias ? Math.round(c.duration_dias) + ' dias' : '-'}</td>
                        </tr>
                    `).join('');

                    // DataTable
                    if (anbimaCRICRADataTable) {
                        anbimaCRICRADataTable.destroy();
                    }
                    anbimaCRICRADataTable = new simpleDatatables.DataTable('#tabelaAnbimaCRICRA', {
                        searchable: true,
                        sortable: true,
                        perPage: 25,
                        perPageSelect: [10, 25, 50, 100],
                        labels: {
                            placeholder: "Buscar...",
                            perPage: "por pagina",
                            noRows: "Nenhum CRI/CRA encontrado",
                            info: "Mostrando {start} a {end} de {rows}"
                        }
                    });

                    // Adicionar filtros dropdown por coluna
                    setTimeout(() => adicionarFiltrosColunas('tabelaAnbimaCRICRA', anbimaCRICRADataTable), 100);
                }
            } catch (error) {
                console.error('Erro ao carregar CRI/CRA ANBIMA:', error);
            }
        }

        async function carregarAnbimaTitulos() {
            try {
                const response = await fetch(`${API_URL}/anbima/titulos-publicos`);
                const data = await response.json();

                if (data.success) {
                    // Estatisticas
                    document.getElementById('statAnbimaTitulos').textContent = data.total.toLocaleString('pt-BR');
                    document.getElementById('statAnbimaTitulosData').textContent = data.stats?.data_referencia || '-';

                    // Tabela
                    const tbody = document.querySelector('#tabelaAnbimaTitulos tbody');
                    tbody.innerHTML = data.data.map(t => `
                        <tr>
                            <td>${t.tipo_titulo || '-'}</td>
                            <td>${t.codigo_selic || '-'}</td>
                            <td>${t.codigo_isin || '-'}</td>
                            <td>${t.data_vencimento ? new Date(t.data_vencimento).toLocaleDateString('pt-BR') : '-'}</td>
                            <td>${t.taxa_compra ? t.taxa_compra.toFixed(2) + '%' : '-'}</td>
                            <td>${t.taxa_venda ? t.taxa_venda.toFixed(2) + '%' : '-'}</td>
                            <td>${t.taxa_indicativa ? t.taxa_indicativa.toFixed(2) + '%' : '-'}</td>
                            <td>${t.pu_indicativo ? 'R$ ' + t.pu_indicativo.toLocaleString('pt-BR', {minimumFractionDigits: 2}) : '-'}</td>
                        </tr>
                    `).join('');

                    // DataTable
                    if (anbimaTitulosDataTable) {
                        anbimaTitulosDataTable.destroy();
                    }
                    anbimaTitulosDataTable = new simpleDatatables.DataTable('#tabelaAnbimaTitulos', {
                        searchable: true,
                        sortable: true,
                        perPage: 25,
                        labels: {
                            placeholder: "Buscar...",
                            perPage: "por pagina",
                            noRows: "Nenhum titulo encontrado",
                            info: "Mostrando {start} a {end} de {rows}"
                        }
                    });

                    // Adicionar filtros dropdown por coluna
                    setTimeout(() => adicionarFiltrosColunas('tabelaAnbimaTitulos', anbimaTitulosDataTable), 100);
                }
            } catch (error) {
                console.error('Erro ao carregar titulos ANBIMA:', error);
            }
        }

        // ========== FUNDOS ESG ANBIMA (para tabs Fundos IS e Fundos ESG) ==========
        let fundosESGDataTableIS = null;
        let fundosESGDataTableESG = null;

        async function carregarFundosESGAnbima(tableId, tbodyId, loadingId, countId) {
            const loading = document.getElementById(loadingId);
            const tbody = document.getElementById(tbodyId);
            const count = document.getElementById(countId);

            if (loading) loading.style.display = 'block';
            if (tbody) tbody.innerHTML = '';

            try {
                // Buscar apenas fundos ESG
                const response = await fetch(`${API_URL}/anbima/fundos?esg=true&per_page=500`);
                const data = await response.json();

                if (data.success) {
                    // Atualizar contagem
                    if (count) count.textContent = data.total.toLocaleString('pt-BR');

                    // Preencher tabela
                    if (tbody) {
                        tbody.innerHTML = data.data.map(f => `
                            <tr>
                                <td title="${f.nome || ''}">${(f.nome || '').substring(0, 60)}${(f.nome || '').length > 60 ? '...' : ''}</td>
                                <td style="font-family:monospace;font-size:0.75rem;">${formatarCNPJ(f.cnpj_classe || '')}</td>
                                <td>${f.categoria_anbima || '-'}</td>
                                <td title="${f.gestor || ''}">${(f.gestor || '').substring(0, 40)}${(f.gestor || '').length > 40 ? '...' : ''}</td>
                            </tr>
                        `).join('');
                    }

                    // Destruir DataTable anterior se existir
                    if (tableId === 'tabelaFundosIS' && fundosESGDataTableIS) {
                        fundosESGDataTableIS.destroy();
                        fundosESGDataTableIS = null;
                    } else if (tableId === 'tabelaFundosESG' && fundosESGDataTableESG) {
                        fundosESGDataTableESG.destroy();
                        fundosESGDataTableESG = null;
                    }

                    // Inicializar DataTable
                    const dtInstance = new simpleDatatables.DataTable(`#${tableId}`, {
                        searchable: true,
                        sortable: true,
                        perPage: 25,
                        perPageSelect: [10, 25, 50, 100],
                        labels: {
                            placeholder: "Buscar fundo ESG...",
                            perPage: "por pagina",
                            noRows: "Nenhum fundo ESG encontrado",
                            info: "Mostrando {start} a {end} de {rows} fundos ESG"
                        }
                    });

                    // Guardar referencia
                    if (tableId === 'tabelaFundosIS') {
                        fundosESGDataTableIS = dtInstance;
                    } else if (tableId === 'tabelaFundosESG') {
                        fundosESGDataTableESG = dtInstance;
                    }

                    // Adicionar filtros dropdown por coluna
                    setTimeout(() => adicionarFiltrosColunas(tableId, dtInstance), 100);
                }
            } catch (error) {
                console.error('Erro ao carregar fundos ESG ANBIMA:', error);
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:40px;color:var(--error);">Erro ao carregar dados. Tente novamente.</td></tr>';
                }
            } finally {
                if (loading) loading.style.display = 'none';
            }
        }

        // ========== DEBENTURES DINAMICO ==========
        let debenturesDataTable = null;
        let debenturesCarregadas = false;

        async function carregarDebentures() {
            if (debenturesCarregadas) return;

            const loading = document.getElementById('loadingDebentures');
            const tbody = document.getElementById('corpoDebentures');

            try {
                const response = await fetch(`${API_URL}/debentures`);
                const data = await response.json();

                if (data.success) {
                    debenturesCarregadas = true;

                    // Estatisticas por grupo
                    const porGrupo = { 'DI PERCENTUAL': 0, 'DI SPREAD': 0, 'IPCA SPREAD': 0 };
                    data.data.forEach(d => {
                        const grupo = (d.grupo || '').toUpperCase();
                        if (grupo.includes('DI PERCENTUAL') || grupo.includes('DI %')) porGrupo['DI PERCENTUAL']++;
                        else if (grupo.includes('DI SPREAD') || grupo.includes('DI +')) porGrupo['DI SPREAD']++;
                        else if (grupo.includes('IPCA')) porGrupo['IPCA SPREAD']++;
                    });

                    document.getElementById('debTotal').textContent = data.total.toLocaleString('pt-BR');
                    document.getElementById('debDIPerc').textContent = porGrupo['DI PERCENTUAL'].toLocaleString('pt-BR');
                    document.getElementById('debDISpread').textContent = porGrupo['DI SPREAD'].toLocaleString('pt-BR');
                    document.getElementById('debIPCASpread').textContent = porGrupo['IPCA SPREAD'].toLocaleString('pt-BR');

                    // Preencher tabela
                    tbody.innerHTML = data.data.map(d => `
                        <tr>
                            <td title="${d.emissor || ''}">${(d.emissor || '').substring(0, 45)}${(d.emissor || '').length > 45 ? '...' : ''}</td>
                            <td>${d.codigoativo || '-'}</td>
                            <td>${d.grupo || '-'}</td>
                            <td>${d.percentualtaxa || '-'}</td>
                            <td>${d.duration ? Math.round(d.duration) : '-'}</td>
                            <td>${d.pu ? 'R$ ' + parseFloat(d.pu).toLocaleString('pt-BR', {minimumFractionDigits: 2}) : '-'}</td>
                        </tr>
                    `).join('');

                    // Destruir DataTable anterior se existir
                    if (debenturesDataTable) {
                        debenturesDataTable.destroy();
                        debenturesDataTable = null;
                    }

                    // Inicializar DataTable
                    debenturesDataTable = new simpleDatatables.DataTable('#tabelaDebentures', {
                        searchable: true,
                        sortable: true,
                        perPage: 25,
                        perPageSelect: [10, 25, 50, 100],
                        labels: {
                            placeholder: "Buscar debenture...",
                            perPage: "por pagina",
                            noRows: "Nenhuma debenture encontrada",
                            info: "Mostrando {start} a {end} de {rows} debentures"
                        }
                    });

                    // Adicionar filtros dropdown por coluna
                    setTimeout(() => adicionarFiltrosColunas('tabelaDebentures', debenturesDataTable), 100);
                }
            } catch (error) {
                console.error('Erro ao carregar debentures:', error);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--error);">Erro ao carregar dados.</td></tr>';
            } finally {
                if (loading) loading.style.display = 'none';
            }
        }

        // ========== TITULOS PUBLICOS DINAMICO ==========
        let titulosPublicosDataTable = null;
        let titulosPublicosCarregados = false;

        async function carregarTitulosPublicos() {
            if (titulosPublicosCarregados) return;

            const loading = document.getElementById('loadingTitulosPublicos');
            const tbody = document.getElementById('corpoTitulosPublicos');

            try {
                // Usar endpoint ANBIMA com os dados carregados
                const response = await fetch(`${API_URL}/anbima/titulos-publicos`);
                const data = await response.json();

                if (data.success) {
                    titulosPublicosCarregados = true;

                    // Usar estatisticas da API se disponiveis
                    document.getElementById('titTotal').textContent = data.total.toLocaleString('pt-BR');
                    document.getElementById('titLTN').textContent = (data.stats?.LTN || 0).toLocaleString('pt-BR');
                    document.getElementById('titNTNF').textContent = (data.stats?.['NTN-F'] || 0).toLocaleString('pt-BR');
                    document.getElementById('titNTNB').textContent = (data.stats?.['NTN-B'] || 0).toLocaleString('pt-BR');
                    document.getElementById('titLFT').textContent = (data.stats?.LFT || 0).toLocaleString('pt-BR');

                    // Preencher tabela com campos ANBIMA
                    tbody.innerHTML = data.data.map(t => {
                        const vencimento = t.data_vencimento ? new Date(t.data_vencimento).toLocaleDateString('pt-BR') : '-';
                        const taxa = t.taxa_indicativa != null ? parseFloat(t.taxa_indicativa).toFixed(2) + '%' : '-';
                        const pu = t.pu_indicativo != null ? 'R$ ' + parseFloat(t.pu_indicativo).toLocaleString('pt-BR', {minimumFractionDigits: 2}) : '-';
                        return `<tr>
                            <td>${t.tipo_titulo || '-'}</td>
                            <td>${vencimento}</td>
                            <td>${taxa}</td>
                            <td>${pu}</td>
                        </tr>`;
                    }).join('');

                    // Destruir DataTable anterior se existir
                    if (titulosPublicosDataTable) {
                        titulosPublicosDataTable.destroy();
                        titulosPublicosDataTable = null;
                    }

                    // Inicializar DataTable
                    titulosPublicosDataTable = new simpleDatatables.DataTable('#tabelaTitulosPublicos', {
                        searchable: true,
                        sortable: true,
                        perPage: 25,
                        perPageSelect: [10, 25, 50, 100],
                        labels: {
                            placeholder: "Buscar titulo...",
                            perPage: "por pagina",
                            noRows: "Nenhum titulo encontrado",
                            info: "Mostrando {start} a {end} de {rows} titulos"
                        }
                    });

                    // Adicionar filtros dropdown por coluna
                    setTimeout(() => adicionarFiltrosColunas('tabelaTitulosPublicos', titulosPublicosDataTable), 100);
                }
            } catch (error) {
                console.error('Erro ao carregar titulos publicos:', error);
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:40px;color:var(--error);">Erro ao carregar dados.</td></tr>';
            } finally {
                if (loading) loading.style.display = 'none';
            }
        }

        // ========== ANBIMA DADOS PERIODICOS ==========
        let anbimaPeriodicosPage = 1;
        let anbimaPeriodicosDataTable = null;
        let anbimaPeriodicosCarregado = false;

        async function carregarAnbimaPeriodicos() {
            const search = document.getElementById('searchPeriodicos')?.value || '';
            const foco = document.getElementById('filtroPeriodFoco')?.value || '';
            const categoria = document.getElementById('filtroPeriodCategoria')?.value || '';
            const ordem = document.getElementById('filtroPeriodOrdem')?.value || 'pl';

            const loading = document.getElementById('loadingPeriodicos');
            const tbody = document.getElementById('corpoPeriodicos');

            if (loading) loading.style.display = 'block';

            const params = new URLSearchParams({
                page: anbimaPeriodicosPage,
                per_page: 50,
                ordem: ordem
            });
            if (search) params.append('search', search);
            if (foco) params.append('foco', foco);
            if (categoria) params.append('categoria', categoria);

            try {
                const response = await fetch(`${API_URL}/anbima/fundos/periodicos?${params}`);
                const data = await response.json();

                if (data.success) {
                    const stats = data.stats;

                    // Atualizar estatisticas
                    document.getElementById('statPeriodFundos').textContent = stats.total_fundos?.toLocaleString('pt-BR') || '0';
                    document.getElementById('statPeriodComPL').textContent = stats.fundos_com_pl?.toLocaleString('pt-BR') || '0';
                    document.getElementById('statPeriodPLTotal').textContent = stats.pl_total ? 'R$ ' + (stats.pl_total / 1e12).toFixed(2) + ' Tri' : '-';
                    document.getElementById('statPeriodCotistas').textContent = stats.cotistas_total ? (stats.cotistas_total / 1e6).toFixed(1) + ' Mi' : '-';
                    document.getElementById('statPeriodCotaMedia').textContent = stats.cota_media ? 'R$ ' + stats.cota_media.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '-';
                    document.getElementById('anbimaPeriodicosDataRef').textContent = 'Data Ref: ' + (stats.data_referencia || '-');

                    // Top 10 por PL
                    if (stats.top_pl && !anbimaPeriodicosCarregado) {
                        document.getElementById('corpoTopPL').innerHTML = stats.top_pl.map((f, i) => `
                            <tr>
                                <td style="font-weight:bold;color:var(--accent);">${i + 1}</td>
                                <td title="${f.nome}">${f.nome.substring(0, 50)}${f.nome.length > 50 ? '...' : ''}</td>
                                <td style="text-align:right;color:var(--success);">R$ ${(f.pl / 1e9).toFixed(2)} Bi</td>
                                <td style="text-align:right;">${f.cotistas?.toLocaleString('pt-BR') || '-'}</td>
                                <td style="text-align:right;">R$ ${f.cota?.toLocaleString('pt-BR', {minimumFractionDigits: 2}) || '-'}</td>
                            </tr>
                        `).join('');
                    }

                    // Por Foco
                    if (stats.por_foco && !anbimaPeriodicosCarregado) {
                        document.getElementById('corpoPorFoco').innerHTML = stats.por_foco.map(f => `
                            <tr>
                                <td>${f.foco || '-'}</td>
                                <td style="text-align:right;">${f.qtd?.toLocaleString('pt-BR') || '0'}</td>
                                <td style="text-align:right;color:var(--success);">R$ ${(f.pl / 1e9).toFixed(2)} Bi</td>
                            </tr>
                        `).join('');
                    }

                    // Por Categoria
                    if (stats.por_categoria && !anbimaPeriodicosCarregado) {
                        document.getElementById('corpoPorCategoria').innerHTML = stats.por_categoria.map(c => `
                            <tr>
                                <td>${c.categoria || '-'}</td>
                                <td style="text-align:right;">${c.qtd?.toLocaleString('pt-BR') || '0'}</td>
                                <td style="text-align:right;color:var(--success);">R$ ${(c.pl / 1e9).toFixed(2)} Bi</td>
                            </tr>
                        `).join('');
                    }

                    // Preencher selects de filtro na primeira vez
                    if (!anbimaPeriodicosCarregado) {
                        const selectFoco = document.getElementById('filtroPeriodFoco');
                        const selectCategoria = document.getElementById('filtroPeriodCategoria');

                        if (stats.lista_focos) {
                            stats.lista_focos.forEach(f => {
                                const opt = document.createElement('option');
                                opt.value = f;
                                opt.textContent = f;
                                selectFoco.appendChild(opt);
                            });
                        }
                        if (stats.lista_categorias) {
                            stats.lista_categorias.forEach(c => {
                                const opt = document.createElement('option');
                                opt.value = c;
                                opt.textContent = c;
                                selectCategoria.appendChild(opt);
                            });
                        }
                        anbimaPeriodicosCarregado = true;
                    }

                    // Tabela principal
                    tbody.innerHTML = data.data.map(f => `
                        <tr>
                            <td title="${f.nome || ''}">${(f.nome || '').substring(0, 45)}${(f.nome || '').length > 45 ? '...' : ''}</td>
                            <td style="font-family:monospace;font-size:0.75rem;">${formatarCNPJ(f.cnpj_classe || '')}</td>
                            <td style="text-align:right;color:var(--success);">${f.pl_atual ? 'R$ ' + (f.pl_atual / 1e6).toFixed(2) + ' Mi' : '-'}</td>
                            <td style="text-align:right;">${f.qtd_cotistas?.toLocaleString('pt-BR') || '-'}</td>
                            <td style="text-align:right;">R$ ${f.valor_cota?.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) || '-'}</td>
                            <td>${f.foco_atuacao || '-'}</td>
                            <td>${f.nivel1_categoria || '-'}</td>
                        </tr>
                    `).join('');

                    // Destruir DataTable anterior se existir
                    if (anbimaPeriodicosDataTable) {
                        anbimaPeriodicosDataTable.destroy();
                        anbimaPeriodicosDataTable = null;
                    }

                    // Inicializar DataTable
                    anbimaPeriodicosDataTable = new simpleDatatables.DataTable('#tabelaPeriodicos', {
                        searchable: true,
                        sortable: true,
                        perPage: 25,
                        perPageSelect: [10, 25, 50, 100],
                        labels: {
                            placeholder: "Buscar...",
                            perPage: "por pagina",
                            noRows: "Nenhum fundo encontrado",
                            info: "Mostrando {start} a {end} de {rows} fundos"
                        }
                    });

                    // Adicionar filtros dropdown por coluna
                    setTimeout(() => adicionarFiltrosColunas('tabelaPeriodicos', anbimaPeriodicosDataTable), 100);

                    // Paginacao
                    renderizarPaginacaoPeriodicos(data.total, data.page, data.per_page);
                }
            } catch (error) {
                console.error('Erro ao carregar dados periodicos:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--error);">Erro ao carregar dados.</td></tr>';
            } finally {
                if (loading) loading.style.display = 'none';
            }
        }

        function renderizarPaginacaoPeriodicos(total, page, perPage) {
            const totalPages = Math.ceil(total / perPage);
            const container = document.getElementById('paginacaoPeriodicos');

            let html = '';
            if (page > 1) {
                html += `<button onclick="anbimaPeriodicosPage=${page-1};carregarAnbimaPeriodicos()" style="padding:8px 15px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary);cursor:pointer;">‚Üê Anterior</button>`;
            }
            html += `<span style="padding:8px 15px;color:var(--text-secondary);">Pagina ${page} de ${totalPages} (${total.toLocaleString('pt-BR')} registros)</span>`;
            if (page < totalPages) {
                html += `<button onclick="anbimaPeriodicosPage=${page+1};carregarAnbimaPeriodicos()" style="padding:8px 15px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary);cursor:pointer;">Proxima ‚Üí</button>`;
            }
            container.innerHTML = html;
        }

        // Carregar dados quando as abas sao mostradas
        const originalShowTabAnbima = showTab;
        showTab = function(tabId, event) {
            originalShowTabAnbima(tabId, event);
            if (tabId === 'anbima-fundos' && !anbimaFundosDataTable) {
                carregarAnbimaFundos();
            } else if (tabId === 'anbima-periodicos' && !anbimaPeriodicosCarregado) {
                carregarAnbimaPeriodicos();
            } else if (tabId === 'anbima-cricra' && !anbimaCRICRADataTable) {
                carregarAnbimaCRICRA();
            } else if (tabId === 'anbima-titulos' && !anbimaTitulosDataTable) {
                carregarAnbimaTitulos();
            } else if (tabId === 'cvm-consolidado' && !cvmConsolidadoCarregado) {
                carregarConsolidado();
            } else if (tabId === 'cvm-cadastro' && !cvmCadastroCarregado) {
                carregarCadastroCVM();
            } else if (tabId === 'cvm-informes' && !cvmInformesCarregado) {
                carregarInformesCVM();
            }
        };

        // ============================================
        // FUNCOES CVM DATA
        // ============================================
        let cvmConsolidadoCarregado = false;
        let cvmCadastroCarregado = false;
        let cvmInformesCarregado = false;
        let paginaAtualConsolidado = 1;
        let paginaAtualCadastro = 1;
        let paginaAtualInformes = 1;

        function formatarMoeda(valor) {
            if (!valor || isNaN(valor)) return '-';
            if (valor >= 1e12) return `R$ ${(valor/1e12).toFixed(2)} Tri`;
            if (valor >= 1e9) return `R$ ${(valor/1e9).toFixed(2)} Bi`;
            if (valor >= 1e6) return `R$ ${(valor/1e6).toFixed(2)} Mi`;
            return `R$ ${valor.toLocaleString('pt-BR')}`;
        }

        function formatarNumero(valor) {
            if (!valor || isNaN(valor)) return '-';
            return valor.toLocaleString('pt-BR');
        }

        async function carregarConsolidado(page = 1) {
            paginaAtualConsolidado = page;
            try {
                const search = document.getElementById('searchConsolidado')?.value || '';
                const fonte = document.getElementById('filtroFonteConsolidado')?.value || '';
                const classeCVM = document.getElementById('filtroClasseCVMConsolidado')?.value || '';
                const esgOnly = document.getElementById('filtroESGConsolidado')?.checked || false;
                const comCVM = document.getElementById('filtroCruzadoConsolidado')?.checked || false;

                let url = `${API_URL}/fundos/consolidados?page=${page}&per_page=50`;
                if (search) url += `&search=${encodeURIComponent(search)}`;
                if (fonte) url += `&fonte=${encodeURIComponent(fonte)}`;
                if (classeCVM) url += `&classe_cvm=${encodeURIComponent(classeCVM)}`;
                if (esgOnly) url += `&esg_only=true`;
                if (comCVM) url += `&com_cvm=true`;

                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    // Atualizar estatisticas
                    document.getElementById('statConsolidadoTotal').textContent = formatarNumero(result.stats.total);
                    document.getElementById('statConsolidadoAnbima').textContent = formatarNumero(result.stats.anbima);
                    document.getElementById('statConsolidadoCVM').textContent = formatarNumero(result.stats.cvm);
                    document.getElementById('statConsolidadoCruzado').textContent = formatarNumero(result.stats.com_dados_cvm);
                    document.getElementById('statConsolidadoESG').textContent = formatarNumero(result.stats.esg);
                    document.getElementById('cvmConsolidadoBadge').textContent = `${formatarNumero(result.stats.total)} fundos consolidados`;

                    // Preencher filtro de classes CVM se vazio
                    const selectClasse = document.getElementById('filtroClasseCVMConsolidado');
                    if (selectClasse.options.length <= 1 && result.filtros?.classes_cvm) {
                        result.filtros.classes_cvm.forEach(c => {
                            selectClasse.add(new Option(c, c));
                        });
                    }

                    // Renderizar tabela
                    const tbody = document.getElementById('corpoTabelaConsolidado');
                    if (result.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-secondary);">Nenhum fundo encontrado</td></tr>';
                    } else {
                        let html = '';
                        result.data.forEach(f => {
                            const fonteColor = f.fonte_principal === 'ANBIMA' ? '#42A5F5' : '#CE93D8';
                            const esgBadge = f.fundo_esg ? '<span style="background:#4CAF50;color:white;padding:2px 8px;border-radius:10px;font-size:0.7rem;">ESG</span>' : '-';

                            html += `<tr>
                                <td><span style="background:${fonteColor};color:white;padding:2px 10px;border-radius:12px;font-size:0.75rem;">${f.fonte_principal}</span></td>
                                <td style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${f.nome || ''}">${f.nome || '-'}</td>
                                <td style="font-family:monospace;font-size:0.8rem;">${f.cnpj || '-'}</td>
                                <td style="font-size:0.8rem;">${f.categoria_anbima || '-'}</td>
                                <td style="font-size:0.8rem;">${f.classe_cvm || '-'}</td>
                                <td style="font-weight:600;color:#66BB6A;">${formatarMoeda(f.patrimonio_liquido)}</td>
                                <td>${formatarNumero(f.numero_cotistas)}</td>
                                <td>${esgBadge}</td>
                            </tr>`;
                        });
                        tbody.innerHTML = html;
                    }

                    // Paginacao
                    renderizarPaginacao('paginacaoConsolidado', result.page, result.pages, carregarConsolidado);
                    cvmConsolidadoCarregado = true;
                }
            } catch (e) {
                console.error('Erro ao carregar consolidado:', e);
                document.getElementById('corpoTabelaConsolidado').innerHTML =
                    '<tr><td colspan="8" style="text-align:center;padding:40px;color:#EF5350;">Erro ao carregar. Verifique a API.</td></tr>';
            }
        }

        async function carregarCadastroCVM(page = 1) {
            paginaAtualCadastro = page;
            try {
                const search = document.getElementById('searchCadastro')?.value || '';
                const situacao = document.getElementById('filtroSituacaoCadastro')?.value || '';
                const classe = document.getElementById('filtroClasseCadastro')?.value || '';

                let url = `${API_URL}/cvm/cadastro?page=${page}&per_page=50`;
                if (search) url += `&search=${encodeURIComponent(search)}`;
                if (situacao) url += `&situacao=${encodeURIComponent(situacao)}`;
                if (classe) url += `&classe=${encodeURIComponent(classe)}`;

                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    document.getElementById('statCadastroTotal').textContent = formatarNumero(result.total);
                    document.getElementById('cvmCadastroBadge').textContent = `${formatarNumero(result.total)} fundos`;

                    // Buscar stats adicionais
                    const statsResp = await fetch(`${API_URL}/cvm/stats`);
                    const statsResult = await statsResp.json();
                    if (statsResult.success) {
                        document.getElementById('statCadastroAtivos').textContent = formatarNumero(statsResult.data.fundos_ativos);
                        document.getElementById('statCadastroClasses').textContent = formatarNumero(statsResult.data.classes_distintas);
                    }

                    // Preencher filtros
                    const selectSituacao = document.getElementById('filtroSituacaoCadastro');
                    if (selectSituacao.options.length <= 1 && result.filtros?.situacoes) {
                        result.filtros.situacoes.forEach(s => {
                            selectSituacao.add(new Option(s, s));
                        });
                    }

                    const selectClasse = document.getElementById('filtroClasseCadastro');
                    if (selectClasse.options.length <= 1 && result.filtros?.classes) {
                        result.filtros.classes.forEach(c => {
                            selectClasse.add(new Option(c, c));
                        });
                    }

                    // Renderizar tabela
                    const tbody = document.getElementById('corpoTabelaCadastroCVM');
                    if (result.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-secondary);">Nenhum fundo encontrado</td></tr>';
                    } else {
                        let html = '';
                        result.data.forEach(f => {
                            const sitColor = f.situacao === 'EM FUNCIONAMENTO NORMAL' ? '#4CAF50' :
                                           f.situacao === 'CANCELADA' ? '#EF5350' : '#FF9800';
                            const dataReg = f.data_registro ? new Date(f.data_registro).toLocaleDateString('pt-BR') : '-';

                            html += `<tr>
                                <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${f.nome || ''}">${f.nome || '-'}</td>
                                <td style="font-family:monospace;font-size:0.8rem;">${f.cnpj || '-'}</td>
                                <td><span style="background:${sitColor};color:white;padding:2px 8px;border-radius:10px;font-size:0.7rem;">${f.situacao || '-'}</span></td>
                                <td style="font-size:0.85rem;">${f.classe || '-'}</td>
                                <td>${dataReg}</td>
                                <td style="font-size:0.8rem;max-width:150px;overflow:hidden;text-overflow:ellipsis;" title="${f.administrador || ''}">${f.administrador || '-'}</td>
                                <td style="font-size:0.8rem;max-width:150px;overflow:hidden;text-overflow:ellipsis;" title="${f.gestor || ''}">${f.gestor || '-'}</td>
                            </tr>`;
                        });
                        tbody.innerHTML = html;
                    }

                    renderizarPaginacao('paginacaoCadastro', result.page, result.pages, carregarCadastroCVM);
                    cvmCadastroCarregado = true;
                }
            } catch (e) {
                console.error('Erro ao carregar cadastro CVM:', e);
                document.getElementById('corpoTabelaCadastroCVM').innerHTML =
                    '<tr><td colspan="7" style="text-align:center;padding:40px;color:#EF5350;">Erro ao carregar. Verifique a API.</td></tr>';
            }
        }

        async function carregarInformesCVM(page = 1) {
            paginaAtualInformes = page;
            try {
                const search = document.getElementById('searchInformes')?.value || '';
                const periodo = document.getElementById('filtroPeriodoInformes')?.value || '';

                let url = `${API_URL}/cvm/informes?page=${page}&per_page=50`;
                if (search) url += `&search=${encodeURIComponent(search)}`;
                if (periodo) url += `&ano_mes=${encodeURIComponent(periodo)}`;

                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    // Estatisticas
                    document.getElementById('statInformesTotal').textContent = formatarNumero(result.stats.total_registros);
                    document.getElementById('statInformesFundos').textContent = formatarNumero(result.stats.fundos_unicos);
                    document.getElementById('statInformesPL').textContent = formatarMoeda(result.stats.pl_total);
                    document.getElementById('statInformesCotistas').textContent = formatarNumero(result.stats.cotistas_total);
                    document.getElementById('cvmInformesBadge').textContent = `${formatarNumero(result.stats.fundos_unicos)} fundos`;

                    // Preencher filtro de periodos
                    const selectPeriodo = document.getElementById('filtroPeriodoInformes');
                    if (selectPeriodo.options.length <= 1 && result.periodos) {
                        result.periodos.forEach(p => {
                            selectPeriodo.add(new Option(p, p));
                        });
                    }

                    // Renderizar tabela
                    const tbody = document.getElementById('corpoTabelaInformesCVM');
                    if (result.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-secondary);">Nenhum informe encontrado</td></tr>';
                    } else {
                        let html = '';
                        result.data.forEach(f => {
                            const dataComp = f.data_competencia ? new Date(f.data_competencia).toLocaleDateString('pt-BR') : '-';
                            const captColor = f.captacao_dia > 0 ? '#4CAF50' : '#a0a0b0';
                            const resgColor = f.resgate_dia > 0 ? '#EF5350' : '#a0a0b0';

                            html += `<tr>
                                <td style="font-family:monospace;font-size:0.8rem;">${f.cnpj || '-'}</td>
                                <td>${dataComp}</td>
                                <td style="font-weight:600;color:#66BB6A;">${formatarMoeda(f.patrimonio_liquido)}</td>
                                <td style="font-weight:500;">${f.valor_cota ? `R$ ${parseFloat(f.valor_cota).toFixed(6)}` : '-'}</td>
                                <td>${formatarNumero(f.numero_cotistas)}</td>
                                <td style="color:${captColor};">${formatarMoeda(f.captacao_dia)}</td>
                                <td style="color:${resgColor};">${formatarMoeda(f.resgate_dia)}</td>
                            </tr>`;
                        });
                        tbody.innerHTML = html;
                    }

                    renderizarPaginacao('paginacaoInformes', result.page, result.pages, carregarInformesCVM);
                    cvmInformesCarregado = true;
                }
            } catch (e) {
                console.error('Erro ao carregar informes CVM:', e);
                document.getElementById('corpoTabelaInformesCVM').innerHTML =
                    '<tr><td colspan="7" style="text-align:center;padding:40px;color:#EF5350;">Erro ao carregar. Verifique a API.</td></tr>';
            }
        }

        function renderizarPaginacao(containerId, paginaAtual, totalPaginas, funcaoCarregar) {
            const container = document.getElementById(containerId);
            if (!container) return;

            let html = '';
            const maxBotoes = 7;
            let inicio = Math.max(1, paginaAtual - 3);
            let fim = Math.min(totalPaginas, inicio + maxBotoes - 1);

            if (fim - inicio < maxBotoes - 1) {
                inicio = Math.max(1, fim - maxBotoes + 1);
            }

            // Botao anterior
            if (paginaAtual > 1) {
                html += `<button onclick="${funcaoCarregar.name}(${paginaAtual - 1})" style="padding:8px 12px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary);cursor:pointer;">‚Äπ</button>`;
            }

            // Primeira pagina
            if (inicio > 1) {
                html += `<button onclick="${funcaoCarregar.name}(1)" style="padding:8px 12px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary);cursor:pointer;">1</button>`;
                if (inicio > 2) html += `<span style="color:var(--text-secondary);padding:0 5px;">...</span>`;
            }

            // Paginas do meio
            for (let i = inicio; i <= fim; i++) {
                const isActive = i === paginaAtual;
                html += `<button onclick="${funcaoCarregar.name}(${i})" style="padding:8px 12px;background:${isActive ? 'var(--primary)' : 'var(--bg-card)'};border:1px solid ${isActive ? 'var(--primary)' : 'var(--border-color)'};border-radius:6px;color:${isActive ? 'white' : 'var(--text-primary)'};cursor:pointer;font-weight:${isActive ? '700' : '400'};">${i}</button>`;
            }

            // Ultima pagina
            if (fim < totalPaginas) {
                if (fim < totalPaginas - 1) html += `<span style="color:var(--text-secondary);padding:0 5px;">...</span>`;
                html += `<button onclick="${funcaoCarregar.name}(${totalPaginas})" style="padding:8px 12px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary);cursor:pointer;">${totalPaginas}</button>`;
            }

            // Botao proximo
            if (paginaAtual < totalPaginas) {
                html += `<button onclick="${funcaoCarregar.name}(${paginaAtual + 1})" style="padding:8px 12px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary);cursor:pointer;">‚Ä∫</button>`;
            }

            container.innerHTML = html;
        }

        // Enter para buscar nos inputs ANBIMA
        document.addEventListener('DOMContentLoaded', function() {
            const searchAnbimaFundos = document.getElementById('searchAnbimaFundos');
            if (searchAnbimaFundos) {
                searchAnbimaFundos.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') carregarAnbimaFundos();
                });
            }
            const searchAnbimaCRICRA = document.getElementById('searchAnbimaCRICRA');
            if (searchAnbimaCRICRA) {
                searchAnbimaCRICRA.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') carregarAnbimaCRICRA();
                });
            }

            // Enter para Explorar Fundos
            const searchExplorar = document.getElementById('searchExplorar');
            if (searchExplorar) {
                searchExplorar.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') { paginaAtualAPI = 1; buscarFundosAPI(); }
                });
            }

            // Enter para inputs CVM
            const searchConsolidado = document.getElementById('searchConsolidado');
            if (searchConsolidado) {
                searchConsolidado.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') carregarConsolidado();
                });
            }
            const searchCadastro = document.getElementById('searchCadastro');
            if (searchCadastro) {
                searchCadastro.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') carregarCadastroCVM();
                });
            }
            const searchInformes = document.getElementById('searchInformes');
            if (searchInformes) {
                searchInformes.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') carregarInformesCVM();
                });
            }
        });

        // ============================================
        // MODAL DE DETALHES DO FUNDO
        // ============================================
        async function verDetalhesFundo(cnpj) {
            const modal = document.getElementById('modalDetalhesFundo');
            const conteudo = document.getElementById('conteudoDetalhesFundo');

            modal.style.display = 'flex';
            conteudo.innerHTML = '<div style="text-align:center;padding:40px;"><div style="display:inline-block;width:40px;height:40px;border:3px solid var(--border-color);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;"></div><p style="color:var(--text-secondary);margin-top:15px;">Carregando detalhes...</p></div>';

            try {
                const response = await fetch(`${API_URL}/fundos/${encodeURIComponent(cnpj)}/detalhes`);
                const result = await response.json();

                if (result.success) {
                    renderizarDetalhesFundo(result.data);
                } else {
                    conteudo.innerHTML = `<div style="text-align:center;padding:40px;color:#EF5350;">Erro: ${result.error}</div>`;
                }
            } catch (e) {
                conteudo.innerHTML = `<div style="text-align:center;padding:40px;color:#EF5350;">Erro ao carregar: ${e.message}</div>`;
            }
        }

        function renderizarDetalhesFundo(fundo) {
            const conteudo = document.getElementById('conteudoDetalhesFundo');

            const formatarMoedaModal = (v) => {
                if (!v) return '-';
                if (v >= 1e12) return `R$ ${(v/1e12).toFixed(2)} Tri`;
                if (v >= 1e9) return `R$ ${(v/1e9).toFixed(2)} Bi`;
                if (v >= 1e6) return `R$ ${(v/1e6).toFixed(2)} Mi`;
                return `R$ ${v.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            };

            const fonteColor = fundo.fonte_principal === 'ANBIMA' ? '#42A5F5' : '#CE93D8';
            const esgBadge = fundo.fundo_esg ? '<span style="background:#4CAF50;color:white;padding:4px 12px;border-radius:15px;font-size:0.8rem;margin-left:10px;">ESG</span>' : '';

            let html = `
                <div style="margin-bottom:25px;">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                        <span style="background:${fonteColor};color:white;padding:4px 12px;border-radius:15px;font-size:0.8rem;">${fundo.fonte_principal}</span>
                        ${esgBadge}
                    </div>
                    <h2 style="color:var(--text-primary);margin:0;font-size:1.4rem;">${fundo.nome || '-'}</h2>
                    <p style="color:var(--text-secondary);font-family:monospace;margin-top:5px;">CNPJ: ${fundo.cnpj || '-'}</p>
                </div>

                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:25px;">
                    <div style="background:rgba(76,175,80,0.1);padding:15px;border-radius:10px;border:1px solid rgba(76,175,80,0.3);">
                        <div style="color:var(--text-secondary);font-size:0.75rem;margin-bottom:5px;">PATRIMONIO LIQUIDO</div>
                        <div style="font-size:1.5rem;font-weight:700;color:#66BB6A;">${formatarMoedaModal(fundo.patrimonio_liquido)}</div>
                    </div>
                    <div style="background:rgba(33,150,243,0.1);padding:15px;border-radius:10px;border:1px solid rgba(33,150,243,0.3);">
                        <div style="color:var(--text-secondary);font-size:0.75rem;margin-bottom:5px;">COTISTAS</div>
                        <div style="font-size:1.5rem;font-weight:700;color:#42A5F5;">${fundo.numero_cotistas?.toLocaleString() || '-'}</div>
                    </div>
                    <div style="background:rgba(255,152,0,0.1);padding:15px;border-radius:10px;border:1px solid rgba(255,152,0,0.3);">
                        <div style="color:var(--text-secondary);font-size:0.75rem;margin-bottom:5px;">VALOR DA COTA</div>
                        <div style="font-size:1.5rem;font-weight:700;color:#FFB74D;">${fundo.valor_cota ? 'R$ ' + fundo.valor_cota.toFixed(6) : '-'}</div>
                    </div>
                </div>

                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-bottom:25px;">
                    <div>
                        <h3 style="color:var(--primary-light);font-size:1rem;margin-bottom:15px;border-bottom:1px solid var(--border-color);padding-bottom:8px;">Informacoes Gerais</h3>
                        <table style="width:100%;font-size:0.85rem;">
                            <tr><td style="color:var(--text-secondary);padding:5px 0;">Categoria</td><td style="font-weight:500;">${fundo.categoria_anbima || fundo.classe_cvm || '-'}</td></tr>
                            <tr><td style="color:var(--text-secondary);padding:5px 0;">Tipo</td><td>${fundo.tipo_anbima || '-'}</td></tr>
                            <tr><td style="color:var(--text-secondary);padding:5px 0;">Foco</td><td>${fundo.foco_atuacao || '-'}</td></tr>
                            <tr><td style="color:var(--text-secondary);padding:5px 0;">Situacao CVM</td><td>${fundo.situacao_cvm || '-'}</td></tr>
                        </table>
                    </div>
                    <div>
                        <h3 style="color:var(--primary-light);font-size:1rem;margin-bottom:15px;border-bottom:1px solid var(--border-color);padding-bottom:8px;">Gestao</h3>
                        <table style="width:100%;font-size:0.85rem;">
                            <tr><td style="color:var(--text-secondary);padding:5px 0;">Gestor</td><td style="font-weight:500;max-width:200px;overflow:hidden;text-overflow:ellipsis;" title="${fundo.gestor || ''}">${fundo.gestor || '-'}</td></tr>
                            <tr><td style="color:var(--text-secondary);padding:5px 0;">Administrador</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;" title="${fundo.administrador || ''}">${fundo.administrador || '-'}</td></tr>
                            <tr><td style="color:var(--text-secondary);padding:5px 0;">Captacao Dia</td><td style="color:#66BB6A;">${formatarMoedaModal(fundo.captacao_dia)}</td></tr>
                            <tr><td style="color:var(--text-secondary);padding:5px 0;">Resgate Dia</td><td style="color:#EF5350;">${formatarMoedaModal(fundo.resgate_dia)}</td></tr>
                        </table>
                    </div>
                </div>
            `;

            // Detalhes ANBIMA
            if (fundo.detalhes_anbima) {
                const da = fundo.detalhes_anbima;
                html += `
                    <div style="margin-bottom:25px;">
                        <h3 style="color:#42A5F5;font-size:1rem;margin-bottom:15px;border-bottom:1px solid var(--border-color);padding-bottom:8px;">Dados ANBIMA</h3>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;font-size:0.85rem;">
                            <div><span style="color:var(--text-secondary);">Codigo ANBIMA:</span> <strong>${da.codigo_anbima || '-'}</strong></div>
                            <div><span style="color:var(--text-secondary);">Estrutura:</span> ${da.estrutura || '-'}</div>
                            <div><span style="color:var(--text-secondary);">Data Inicio:</span> ${da.data_inicio ? new Date(da.data_inicio).toLocaleDateString('pt-BR') : '-'}</div>
                            <div><span style="color:var(--text-secondary);">Tipo Investidor:</span> ${da.tipo_investidor || '-'}</div>
                            <div><span style="color:var(--text-secondary);">Aplicacao Minima:</span> ${formatarMoedaModal(da.aplicacao_minima)}</div>
                            <div><span style="color:var(--text-secondary);">Prazo Resgate:</span> ${da.prazo_resgate_dias ? da.prazo_resgate_dias + ' dias' : '-'}</div>
                            <div><span style="color:var(--text-secondary);">Tributacao:</span> ${da.tributacao_alvo || '-'}</div>
                            <div><span style="color:var(--text-secondary);">Composicao:</span> ${da.composicao || '-'}</div>
                        </div>
                    </div>
                `;
            }

            // Detalhes CVM
            if (fundo.detalhes_cvm) {
                const dc = fundo.detalhes_cvm;
                html += `
                    <div style="margin-bottom:25px;">
                        <h3 style="color:#CE93D8;font-size:1rem;margin-bottom:15px;border-bottom:1px solid var(--border-color);padding-bottom:8px;">Dados CVM</h3>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;font-size:0.85rem;">
                            <div><span style="color:var(--text-secondary);">Data Constituicao:</span> ${dc.data_constituicao ? new Date(dc.data_constituicao).toLocaleDateString('pt-BR') : '-'}</div>
                            <div><span style="color:var(--text-secondary);">Condominio:</span> ${dc.condominio || '-'}</div>
                            <div><span style="color:var(--text-secondary);">Fundo de Cotas:</span> ${dc.fundo_cotas ? 'Sim' : 'Nao'}</div>
                            <div><span style="color:var(--text-secondary);">Exclusivo:</span> ${dc.fundo_exclusivo ? 'Sim' : 'Nao'}</div>
                            <div><span style="color:var(--text-secondary);">Taxa Admin:</span> ${dc.taxa_administracao ? dc.taxa_administracao.toFixed(2) + '%' : '-'}</div>
                            <div><span style="color:var(--text-secondary);">Taxa Performance:</span> ${dc.taxa_performance ? dc.taxa_performance.toFixed(2) + '%' : '-'}</div>
                            <div><span style="color:var(--text-secondary);">Auditor:</span> ${dc.auditor || '-'}</div>
                            <div><span style="color:var(--text-secondary);">Diretor:</span> ${dc.diretor || '-'}</div>
                        </div>
                    </div>
                `;
            }

            // Informes Recentes
            if (fundo.informes_recentes && fundo.informes_recentes.length > 0) {
                html += `
                    <div style="margin-bottom:25px;">
                        <h3 style="color:#FF9800;font-size:1rem;margin-bottom:15px;border-bottom:1px solid var(--border-color);padding-bottom:8px;">Informes Diarios Recentes</h3>
                        <table style="width:100%;font-size:0.8rem;">
                            <thead>
                                <tr style="background:rgba(255,255,255,0.05);">
                                    <th style="padding:8px;text-align:left;">Data</th>
                                    <th style="padding:8px;text-align:right;">PL</th>
                                    <th style="padding:8px;text-align:right;">Cota</th>
                                    <th style="padding:8px;text-align:right;">Cotistas</th>
                                    <th style="padding:8px;text-align:right;">Captacao</th>
                                    <th style="padding:8px;text-align:right;">Resgate</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                fundo.informes_recentes.forEach(inf => {
                    html += `
                        <tr>
                            <td style="padding:6px 8px;">${inf.data ? new Date(inf.data).toLocaleDateString('pt-BR') : '-'}</td>
                            <td style="padding:6px 8px;text-align:right;color:#66BB6A;">${formatarMoedaModal(inf.patrimonio_liquido)}</td>
                            <td style="padding:6px 8px;text-align:right;">${inf.valor_cota ? inf.valor_cota.toFixed(4) : '-'}</td>
                            <td style="padding:6px 8px;text-align:right;">${inf.cotistas?.toLocaleString() || '-'}</td>
                            <td style="padding:6px 8px;text-align:right;color:#66BB6A;">${formatarMoedaModal(inf.captacao)}</td>
                            <td style="padding:6px 8px;text-align:right;color:#EF5350;">${formatarMoedaModal(inf.resgate)}</td>
                        </tr>
                    `;
                });
                html += '</tbody></table></div>';
            }

            // Titulos Relacionados
            if (fundo.titulos_relacionados && fundo.titulos_relacionados.length > 0) {
                html += `
                    <div style="margin-bottom:25px;">
                        <h3 style="color:#26A69A;font-size:1rem;margin-bottom:15px;border-bottom:1px solid var(--border-color);padding-bottom:8px;">Titulos Relacionados (CRI/CRA)</h3>
                        <table style="width:100%;font-size:0.8rem;">
                            <thead>
                                <tr style="background:rgba(255,255,255,0.05);">
                                    <th style="padding:8px;text-align:left;">Tipo</th>
                                    <th style="padding:8px;text-align:left;">Codigo</th>
                                    <th style="padding:8px;text-align:left;">Emissor</th>
                                    <th style="padding:8px;text-align:right;">Taxa Ind.</th>
                                    <th style="padding:8px;text-align:right;">PU Ind.</th>
                                    <th style="padding:8px;text-align:right;">Duration</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                fundo.titulos_relacionados.forEach(tit => {
                    html += `
                        <tr>
                            <td style="padding:6px 8px;"><span style="background:${tit.tipo === 'CRI' ? '#4CAF50' : '#2196F3'};color:white;padding:2px 8px;border-radius:8px;font-size:0.7rem;">${tit.tipo}</span></td>
                            <td style="padding:6px 8px;font-family:monospace;">${tit.codigo || '-'}</td>
                            <td style="padding:6px 8px;max-width:150px;overflow:hidden;text-overflow:ellipsis;">${tit.emissor || '-'}</td>
                            <td style="padding:6px 8px;text-align:right;">${tit.taxa_indicativa ? tit.taxa_indicativa.toFixed(2) + '%' : '-'}</td>
                            <td style="padding:6px 8px;text-align:right;">${tit.pu_indicativo ? tit.pu_indicativo.toFixed(2) : '-'}</td>
                            <td style="padding:6px 8px;text-align:right;">${tit.duration || '-'}</td>
                        </tr>
                    `;
                });
                html += '</tbody></table></div>';
            }

            conteudo.innerHTML = html;
        }

        function fecharModalDetalhes() {
            document.getElementById('modalDetalhesFundo').style.display = 'none';
        }
    </script>

    <!-- Modal de Detalhes do Fundo -->
    <div id="modalDetalhesFundo" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:2000;justify-content:center;align-items:center;padding:20px;" onclick="if(event.target===this)fecharModalDetalhes()">
        <div style="background:var(--bg-card);border-radius:15px;max-width:900px;width:100%;max-height:90vh;overflow-y:auto;border:1px solid var(--border-color);position:relative;">
            <div style="position:sticky;top:0;background:var(--bg-card);padding:20px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;z-index:1;">
                <h2 style="margin:0;color:var(--text-primary);font-size:1.2rem;">Detalhes do Fundo</h2>
                <button onclick="fecharModalDetalhes()" style="background:none;border:none;color:var(--text-secondary);font-size:1.5rem;cursor:pointer;padding:5px 10px;">&times;</button>
            </div>
            <div id="conteudoDetalhesFundo" style="padding:20px;"></div>
        </div>
    </div>
</body>
</html>